<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>名刺プレビュー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
  html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: 'Helvetica Neue', sans-serif;
  background: linear-gradient(180deg, #ffe4ec, #fff1f7);
  overflow: auto;
}



    body {
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  overflow-x: hidden; /* 👈 横スクロール禁止！ */
  padding-bottom: 0px; 
}
    .main-wrapper {
      position: relative;
      min-height: 100vh;
      padding-bottom: 140px; /* ツールバーを考慮 */
      box-sizing: border-box;
    }
    .card {
      width: 90%;
      max-width: 700px;
      margin: 30px auto;
      border: 2px solid #ccc;
      border-radius: 10px;
      background-color: white;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }

   :root {
  --bar-color: #add8e6; /* 最初は水色とかでOK */
}

.header-bar {
  background-color: var(--bar-color);  /* ← background-imageは使わない */
  height: 40px;
}


    .student-id {
      display: flex;
      flex-direction: row;
      padding: 20px;
      gap: 20px;
    }

    .left-section {
      width: 40%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .left-section img {
      width: 125px;
      height: 125px;
      object-fit: cover;
      border-radius: 15px;
      cursor: pointer;
    }

    .info-section {
      width: 60%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      font-size: 14px;
      line-height: 1.6;
    }

    .editable-text {
      border: none;
      background: transparent;
      border-bottom: 1px solid #ccc;
      font-size: 14px;
      width: 100%;
    }
body {
  padding-bottom: 10px;
  box-sizing: border-box;
}

    .toolbar {
      position: fixed;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 10px 16px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: flex;
      gap: 16px;
      z-index: 1000;
      align-items: center;
      
    }

    .toolbar img {
      width: 28spx;
      height: 28px;
      cursor: pointer;
    }

    .toolbar button {
      padding: 4px 12px;
      border: none;
      background: #eee;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }

        .hidden-input {
      opacity: 0;
      position: absolute;
      pointer-events: auto;
    }


    .sns-input {
      margin-left: 36px;
      margin-top: 8px;
      display: none;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 5px 10px;
      width: 220px;
      font-size: 14px;
    }

    .sns-wrapper {
      display: flex;
      flex-direction: column;
    }

    canvas {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 800;
      display: none;
    }

  .text-sticker {
  position: absolute;
  border: none;
  outline: none;
  background: transparent;
  font-size: 16px;
  font-weight: bold;
  pointer-events: auto;
  /* color: black; ← 削除かコメントアウトしてください */
}

.sns-item {
  position: relative; /* ボタンを上に重ねるために必要 */
}

.sns-delete-btn {
  position: absolute;
  top: -8px;
  right: -8px;
  width: 18px;
  height: 18px;
  cursor: pointer;
  z-index: 10;
}
#bg-template-list::-webkit-scrollbar {
  display: none;
}
.youtube-section {
  margin-top: 10px;
  margin-bottom: 60px; /* ← 追加！ */
  text-align: center;
}
#youtube-url {
  width: 70%;
  max-width: 500px;
  padding: 5px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 14px;
  margin-top: 5px;
}
#youtube-player {
  margin: 0;
  padding: 0;
  line-height: 0;
}
iframe {
  width: 100%;
  height: 200px; /* ← aspect-ratioと併用せず明示指定で高さ固定 */
  border: none;
  margin: 0 auto;
  padding: 0;
}
body {
  box-sizing: border-box;
}
body {
  overscroll-behavior: contain; /* ← iOSスクロール跳ね返りを抑制 */
  padding-bottom: 80px;
}
#page-wrapper {
  position: relative;
  min-height: 100vh;
  overflow: visible;
}
#text-tools {
  display: none;
  position: fixed;
  bottom: 80px;
  left: 10px;
  background: #fff;
  padding: 10px 14px;
  border-radius: 12px;
  box-shadow: 0 0 8px rgba(0,0,0,0.1);
  z-index: 9999;
  font-family: 'Rounded Mplus 1c', 'Noto Sans JP', sans-serif;
  width: fit-content;       /* ← 中身に合わせる */
  max-width: 100vw;         /* ← スマホで飛び出さないよう保険 */
  box-sizing: border-box;
}

.tool-row {
  display: inline-flex;     /* ← 横に自然な幅だけ使う */
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.tool-label {
  font-weight: bold;
  font-size: 13px;
  color: #444;
  width: 50px;
}

.tool-input {
  flex: 1;
  font-size: 13px;
}

#text-color-picker {
  width: 30px;
  height: 30px;
  border: none;
  padding: 0;
  background: none;
}

 #edit-toggle.floating-eye {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    width: 40px;
    height: 40px;
  }
  .sns-icon-bar {
  background-color: #ffffffcc;
  border-radius: 12px;
  padding: 8px 12px;
  display: flex;
  justify-content: space-around;
  align-items: center;
  margin: 20px auto;
  max-width: 300px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.sns-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  padding: 4px;
  cursor: pointer;
}
@keyframes glow-temporary {
  0% { box-shadow: 0 0 0px #00bfff; }
  20% { box-shadow: 0 0 10px #00bfff; }
  40% { box-shadow: 0 0 15px #00bfff; }
  60% { box-shadow: 0 0 10px #00bfff; }
  80% { box-shadow: 0 0 5px #00bfff; }
  100% { box-shadow: none; }
}

.glow-once {
  animation: glow-temporary 5s ease-in-out 1;
   border-bottom: 1px solid #ccc;
  border-radius: 8px;
}
.template-btn {
    font-size: 13px;
    padding: 5px 12px;
    border-radius: 10px;
    background-color: #f8f8ff;
    border: 1px solid #bbb;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
  }

  .template-btn:hover {
    background-color: #ffe066;
    transform: scale(1.05);
  }

  .fade-in {
    animation: fadeIn 0.4s ease-in-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  </style>
</head>
<body>
  <div id="page-wrapper">
  <div class="main-wrapper">
  <div class="card">
    <div class="header-bar"></div>
    <div class="student-id">
      <div class="left-section">
        <img id="profile-img" src="{{ image_data or '/static/profile_icon.jpeg' }}" alt="プロフィール画像">
        <input type="file" accept="image/*" id="profile-input" class="hidden-input">
      </div>
      <div class="info-section">
        <input type="text" class="editable-text glow-once" placeholder="名前">
        <input type="text" class="editable-text" placeholder="誕生日">
        <input type="text" class="editable-text" placeholder="年齢">
        <input type="text" class="editable-text" placeholder="学部:学科">
        <input type="text" class="editable-text" placeholder="出身地">
        <input type="text" class="editable-text" placeholder="趣味">
      </div>
    </div>
  </div>
<!-- 横並びのSNSアイコンバー -->
<div class="sns-icon-bar" style="
  width: 90vw;
  max-width: 500px;
  margin: 20px auto;
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 10px 14px;
  border-radius: 14px;
  background-color: #ffffffcc;
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
  box-sizing: border-box;
">
  <img src="/static/instagram_icon.jpeg" alt="Instagram" class="sns-icon" onclick="handleIconClick('instagram')" style="width: 32px; height: 32px;">
  <img src="/static/Line.icon.jpeg" alt="LINE" class="sns-icon" onclick="handleIconClick('line')" style="width: 32px; height: 32px;">
  <img src="/static/BeReal.icon.jpeg" alt="BeReal" class="sns-icon" onclick="handleIconClick('bereal')" style="width: 32px; height: 32px;">
  <img src="/static/X_icon.jpeg" alt="X" class="sns-icon" onclick="handleIconClick('x')" style="width: 32px; height: 32px;">
  <img src="/static/tiktok_icon.jpeg" alt="TikTok" class="sns-icon" onclick="handleIconClick('tiktok')" style="width: 32px; height: 32px;">
</div>
<div id="sns-explain" style="
  font-size: 12.5px;
  color: #777;
  text-align: center;
  margin-top: 12px;
  margin-bottom: 16px;
  line-height: 1.6;
">
  アイコンを押すと公式ページへ！<br>
  URLをコピーしてプロフィールに登録しよう
</div>


<!-- 各SNSの入力欄（非表示） -->
<div class="sns-inputs">
  <input id="input-instagram" class="sns-input" placeholder="https://www.instagram.com/yourid" onblur="handleBlur('instagram')">
  <input id="input-line" class="sns-input" placeholder="https://lin.ee/yourid" onblur="handleBlur('line')">
  <input id="input-bereal" class="sns-input" placeholder="https://bere.al/yourid" onblur="handleBlur('bereal')">
  <input id="input-x" class="sns-input" placeholder="https://twitter.com/yourid" onblur="handleBlur('x')">
  <input id="input-tiktok" class="sns-input" placeholder="https://www.tiktok.com/@yourid" onblur="handleBlur('tiktok')">
</div>


<!-- ▼ 自由記入欄（バツ付き） -->
<div id="extra-text-wrapper" class="sns-wrapper" style="margin-top: 20px; position: relative;">
  <img src="/static/batu.jpeg" alt="削除" class="sns-delete-btn" onclick="hideExtraText()" style="
    position: absolute;
    top: -3px;
    right: 18px;
    width: 18px;
    height: 18px;
    cursor: pointer;
    z-index: 10;
  ">
  <textarea id="extra-text" class="editable-text" placeholder="記入欄" style="
    margin-top: 10px;
    margin-left: 20px;
    padding: 14px 18px;
    border-radius: 14px;
    border: 1px solid #ccc;
    width: 90vw;
    max-width: 650px;
    height: 160px;
    font-size: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    resize: none;
    line-height: 1.6;
    background-color: #fff;
    box-sizing: border-box;
  "></textarea>
</div>

<!-- テンプレート挿入ボタン -->
<div class="deletable-templates" style="text-align: center; margin-top: 13px;">
  <button onclick="showTemplateButtons()" style="
    font-size: 14px;
    padding: 6px 14px;
    border-radius: 8px;
    border: none;
    background: rgb(255, 224, 136); 
    color: #333;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: background-color 0.2s ease;
  ">✍️ 記入欄テンプレート</button>
</div>


<!-- テンプレート項目ボタン（横並び） -->
<div id="template-buttons" style="
  margin: 12px auto 0;
  display: none;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
  max-width: 90%;
">
  <button onclick="insertTemplate('club')" class="template-btn">部活</button>
  <button onclick="insertTemplate('study')" class="template-btn">学業</button>
  <button onclick="insertTemplate('circle')" class="template-btn">サークル</button>
  <button onclick="insertTemplate('parttime')" class="template-btn">バイト</button>
  <button onclick="insertTemplate('hobby')" class="template-btn">趣味</button>
</div>


<!-- ▼ YouTube入力欄 -->
<div class="youtube-section" style="position: relative; margin-top: 20px;">
  <img src="/static/batu.jpeg" alt="削除" class="sns-delete-btn" onclick="hideYouTubeSection()" style="
    position: absolute;
    top: 13px;
    right: 20px;
    width: 18px;
    height: 18px;
    cursor: pointer;
    z-index: 10;
  ">

  <!-- プレイヤー -->
  <div id="youtube-player" style="padding: 0; text-align: center;"></div>
<!-- ▼ YouTube見出し（リンク化＋赤） -->
<div style="font-weight: bold; font-size: 14px; margin-bottom: 6px; text-align: left; padding-left: 5vw;text-decoration: underline; /* ✅ 見た目で「リンクになる感」出す */">
  <a href="https://www.youtube.com" target="_blank" style="color: red; text-decoration: none;">
    YouTube URL
  </a><br>
  <span style="font-size: 12px; color: #555;"></span>
</div>

  <!-- 入力欄 -->
  <input type="text" id="youtube-url" placeholder="YoutubeURLを入力"
    style="
      width: 90vw;
      max-width: 650px;
      padding: 14px 18px;
      border: 1px solid #ccc;
      border-radius: 14px;
      font-size: 16px;
      display: block;
      margin: 0 auto 12px auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      box-sizing: border-box;
      
    ">

  <!-- 中央寄せボタン -->
  <button onclick="embedYouTubeVideo()" style="
    display: block;
    margin: 0 auto 10px auto;
    padding: 10px 20px;
    font-size: 15px;
    border-radius: 10px;
    background: rgb(255, 224, 136); 
    color: black;
border: none;
box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  ">
    反映
  </button>
</div>

<!-- ▼ Spotify埋め込み欄 -->
<div id="spotify-section" class="spotify-section" style="position: relative; margin-top: -40px;">
  <!-- ✕ ボタン -->
  <img src="/static/batu.jpeg" alt="削除" class="sns-delete-btn" onclick="hideSpotifySection()" style="
    position: absolute;
    top: 30px;
    right: 20px;
    width: 18px;
    height: 18px;
    cursor: pointer;
    z-index: 10;
  ">

  <!-- 埋め込みプレイヤーを先に -->
  <div id="spotify-player" style="padding: 0; text-align: center;"></div>

<!-- ▼ Spotify見出し（リンク化＋緑＋下線） -->
<div style="font-weight: bold; font-size: 14px; margin-bottom: 6px; text-align: left; padding-left: 5vw;">
  <a href="https://open.spotify.com" target="_blank" style="color: green; text-decoration: underline;">
    Spotify URL
  </a><br>
  <span style="font-size: 12px; color: #555;">（楽曲/アルバム/プレイリスト）</span>
</div>


  <!-- 入力欄 -->
  <input type="text" id="spotify-url" placeholder="SpotifyのURLを入力"
    style="
      width: 90vw;
      max-width: 650px;
      padding: 14px 18px;
      border: 1px solid #ccc;
      border-radius: 14px;
      font-size: 16px;
      display: block;
      margin: 0 auto 12px auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      box-sizing: border-box;
    ">

  <!-- 反映ボタン（中央 & 自己PRのボタンと揃える） -->
<button onclick="embedSpotify()" style="
  display: block;
  margin: 0 auto 10px auto;
  padding: 10px 20px;
  font-size: 15px;
  border-radius: 10px;
  background: rgb(255, 224, 136); /* サブ1の黄色 */
  color: black;
  border: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
">
  反映
</button>




  <canvas id="draw-canvas"></canvas>
  <input type="file" id="background-input" class="hidden-input" accept="image/*" onchange="loadBackgroundImage(event)">
  <input type="color" id="color-picker" class="hidden-input" onchange="changeBarColor(event)">
<button id="finish-button" style="
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #eee;
  border: none;
  padding: 6px 16px;
  font-size: 16px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  z-index: 1001;
  cursor: pointer;
  display: none;
">
  作成
</button>
 <div class="toolbar" id="toolbar">
    <img src="/static/upload.jpeg" onclick="toggleBackgroundList()">
    <img src="/static/pen_off.jpeg" onclick="toggleTextMode()" id="text-toggle-icon">
    <div style="position: relative; width: 28px; height: 28px;">
  <img src="/static/student.jpeg" style="width: 100%; height: 100%; cursor: pointer;">
  <input type="color" id="color-picker"
         style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                opacity: 0; cursor: pointer;"
         onchange="changeBarColor(event)">
</div>
<img src="/static/restore.jpeg" onclick="restoreSNS()" style="width: 28px; height: 28px; cursor: pointer;">
<!-- ツールバー内の確認ボタンの左あたりに追加 -->
 <img id="edit-toggle" src="/static/open_eye.jpeg" style="width: 28px; height: 28px; cursor: pointer;" alt="編集切替">
    <button onclick="togglePreview()" id="check-button">確認</button>
  </div>
  <img id="return-toggle" src="/static/closed_eye.jpeg"
     style="width: 50px; height: 50px; position: fixed; bottom: 20px; right: 20px;
            cursor: pointer; display: none; z-index: 9999;
            border-radius: 50%; background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
            animation: pulse 2s infinite;" alt="戻る">

  <script>
    const urls = { instagram: '', x: '', tiktok: '' };
    const canvas = document.getElementById('draw-canvas');
    const ctx = canvas.getContext('2d');
  function togglePreview() {
  const toolbar = document.getElementById('toolbar');
  const finalBtn = document.getElementById('finish-button');

  toolbar.style.display = 'none';
  finalBtn.style.display = 'block';
}
 let drawing = false, drawEnabled = false;
let paths = [], currentPath = [];

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  redraw();
}

window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function redraw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = '#000';
  ctx.lineWidth = 2;
  for (const path of paths) {
    ctx.beginPath();
    path.forEach(([x, y], i) => i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y));
    ctx.stroke();
  }
  if (currentPath.length) {
    ctx.beginPath();
    currentPath.forEach(([x, y], i) => i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y));
    ctx.stroke();
  }
}

canvas.addEventListener('mousedown', e => {
  if (!drawEnabled) return;
  drawing = true;
  currentPath = [[e.offsetX, e.offsetY]];
});

canvas.addEventListener('mousemove', e => {
  if (!drawing || !drawEnabled) return;
  currentPath.push([e.offsetX, e.offsetY]);
  redraw();
});

canvas.addEventListener('mouseup', () => {
  if (!drawing || !drawEnabled) return;
  drawing = false;
  paths.push(currentPath);
  currentPath = [];
});

function toggleTextMode() {
  drawEnabled = !drawEnabled;
  canvas.style.display = drawEnabled ? 'block' : 'none';
  const icon = document.getElementById('text-toggle-icon');
  icon.src = drawEnabled ? '/static/pen_on.jpeg' : '/static/pen_off.jpeg';
}

function loadBackgroundImage(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    document.body.style.backgroundImage = `url('${reader.result}')`;
  };
  reader.readAsDataURL(file);
}

function changeBarColor(e) {
  document.documentElement.style.setProperty('--bar-color', e.target.value);
}

const iconClickState = {};

function handleIconClick(service) {
  const input = document.getElementById(`input-${service}`);
  if (!input) return;

  const url = input.value.trim();
  const defaultLinks = {
    instagram: "https://www.instagram.com",
    line: "https://line.me",
    bereal: "https://bere.al",
    x: "https://twitter.com",
    tiktok: "https://www.tiktok.com"
  };

  // 初回なら公式へ、2回目以降は入力
  if (!iconClickState[service]) {
    iconClickState[service] = true;
    window.open(defaultLinks[service], '_blank');
  } else {
    input.style.display = "block";
    input.focus();
  }
}



function handleBlur(service) {
  const input = document.getElementById(`input-${service}`);
  const value = input.value.trim();
  if (value) urls[service] = value;
  input.style.display = 'none';
}

function downloadCard() {
  alert("この部分で画像化＆ZIP化などの処理を行います");
}

window.onload = () => {
  canvas.style.display = 'none';
  const profileImg = document.getElementById("profile-img");
  const profileInput = document.getElementById("profile-input");

  profileImg.addEventListener("click", () => {
    profileInput.click();
  });

  profileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      profileImg.src = reader.result;
    };
    fetch('/upload_profile_image', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ image: reader.result })
    })
    .then(response => response.json())
    .then(data => {
      console.log('保存成功:', data);
    })
    .catch(error => {
      console.error('アップロード失敗:', error);
    });

    reader.readAsDataURL(file);
  });
};

let textEnabled = false;
let textFirstTapDone = false;

document.getElementById("text-toggle-icon").addEventListener("click", () => {
  textEnabled = !textEnabled;
  textFirstTapDone = false;

  const toolsPanel = document.getElementById("text-tools");
  toolsPanel.style.display = textEnabled ? "block" : "none";

  const icon = document.getElementById("text-toggle-icon");
  icon.src = textEnabled ? "/static/pen_on.jpeg" : "/static/pen_off.jpeg";
});

document.body.addEventListener("click", (e) => {
  if (!textEnabled) return;

  if (!textFirstTapDone) {
    textFirstTapDone = true;
    return;
  }

  if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA" || e.target.tagName === "SELECT") return;

  const margin = 20;
  const inputWidth = 150;
  const maxX = window.innerWidth - inputWidth - margin;
  const x = Math.min(e.pageX, maxX);
  const y = e.pageY;

  const input = document.createElement("input");
  input.type = "text";
  input.placeholder = "テキストを入力";
  input.className = "text-sticker";
  input.style.position = "absolute";
  input.style.left = `${x}px`;
  input.style.top = `${y}px`;
  input.style.width = '150px';
  input.style.maxWidth = 'calc(100vw - 40px)';

  const textColorPicker = document.getElementById("text-color-picker");
  const fontSelector = document.getElementById("font-selector");
  const fontSizeSlider = document.getElementById("font-size-slider");

  if (textColorPicker) input.style.setProperty('color', textColorPicker.value, 'important');
  if (fontSelector) input.style.fontFamily = fontSelector.value;
  if (fontSizeSlider) input.style.fontSize = fontSizeSlider.value + "px";

  const container = document.getElementById('page-wrapper');
  container.appendChild(input);

  input.addEventListener("blur", () => {
    if (input.value.trim() === "") {
      input.remove();
    }
  });
  input.focus();

  let offsetX, offsetY, dragging = false;

  input.addEventListener("mousedown", (ev) => {
    dragging = true;
    offsetX = ev.offsetX;
    offsetY = ev.offsetY;
  });

  document.addEventListener("mousemove", (ev) => {
    if (!dragging) return;
    input.style.left = `${ev.pageX - offsetX}px`;
    input.style.top = `${ev.pageY - offsetY}px`;
  });

  document.addEventListener("mouseup", () => {
    dragging = false;
  });

  let longPressTimer;
  input.addEventListener("touchstart", () => {
    longPressTimer = setTimeout(() => {
      input.remove();
    }, 1000);
  });

  input.addEventListener("touchend", () => {
    clearTimeout(longPressTimer);
  });
});

// ✅ テキストスタイルリアルタイム反映
const textColorPicker = document.getElementById("text-color-picker");
const fontSelector = document.getElementById("font-selector");
const fontSizeSlider = document.getElementById("font-size-slider");

function applyTextStyles() {
  document.querySelectorAll(".text-sticker").forEach(input => {
    if (textColorPicker) input.style.color = textColorPicker.value;
    if (fontSelector) input.style.fontFamily = fontSelector.value;
    if (fontSizeSlider) input.style.fontSize = fontSizeSlider.value + "px";
  });
}
if (textColorPicker) textColorPicker.addEventListener("input", applyTextStyles);
if (fontSelector) fontSelector.addEventListener("change", applyTextStyles);
if (fontSizeSlider) fontSizeSlider.addEventListener("input", applyTextStyles);


function toggleBackgroundList() {
  const list = document.getElementById('bg-template-list');
  list.style.display = (list.style.display === 'none' || list.style.display === '') ? 'flex' : 'none';
}

function setBackground(url) {
  document.body.style.backgroundImage = `url('${url}')`;
  document.getElementById('bg-template-list').style.display = 'none';
}
function hideAddLink(event) {
  event.stopPropagation(); // 「showHiddenSNS()」が動かないように
  const addBtn = document.getElementById('add-link-button');
  if (addBtn) addBtn.style.display = 'none';
}function restoreSNS() {
 ['instagram', 'line', 'bereal', 'x', 'tiktok'].forEach(service => {
    const wrapper = document.querySelector(`.sns-wrapper:has(#input-${service})`);
    if (wrapper) wrapper.style.display = 'flex';
  });

  const addBtn = document.getElementById('add-link-button');
  if (addBtn) addBtn.style.display = 'flex';
  const extraTextWrapper = document.getElementById('extra-text-wrapper');
  if (extraTextWrapper) extraTextWrapper.style.display = 'block';
  const youtubeSection = document.querySelector('.youtube-section');
  if (youtubeSection) youtubeSection.style.display = 'block';
  const diagnosisWrapper = document.getElementById("diagnosis-wrapper");
  if (diagnosisWrapper) diagnosisWrapper.style.display = "block";
  const spotifySection = document.getElementById('spotify-section');
  if (spotifySection) spotifySection.style.display = 'block';
  const selfPR = document.getElementById('self-pr-section');
  if (selfPR) selfPR.style.display = 'block';
}
function hideExtraText() {
  const wrapper = document.getElementById('extra-text-wrapper');
  if (wrapper) wrapper.style.display = 'none';
}
function hideDiagnosisButton() {
  const diagnosisWrapper = document.getElementById("diagnosis-wrapper");
  if (diagnosisWrapper) diagnosisWrapper.style.display = "none";
}

function restoreDiagnosisButton() {
  const diagnosisWrapper = document.getElementById("diagnosis-wrapper");
  if (diagnosisWrapper) diagnosisWrapper.style.display = "block";
}

function hideSpotifySection() {
  const section = document.getElementById('spotify-section');
   if (section) {
    section.style.display = 'block';
  }
}
function restoreSpotifySection() {
  const section = document.getElementById('spotify-section');
  if (section) section.style.display = 'block';
}
function hideSelfPRSection() {
  const section = document.getElementById('self-pr-section');
  if (section) section.style.display = 'none';
}

function restoreSelfPRSection() {
  const section = document.getElementById('self-pr-section');
  if (section) section.style.display = 'block';
}

document.getElementById('finish-button').addEventListener('click', async () => {
  const finishBtn = document.getElementById('finish-button');
 const checkbox = document.getElementById('agree-checkbox');
if (!checkbox.checked) {
showCuteAlert('利用規約に同意してください。');
  document.getElementById('terms-modal').style.display = 'flex';
  return;
}
  finishBtn.disabled = true;
  finishBtn.textContent = '生成中...';
  await compressAllImagesBeforeSend(); 
  document.querySelectorAll('#background-list img').forEach(img => {
  img.remove();
});
// 入力値を表示用の要素に反映
// 入力値を表示エリアに反映する（完成前に必要！）
// 入力値を value 属性に反映（Firebaseに反映されるように）
function escapeHTML(str) {
  return str.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
}

const editableTexts = document.querySelectorAll('.editable-text, textarea');
editableTexts.forEach(input => {
  const val = input.value.trim();
  input.setAttribute('value', escapeHTML(val));
  if (input.tagName === 'TEXTAREA') {
    input.textContent = escapeHTML(val);
  }
});

editableTexts.forEach((input) => {
  input.setAttribute('value', input.value.trim());
});

// 記入欄（textarea）の値を value に反映
const extraInput = document.getElementById('extra-text');
if (extraInput) {
  const text = extraInput.value.trim();
  extraInput.setAttribute('value', text);

  let hidden = document.getElementById('hidden-extra-text');
  if (!hidden) {
    hidden = document.createElement('input');
    hidden.type = 'hidden';
    hidden.id = 'hidden-extra-text';
    hidden.name = 'extra-text';
    extraInput.parentNode.appendChild(hidden); // ✅ 修正！
  }
  hidden.value = text;
   extraInput.textContent = text;
}

  const toolbar = document.getElementById('toolbar');
  if (toolbar) toolbar.style.display = 'none';


  const youtubeBatsu = document.querySelector('.youtube-section .sns-delete-btn');
  if (youtubeBatsu) youtubeBatsu.style.display = 'none';
  // ✅ YouTube入力欄と反映ボタンを非表示にする
const youtubeInput = document.getElementById('youtube-url');
const youtubeButton = document.querySelector('.youtube-section button');
if (youtubeInput) youtubeInput.style.display = 'none';
if (youtubeButton) youtubeButton.style.display = 'none';
// ✅ Spotify入力欄と反映ボタンを非表示にする
const spotifyInput = document.getElementById('spotify-url');
const spotifyButton = document.querySelector('#spotify-section button');
if (spotifyInput) spotifyInput.style.display = 'none';
if (spotifyButton) spotifyButton.style.display = 'none';
const templateButton = document.querySelector('.deletable-templates');
if (templateButton) templateButton.style.display = 'none';
const selfPRTemplateButton = document.querySelector('.self-pr-template-section');
if (selfPRTemplateButton) selfPRTemplateButton.style.display = 'none';


  const extraBatsu = document.querySelector('#extra-text-wrapper .sns-delete-btn');
  if (extraBatsu) extraBatsu.style.display = 'none';
  const diagnosisBatsu = document.querySelector('#diagnosis-wrapper .sns-delete-btn');
  if (diagnosisBatsu) diagnosisBatsu.style.display = 'none';
  const externalBatsu = document.querySelector('#external-link-section .sns-delete-btn');
  if (externalBatsu) externalBatsu.style.display = 'none';
  const spotifyBatsu = document.querySelector('#spotify-section .sns-delete-btn');
  if (spotifyBatsu) spotifyBatsu.style.display = 'none';
  const selfPRBatsu = document.querySelector('#self-pr-section .sns-delete-btn');
  if (selfPRBatsu) selfPRBatsu.style.display = 'none';
  const snsExplain = document.getElementById('sns-explain');
  if (snsExplain) snsExplain.style.display = 'none';

 ['instagram', 'line', 'bereal', 'x', 'tiktok'].forEach(service => {
  const url = urls[service];
  if (url) {
    const icon = document.querySelector(`.sns-icon-bar img[onclick*="${service}"]`);
    if (icon) {
      const linkWrapper = document.createElement('a');
      linkWrapper.href = url;
      linkWrapper.target = '_blank';
      linkWrapper.appendChild(icon.cloneNode(true));
      icon.replaceWith(linkWrapper);
    }
  }
});

  // ✅ プロフィール画像が blob: だったら保存済みのURLに書き換える
  const profileImg = document.getElementById("profile-img");
  if (profileImg && profileImg.src.startsWith("blob:")) {
    profileImg.src = "/static/uploads/profile.jpeg";
  }
  if (profileImg && profileImg.src.startsWith("data:image/")) {
    profileImg.src = await compressImage(profileImg.src);
  }
    finishBtn.style.display = 'none';

    const html = document.documentElement.outerHTML;

  // ✅ base64画像のうち、プロフィール画像とデコ画像だけは削除対象から除外！
  const cleanedHTML = html.replace(/<img[^>]+src="data:image\/[^"]+"[^>]*>/g, (match) => {
    if (match.includes('id="profile-img"') || match.includes('class="deco-img"')) {
      return match; // → プロフィール画像 or デコ画像はそのまま残す
    } else {
      return match.replace(/src="data:image\/[^"]+"/, 'src="/static/deleted_image.jpeg"');
    }
  });

  const formData = new FormData();
  formData.append('html', cleanedHTML);

  const res = await fetch('/generate_url', {
    method: 'POST',
    body: formData
  });

  const data = await res.json();
  if (data.url) {
    finishBtn.textContent = '生成完了';
    finishBtn.style.display = 'block';

    const output = document.createElement('div');
    output.id = 'shared-url-box';
    output.innerHTML = `<p>このURLを共有できます👇</p><a href="${data.url}" target="_blank">${data.url}</a>`;
    output.style.cssText = `...`; // スタイル省略可
    document.body.appendChild(output);

    setTimeout(() => {
      const box = document.getElementById('shared-url-box');
      if (box) box.remove();
    }, 600000);
  } else {
    alert('URLの発行に失敗しました');
    finishBtn.disabled = false;
    finishBtn.textContent = '完成';
    finishBtn.style.display = 'block';
  }
});

function embedYouTubeVideo() {
  const input = document.getElementById('youtube-url');
  const player = document.getElementById('youtube-player');
  let url = input.value.trim();

  // m.youtube → www.youtube に変換
  url = url.replace("m.youtube.com", "www.youtube.com");

  const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
  if (match && match[1]) {
    const videoId = match[1];
    player.innerHTML = `
      <div style="
        border-radius: 18px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        max-width: 90vw;
        margin: 0 auto 12px auto;
      ">
        <iframe width="100%" height="200" 
          src="https://www.youtube.com/embed/${videoId}" 
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
          allowfullscreen>
        </iframe>
      </div>
    `;
  } else {
    player.innerHTML = "<p style='color:red;'>正しいYouTubeのURLを入力してください。</p>";
  }
}

function embedSpotify() {
  const url = document.getElementById("spotify-url").value.trim();

  if (!url.includes("open.spotify.com")) {
    alert("Spotifyの正しいURLを入力してください。");
    return;
  }

  try {
    const parsed = new URL(url);
    const cleanPath = parsed.pathname.replace('/intl-ja', '');  // ← ここで取り除く
    const embedUrl = "https://open.spotify.com/embed" + cleanPath;

    const iframe = `
      <iframe src="${embedUrl}" 
        style="width: calc(100% - 40px); height: 152px; border-radius:12px; display: block; margin: 0 auto;" 
        frameborder="0" allowtransparency="true" allow="encrypted-media">
      </iframe>
    `;
    document.getElementById("spotify-player").innerHTML = iframe;
  } catch {
    alert("URLの形式が正しくありません。");
  }
}
function showTemplateButtons() {
  const btns = document.getElementById('template-buttons');
  btns.style.display = 'flex';
}
function insertTemplate(type) {
  const textarea = document.getElementById("extra-text");
  let template = "";

  switch(type) {
  case 'club':
    template = "高校のときは〇〇部やってて、放課後はだいたい部活にいたかも。まあまあガチでやってたから、体力とか気合いはそれなりにある…はず！先輩後輩とのノリとか、地味にコミュ力鍛えられた気もする笑";
    break;

  case 'study':
    template = "〇〇系を勉強してるけど、内容はわりとニッチでおもしろいかも。課題はエグい時あるけど、締切には一応ちゃんと間に合わせてる笑わりと計画立ててコツコツやるタイプです、多分。";
    break;

  case 'circle':
    template = "〇〇系のサークル入ってて、イベントとかで騒いでること多いかも。飲みとか合宿とか、エモい思い出いろいろできてる！ガチよりエンジョイ派だけど、人と関わるのはわりと好き。";
    break;

  case 'parttime':
    template = "〇〇のバイトしてるんだけど、接客とか慣れると意外と楽しい。最初は緊張してたけど、今はお客さんと軽く雑談とかもしてる笑責任とか時間とか、ちょっとは大人になった気がする。";
    break;

  case 'hobby':
    template = "〇〇が趣味で、スキあらばやってるかも。ひとりの時間にハマれるのが最高なんよ〜！同じ趣味の人と話せたらめっちゃ盛り上がるタイプ。たぶん、めっちゃ語る笑";
    break;
}


  textarea.value = template + '\n\n⸻\n\n'; // ← 上書き（入れ替え）
}
const textarea = document.getElementById("your-textarea-id"); // ←実際のtextareaのIDに置き換えて！
textarea.classList.remove("fade-in");
void textarea.offsetWidth; // ←再アニメ用のトリック
textarea.classList.add("fade-in");
function showTemplateButtons() {
  const btns = document.getElementById('template-buttons');
  if (btns.style.display === 'flex') {
    btns.style.display = 'none';
  } else {
    btns.style.display = 'flex';
  }
}
function showPRTemplateButtons() {
  const btnArea = document.getElementById('pr-template-buttons');
  btnArea.style.display = btnArea.style.display === 'flex' ? 'none' : 'flex';
}

function showPRTemplateButtons() {
  const btnArea = document.getElementById('pr-template-buttons');
  btnArea.style.display = btnArea.style.display === 'flex' ? 'none' : 'flex';
}

function insertPRTemplate(category) {
  const prTemplates = {
  study: "勉強では〇〇に特に力を入れてきました。日々の積み重ねと計画的な取り組みで、知識だけでなく考える力も伸ばせたと感じています。特に△△では苦手な分野も逃げずに向き合い、自分なりの工夫で乗り越えてきました。",
  
  sports: "学生時代は〇〇部に所属しており、練習を通じて体力だけでなく集中力や礼儀も身につけました。仲間と支え合う経験も大きな財産です。試合や大会では自分の役割を果たすことにこだわり、勝ち負け以上にチームで取り組むことの大切さを実感しました。",
  
  communication: "人と話すことが好きで、〇〇では周囲と協力しながら進めることが多く、自然とコミュニケーション力が鍛えられたと思います。相手の立場や気持ちを考えながら接するよう心がけています。場の雰囲気を読み取りつつ、自分の意見もしっかり伝えるバランスを大切にしています。",
  
  creativity: "〇〇の活動を通じて、アイデアを出して形にする面白さを学びました。自由な発想と工夫する力が自分の強みだと思っています。周囲と意見を出し合いながら、より良い形にブラッシュアップしていく過程にやりがいを感じます。",
  
  patience: "〇〇の経験から、うまくいかない時でも投げ出さずに取り組む姿勢を大切にしてきました。小さな進歩を積み上げる力が身につきました。結果が出るまで時間がかかることもありましたが、粘り強く続けることで自信につながっています。"
};


  const textarea = document.querySelector('#self-pr-textarea');
  if (textarea) {
    textarea.value = prTemplates[category];
  }
}



  async function compressImage(base64, maxSize = 300) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement("canvas");
      const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;

      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      const mimeType = base64.startsWith("data:image/png") ? "image/png" : "image/jpeg";
      const compressed = canvas.toDataURL(mimeType, 0.6);
      resolve(compressed);
    };
    img.src = base64;
  });
}


  </script>
<!-- 横スクロール可能な背景テンプレ一覧 -->
<div id="bg-template-list" style="
  display: none;
  position: fixed;
  bottom: 70px;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  padding: 10px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  z-index: 1100;
  max-width: 90vw;
  overflow-x: auto;
  gap: 10px;
  scrollbar-width: none; /* Firefox用 */
  -ms-overflow-style: none; /* IE用 */
">
<!-- ▼ カメラアイコン付きテンプレ追加ここから -->
<img src="/static/camera.jpeg" onclick="document.getElementById('background-input').click()" 
     style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<!-- ▼ カメラアイコン付きテンプレ追加ここまで -->
  <img src="/static/haikei_1.jpeg" onclick="setBackground('/static/haikei_1.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<img src="/static/haikei_2.jpeg" onclick="setBackground('/static/haikei_2.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<img src="/static/haikei_3.jpeg" onclick="setBackground('/static/haikei_3.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<img src="/static/haikei_4.jpeg" onclick="setBackground('/static/haikei_4.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<img src="/static/haikei_5.jpeg" onclick="setBackground('/static/haikei_5.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<img src="/static/haikei_6.jpeg" onclick="setBackground('/static/haikei_6.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<img src="/static/haikei_7.jpeg" onclick="setBackground('/static/haikei_7.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<img src="/static/haikei_8.jpeg" onclick="setBackground('/static/haikei_8.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<img src="/static/haikei_9.jpeg" onclick="setBackground('/static/haikei_9.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<img src="/static/haikei_10.jpeg" onclick="setBackground('/static/haikei_10.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<!-- さらに追加してもOK！ -->
</div>
<!-- ▼ 先にボタンのスタイル定義！ -->
<style>
  #diagnosis-button {
    padding: 12px 24px;
    font-size: 17px;
    border-radius: 12px;
    background: rgb(255, 102, 153);
    color: #fff;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    letter-spacing: 1px;
    transition: all 0.2s ease-in-out;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3); /* ← ここで視認性UP */
  }

  #diagnosis-button:hover {
    background: linear-gradient(135deg, #ffd1e9, #d6f2f9, #ffffff);
    transform: scale(1.05);
  }
</style>

<!-- ▼ 診断ボタン（バツ付き） -->
<div id="diagnosis-wrapper" style="position: relative; margin-top: 20px; text-align: center;">
  <img src="/static/batu.jpeg" alt="削除" class="sns-delete-btn" onclick="hideDiagnosisButton()" style="
    position: absolute;
    top: -13px;
    right: 100px;
    width: 18px;
    height: 18px;
    cursor: pointer;
    z-index: 10;
  ">
  <button id="diagnosis-button" onclick="startDiagnosis()">〇〇さんの特徴！</button>
</div>
<!-- 🔽 自己PR入力と分析ボタン -->
<div id="self-pr-section" style="margin-top: 40px; position: relative;">
  <img src="/static/batu.jpeg" alt="削除" class="sns-delete-btn" onclick="hideSelfPRSection()" style="
    position: absolute;
    top: 38px;
    right: 20px;
    width: 18px;
    height: 18px;
    cursor: pointer;
    z-index: 10;
  ">

  <h3 style="text-align: center;">AIが自己PRを分析！結果を見てみよう</h3>

  <!-- ✅ 自由記入欄に寄せたtextarea -->
  <textarea id="self-pr-textarea" rows="4" placeholder="例：私は目標に向かって努力するのが得意で…"
    style="
      margin-top: 3px;
      margin-left: 20px;
      padding: 14px 18px;
      border-radius: 14px;
      border: 1px solid #ccc;
      width: 90vw;
      max-width: 650px;
      height: 160px;
      font-size: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      resize: none;
      line-height: 1.6;
      background-color: #fff;
      box-sizing: border-box;
    "></textarea>
<!-- 自己PRテンプレート挿入ボタン -->
<div class="deletable-templates self-pr-template-section" style="text-align: center; margin-top: 13px;">
  <button onclick="showPRTemplateButtons()" style="
    font-size: 14px;
    padding: 6px 14px;
    border-radius: 8px;
    border: none;
    background: rgb(255, 224, 136); 
    color: #333;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: background-color 0.2s ease;
  ">✍️ 自己PRテンプレート</button>
</div>

<!-- 自己PRテンプレート項目ボタン -->
<div id="pr-template-buttons" style="
  margin: 12px auto 0;
  display: none;
  justify-content: center;
  flex-wrap: wrap;
  gap: 6px;
  max-width: 90%;
">
  <button onclick="insertPRTemplate('study')" class="template-btn">勉学</button>
  <button onclick="insertPRTemplate('sports')" class="template-btn">スポーツ</button>
  <button onclick="insertPRTemplate('communication')" class="template-btn">コミュ力</button>
  <button onclick="insertPRTemplate('creativity')" class="template-btn">創造力</button>
  <button onclick="insertPRTemplate('patience')" class="template-btn">忍耐力</button>
</div>


 <!-- ✅ 自由記入欄と調和させたボタン -->
<button onclick="analyzeSelfPR()" style="
  display: block;
  margin: 10px auto;
  padding: 10px 20px;
  font-size: 15px;
  border-radius: 10px;
  background: rgb(255, 224, 136); 
  color: black; /* 文字を黒に */
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  border: 1px solid #ccc;
">分析して表示</button>
</div>


<!-- 自己PR分析モーダル -->
<div id="self-pr-modal" style="
  display: none; /* 初期は非表示！ */
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background-color: rgba(0, 0, 0, 0.6);
  z-index: 10000;
  box-sizing: border-box;
">
  <!-- ✅ モーダル中身をflexで中央寄せ -->
  <div style="
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
  ">
    <!-- 白いボックス -->
    <div style="
      background: white;
      padding: 30px 20px;
      border-radius: 16px;
      max-width: 90%;
      width: 340px;
      text-align: center;
      position: relative;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    ">
      <!-- 閉じる -->
      <div onclick="document.getElementById('self-pr-modal').style.display='none'" style="
        position: absolute;
        top: 12px;
        right: 16px;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
      ">×</div>

     <!-- チャート -->
<canvas id="resultChart" width="220" height="220" style="
  display: block;
  margin: 0 auto 20px;
  background: linear-gradient(to bottom, #ffffff, #e0f0ff);
  border-radius: 20px;
  transform: translateX(80px); /* 👈 右にずらす */
"></canvas>

<!-- コメント -->
<h3 style="margin-bottom: -40px 0 5px;">あなたの強み診断結果</h3> <!-- 👈 下にずらす -->
<div id="self-pr-comment" style="text-align: left; font-size: 15px; margin-top: 10px;"></div>
    </div>
  </div>
</div>





<!-- ▼ モーダル表示部分 -->
<div id="diagnosis-modal" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background-color: rgba(0,0,0,0.7);
  z-index: 9999;
  align-items: center;
  justify-content: center;
">
  <div style="
    background: white;
    padding: 28px 24px;
    border-radius: 20px;
    max-width: 90vw;
    font-size: 13px;
    font-weight: bold;
    text-align: center;
    font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', sans-serif;
    animation: fadeIn 0.6s ease-in-out;
    line-height: 1.6;
  " id="diagnosis-result"></div>
</div>

<style>
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}
</style>

<script>
function startDiagnosis() {
  const textInputs = Array.from(document.querySelectorAll('.editable-text')).map(i => i.value).join(' ');
  const extra = document.getElementById('extra-text')?.value || '';
  const combined = (textInputs + ' ' + extra).toLowerCase();
  const barColor = getComputedStyle(document.documentElement).getPropertyValue('--bar-color').trim().toLowerCase();

  let type = '';

  // I / E 判定
  if (
    combined.match(/ひとり|静か|本|ソロ|家|落ち着く|アニメ|内省|黙る|マイペース|省エネ|観察|聞き役|自分時間|ひそか|一人旅/) ||
    combined.match(/私は一人で過ごす時間に心地よさを感じます。静かな場所で本を読んだり、思索にふけることでエネルギーが回復します。人と話すよりも、まず自分の中で考えを整理することが多いです。/)
  ) {
    type += 'I';
  } else if (
    combined.match(/仲間|みんな|カラオケ|イベント|旅行|飲み会|おしゃべり|騒ぐ|SNS|パーティー|盛り上がり|賑やか|外出|遊ぶ|テンション/) ||
    combined.match(/人と話したり、誰かと一緒に過ごすことで元気が出ます。イベントや集まりが好きで、新しい人と出会うことにワクワクします。黙っているよりも、会話の中で自分を表現したいです。/)
  ) {
    type += 'E';
  } else {
    type += 'I';
  }

  // N / S 判定
  if (
    combined.match(/空想|ひらめき|想像|クリエイティブ|アート|創作|哲学|直感|夢|未来|理想|可能性|インスピレーション|抽象|概念/) ||
    combined.match(/私はアイデアや空想を膨らませるのが好きで、現実よりも未来の可能性に目を向けがちです。直感的に物事を捉える場面も多く、抽象的な話題に惹かれることがよくあります。/)
  ) {
    type += 'N';
  } else if (
    combined.match(/現実|実用|旅行|運動|料理|アウトドア|具体|体験|五感|事実|地に足|経験|現場|証拠/) ||
    combined.match(/自分が実際に体験したことや、現場で得た感覚を大事にしています。具体的な事実をもとに判断する傾向があり、抽象的な話よりも目の前の現実を重視する方です。/)
  ) {
    type += 'S';
  } else {
    type += 'N';
  }

  // T / F 判定（スコア式）
  let tfScore = 0;
  if (
    combined.match(/論理|分析|効率|数字|プログラミング|理屈|戦略|データ|合理|客観|判断|競争|議論/) ||
    combined.match(/物事を判断するときは感情よりも論理的な思考を優先します。データや事実に基づいて効率的に進めたいという意識が強く、感情に流されないよう心がけています。/)
  ) tfScore += 1;

  if (
    combined.match(/共感|やさしい|応援|思いやり|ケア|感情|涙|相談|気持ち|ぬくもり|愛情|支える|寄り添う/) ||
    combined.match(/人の気持ちに敏感で、困っている人を見ると放っておけません。相手に共感しながら接することを大切にしており、感情を共有することで関係を深めようとします。/)
  ) tfScore -= 1;

  if (barColor.includes('pink') || barColor.includes('#f')) tfScore -= 1;
  if (barColor.includes('blue') || barColor.includes('#00f') || barColor.includes('navy')) tfScore += 1;

  type += tfScore >= 0 ? 'T' : 'F';

  // J / P 判定
  if (
    combined.match(/計画|整理|スケジュール|時間管理|リスト|準備|管理|目標|段取り|締切|しっかり|計算|安定|構造/) ||
    combined.match(/あらかじめ計画を立てて行動する方が安心します。スケジュールを組んで進めたり、段取りを整えることで気持ちに余裕が生まれるタイプです。突然の変更は苦手です。/)
  ) {
    type += 'J';
  } else if (
    combined.match(/自由|気まま|柔軟|マイペース|その場|思いつき|即興|対応力|変化|流れ|勢い|ゆるい|直感的/) ||
    combined.match(/その時の気分や状況に応じて柔軟に動くことが多いです。細かい計画よりも、流れに乗って即興で対応する方が得意で、自分らしさを大切にしたいと感じています。/)
  ) {
    type += 'P';
  } else {
    type += 'P';
  }




  const mbtiDescriptions = {
  INFP: "理想家でやさしい癒し系！",
  INTP: "論理派の知的探究タイプ！",
  INFJ: "共感力ある静かなカリスマ！",
  INTJ: "未来を読む戦略家タイプ！",
  ENFP: "直感で動く冒険クリエイター！",
  ENTP: "機転と行動力ある挑戦者！",
  ENFJ: "人を導く巻き込み上手！",
  ENTJ: "目標一直線なリーダー肌！",
  ISFP: "感性豊かな穏やかタイプ！",
  ISTP: "冷静で実践派な職人肌！",
  ISFJ: "優しく支える縁の下の力持ち！",
  ISTJ: "真面目で信頼される堅実家！",
  ESFP: "陽気なムードメーカー！",
  ESTP: "行動派なリアリスト！",
  ESFJ: "世話好きで親しみやすい！",
  ESTJ: "頼れる実務のプロ！"
};


  const displayName = "〇〇さん";
  const resultLines = [];

  resultLines.push(`<div style="font-size: 20px;">${displayName}は「${type}タイプ」かも！？</div>`);
  resultLines.push(`<div>MBTI的には：${mbtiDescriptions[type] || "バランス型タイプ！"}</div>`);

  if (barColor.includes('pink') || barColor.includes('#f') || barColor.includes('rose')) {
  resultLines.push("<div>色診断：ピンク系 → 感受性豊かでやさしい性格！</div>");
} else if (barColor.includes('blue') || barColor.includes('navy') || barColor.includes('#00f') || barColor.includes('sky')) {
  resultLines.push("<div>色診断：青系 → 冷静で誠実、知的な性格！</div>");
} else if (barColor.includes('green') || barColor.includes('lime') || barColor.includes('olive')) {
  resultLines.push("<div>色診断：緑系 → 自然や平和を大切にする穏やかタイプ！</div>");
} else if (barColor.includes('yellow') || barColor.includes('gold') || barColor.includes('#ff0')) {
  resultLines.push("<div>色診断：黄色系 → 明るく前向きで社交的な性格！</div>");
} else if (barColor.includes('orange') || barColor.includes('#ffa')) {
  resultLines.push("<div>色診断：オレンジ系 → 活動的で人懐っこいエネルギー派！</div>");
} else if (barColor.includes('red') || barColor.includes('crimson') || barColor.includes('#f00')) {
  resultLines.push("<div>色診断：赤系 → 情熱的でリーダーシップを持つ人！</div>");
} else if (barColor.includes('purple') || barColor.includes('violet') || barColor.includes('indigo')) {
  resultLines.push("<div>色診断：紫系 → 感性豊かでミステリアスな魅力！</div>");
} else if (barColor.includes('black') || barColor.includes('#000')) {
  resultLines.push("<div>色診断：黒系 → 意志が強く、落ち着いた雰囲気！</div>");
} else if (barColor.includes('white') || barColor.includes('#fff') || barColor.includes('ivory')) {
  resultLines.push("<div>色診断：白系 → 純粋で素直、調和を大切にするタイプ！</div>");
} else if (barColor.includes('gray') || barColor.includes('grey') || barColor.includes('#888')) {
  resultLines.push("<div>色診断：グレー系 → 冷静で大人びたバランスタイプ！</div>");
} else {
  resultLines.push("<div>色診断：中間色 → 多様性を受け入れる柔軟なタイプ！</div>");
}


 const hobbyTags = {
  'ゲーム': '戦略派 or マイペース派',
  'アニメ': '感性豊かで内向型寄り',
  '旅行': '好奇心旺盛な冒険好き',
  'カフェ': '癒し重視・感性タイプ',
  '音楽': '感情と結びつきが強い人',
  '読書': '思索型・想像力が豊か',
  'スポーツ': '外向的でエネルギッシュ',
  '美術': 'クリエイティブ志向',
  '料理': '繊細で家庭的な気質',
  '筋トレ': '自己成長意識が強いタイプ',
  'ファッション': '自己表現と流行に敏感なタイプ',
  'ダンス': '身体で感情を表現する情熱派',
  'カラオケ': '社交的で表現が好きな盛り上げ役',
  'ボードゲーム': '頭脳派でみんなと楽しむことが好き',
  'ペット': '愛情深く、癒しやつながりを大事にする人',
  'イラスト': '繊細で感受性が豊か、想像力も高い',
  'カメラ': '観察眼に優れ、感情を写真で表現したいタイプ',
  '映画': '物語や世界観に没入するエモ派',
  'カラフルな雑貨': '明るく個性的なセンスの持ち主',
  '手芸': '丁寧で集中力が高く、ものづくり好き',
  '散歩': '自然との調和を大切にするマイペース派',
  'キャンプ': '自然との一体感を求めるアウトドア派',
  '釣り': '忍耐強く静かな時間を楽しめるタイプ',
  '日記': '自己内省型で感情の整理が得意',
  'ブログ': '発信力があり、思考を言語化するのが得意',
  'ランニング': 'コツコツ努力型・達成感重視タイプ',
  'DIY': '手を動かして考えるクラフトマンタイプ',
  '車': '機械やスピードにロマンを感じる人',
  'バイク': '刺激と自由を求めるアウトロー気質',
  'スイーツ作り': '創意工夫と丁寧さを楽しむクリエイター',
  '推し活': '情熱を注げる対象がある愛情深いタイプ',
  'Vlog': '日常の美しさや感動を発信したいタイプ',
  '舞台': '表現芸術に感動できる感性派'
};

const detectedHobbies = Object.keys(hobbyTags).filter(word => combined.includes(word));
if (detectedHobbies.length > 0) {
  resultLines.push(`<div>${displayName}は ${detectedHobbies.join('・')} が好きな傾向があるよ！</div>`);
  resultLines.push(`<div>→ 傾向：${detectedHobbies.map(h => hobbyTags[h]).join(' ／ ')}</div>`);
}

const hobbyExtensions = [];

// 自然文＋キーワードの両方に対応
const hobbyExtensionPatterns = [
  { keyword: 'ゲーム', pattern: /ゲーム|暇(な|なときに)?(とき|時間)は(だいたい)?ゲーム|FPS|RPG|スプラ|エーペックス|マリオ|任天堂|Steam|Switch|スマホゲーム|アクションゲーム/, msg: "\ud83c\udfae サバゲーやボードゲームも好きな可能性あり！" },
  { keyword: '音楽', pattern: /音楽|通学(中)?に(よく)?音楽を聴く|ライブ(に行く|参戦)|フェス|推しの曲|BGM|プレイリスト|イヤホン|Spotify|邦ロック|J-POP|洋楽|ロックバンド/, msg: "\ud83c\udfb5 作曲やライブ参戦にも興味あるかも！" },
  { keyword: 'カフェ', pattern: /カフェ|カフェ巡り|インスタ映えするカフェ|カフェでゆっくり|おしゃれなカフェ|お気に入りのカフェ|コーヒー|ラテアート|ドリップ|スタバ|喫茶店/, msg: "\u2615\ufe0f カフェ巡りブログ始めてるかも？" },
  { keyword: '読書', pattern: /読書|本を読む|暇(なとき)?に読書|図書館通い|小説|文庫本|ビジネス書|マンガ|本屋に通う|Kindle|読書好き|ブックカフェ/, msg: "\ud83d\udcda 最近読んだ本の話をしてみると盛り上がるかも！" },
  { keyword: 'アニメ', pattern: /アニメ|深夜アニメ|毎週欠かさずアニメ|推しアニメ|オタク|アニメ映画|ジャンプ系|京アニ|アニメ好き|2次元|推しキャラ|U-NEXT|アニオタ/, msg: "\ud83d\udcfa 推しキャラやアニメある？って聞くと喜ぶタイプかも！" },
  { keyword: 'スポーツ', pattern: /スポーツ|(体育会系|運動部|部活で運動)|体を動かすのが好き|筋トレ|野球|サッカー|バスケ|テニス|ラグビー|陸上|体育|大会|試合|観戦|走るのが好き/, msg: "\u26bd 観戦派かプレイ派か聞いてみると意外な話が聞けるかも！" },
  { keyword: '旅行', pattern: /旅行|週末は(よく)?旅行に出かける|海外旅行|一人旅|温泉旅行|国内旅行|旅好き|観光地巡り|旅行計画/, msg: "\u2708\ufe0f 行ってみたい国とか語り合うと楽しいかも！" },
  { keyword: '美術', pattern: /美術|アート|美術館巡り|展覧会に行く|絵画鑑賞|芸術作品|現代アート|推し画家/, msg: "\ud83c\udfa8 美術館トークや推し画家の話がハマるかも！" },
  { keyword: '料理', pattern: /料理|自炊|クッキング|ごはん作り|レシピ|家庭料理|お菓子作り|食事の準備|キッチン/, msg: "\ud83c\udf73 得意料理とか聞くとテンション上がりそう！" },
  { keyword: '筋トレ', pattern: /筋トレ|ジムに通う|プロテイン|腹筋|ダンベル|ベンチプレス|鍛える|筋肉増やす|体を鍛える/, msg: "\ud83d\udcaa プロテインの話で盛り上がれるかも…！？" },
  { keyword: 'ファッション', pattern: /ファッション|服選びが好き|おしゃれ|ブランドに詳しい|セレクトショップ巡り|洋服コーデ|服の系統/, msg: "\ud83d\udc57 好きなブランドや服の系統、話してみよう！" },
  { keyword: 'カラオケ', pattern: /カラオケ|歌うのが好き|十八番の曲がある|ヒトカラ|歌唱力|DAM|JOYSOUND|カラオケで盛り上がる/, msg: "\ud83c\udfa4 定番ソングある？って聞くと一気に距離縮まるかも！" },
  { keyword: 'ペット', pattern: /ペット|犬|猫|うさぎ|飼ってる動物|ペット自慢|癒される存在|ペットとの時間|モフモフ/, msg: "\ud83d\udc3e 飼ってる動物の話をすると嬉しそうに話してくれるかも！" },
  { keyword: 'イラスト', pattern: /イラスト|絵を描く|デジ絵|アナログ絵|お絵かき|SNSに投稿|Pixiv|スケッチブック/, msg: "\ud83d\udd8c\ufe0f SNSに投稿してるかも？見せてもらってみよう！" },
  { keyword: '映画', pattern: /映画|映画館に行く|映画三昧|サブスクで映画|推し俳優|洋画|邦画|名作映画/, msg: "\ud83c\udfa5 好きなジャンルや推し俳優の話で盛り上がれるかも！" },
  { keyword: 'ダンス', pattern: /ダンス|踊るのが好き|振り付け覚える|K-POPダンス|ダンスサークル|ステージ経験/, msg: "\ud83d\udd7a\fe0f 好きなジャンルや振り付けの話をすると盛り上がりそう！" },
  { keyword: 'ボードゲーム', pattern: /ボードゲーム|カードゲーム|人狼|人生ゲーム|みんなで遊べるゲーム|頭脳戦/, msg: "\ud83c\udfb2 どのゲーム派か聞くと盛り上がれるかも！" },
  { keyword: '手芸', pattern: /手芸|裁縫|編み物|ハンドメイド|手作り|ミシン作業|布小物作り/, msg: "\ud83e\uddf5 ハンドメイド作品の話をすると嬉しそうに話すかも！" },
  { keyword: '散歩', pattern: /散歩|ウォーキング|自然の中を歩く|朝の散歩|気分転換に歩く|近所をぶらぶら/, msg: "\ud83d\udeb6\u200d 散歩コースの話から自然トークに広がるかも！" },
  { keyword: 'カメラ', pattern: /カメラ|写真を撮る|一眼レフ|構図|風景撮影|フォトコンテスト|写真集め|フィルムカメラ/, msg: "\ud83d\udcf7 撮った写真を見せてもらうと会話が弾むかも！" },
  { keyword: 'プログラミング', pattern: /プログラミング|コードを書く|アプリ開発|Python|JavaScript|Web制作|ハッカソン/, msg: "\ud83d\udcbb どんなアプリやコード書いてるか聞いてみよう！" },
  { keyword: 'DIY', pattern: /DIY|日曜大工|家具を自作|工具を使うのが得意|インテリア作り|改造/, msg: "\ud83d\udd27 最近作ったものやこだわりポイントを聞いてみよう！" },
  { keyword: '車', pattern: /車|ドライブ|車いじり|カスタム|車好き|愛車自慢|車の写真/, msg: "\ud83d\ude97 愛車エピソードやカスタムの話が弾みそう！" },
  { keyword: 'バイク', pattern: /バイク|ツーリング|バイク旅|カスタム|バイク愛好家|エンジン音/, msg: "\ud83d\ude97 愛車エピソードやカスタムの話が弾みそう！" },
  { keyword: 'スイーツ作り', pattern: /スイーツ作り|お菓子作り|ケーキ作る|クッキー焼く|レシピ探し/, msg: "\ud83c\udf70 得意なスイーツやレシピについて聞いてみよう！" },
  { keyword: '推し活', pattern: /推し活|アイドル応援|グッズ集め|ライブ参戦|好きなキャラに全力|沼る/, msg: "\ud83d\udc96 推しの魅力を熱く語ってもらうと喜ぶかも！" },
  { keyword: 'Vlog', pattern: /Vlog|映像日記|動画編集|日常記録|YouTube投稿|編集ソフト|日常を切り取る/, msg: "\ud83d\udcc9 編集ソフトやこだわりポイントを聞くと話が広がるかも！" },
  { keyword: '舞台', pattern: /舞台|演劇|劇団|舞台俳優|観劇|2.5次元|ミュージカル/, msg: "\ud83c\udfad 最近観た作品とか、役者さんの話題がハマるかも！" }
];

// ↓ 検出処理
for (const item of hobbyExtensionPatterns) {
  if (combined.includes(item.keyword) || item.pattern.test(combined)) {
    hobbyExtensions.push(item.msg);
  }
}

if (hobbyExtensions.length > 0) {
  resultLines.push(`<div style="margin-top:12px;">この話題を振ってみよう👇</div>`);
  resultLines.push(`
    <div style="
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 8px 4px;
      line-height: 1.7;
      word-break: keep-all;
      overflow-wrap: break-word;
    ">
      ${hobbyExtensions.map(line => `<div style="white-space: normal;">${line}</div>`).join('')}
    </div>
  `);
}


  localStorage.setItem('my_mbti', type);
  const mbtiEl = document.getElementById('mbti-type');
if (mbtiEl) mbtiEl.innerText = type;

  document.getElementById('diagnosis-result').innerHTML = resultLines.join('');
  document.getElementById('diagnosis-modal').style.display = 'flex';

  document.getElementById('diagnosis-modal').addEventListener('click', () => {
    document.getElementById('diagnosis-modal').style.display = 'none';
  });
}
window.dispatchEvent(new Event('DOMContentLoaded'));

</script>

<!-- ↓ ここがMBTIタイプが表示される非表示エリア -->
<div id="mbti-type" style="display:none;"></div>

<!-- ▼ 相性診断スクリプト -->
<script>
window.addEventListener('DOMContentLoaded', () => {
  const myMbti = localStorage.getItem('my_mbti');
  const otherMbti = document.getElementById('mbti-type')?.innerText ||
                    document.getElementById('hidden-mbti')?.value || '';

  if (myMbti && otherMbti && myMbti.length === 4 && otherMbti.length === 4) {
    const compatibility = getCompatibility(myMbti, otherMbti);
    const score = getCompatibilityScore(myMbti, otherMbti);
    showCompatibilityModal(myMbti, otherMbti, compatibility, score);
  }
});

function getCompatibility(mbti1, mbti2) {
  const perfectPairs = [
    ['INFP', 'ENFJ'], ['ENFP', 'INFJ'], ['INFJ', 'INTP'], ['INFP', 'INFJ'],
    ['ENFP', 'INTP'], ['ENTP', 'INFJ'], ['ENFJ', 'INFP'], ['ISFJ', 'ENFP'],
    ['ISTJ', 'ISFJ'], ['ISFP', 'INFP'], ['ESTP', 'ENFP'], ['ESFP', 'ENFJ'],
    ['ISTP', 'INFP'], ['INTP', 'ENTJ'], ['ENTP', 'INTJ'], ['ISFP', 'ESFJ'],
    ['ISTP', 'ESTJ'], ['ISFJ', 'ESFP'], ['ISTJ', 'ESTP'], ['INTJ', 'ENFP'],
    ['INTP', 'INFJ'], ['ESFJ', 'ISFP'], ['ESTJ', 'ISTP'], ['ESFP', 'ISFJ'],
    ['ESTP', 'ISTJ'], ['ENFJ', 'ISFP'], ['ENFP', 'ISFJ'], ['ENTJ', 'INFP'],
    ['INTJ', 'ENFJ'], ['ENFP', 'ENFP'], ['ENTP', 'ENTP'], ['INFP', 'INTP'],
    // ⬇ 拡張ここから
    ['ISFJ', 'ISTP'], ['INFJ', 'ENFJ'], ['ISFP', 'ENFP'], ['ENFP', 'ISFP'],
    ['ISTJ', 'ENTP'], ['ISTP', 'ENFP'], ['ESTJ', 'ENFJ'], ['INTP', 'ENTP'],
    ['ENTP', 'ISFJ'], ['ESFP', 'ISFP'], ['ISFP', 'ISFP'], ['INTP', 'ISFP'],
    ['INFP', 'INFP'], ['ENFJ', 'ENFJ'], ['ESTJ', 'ISTJ'], ['ISTP', 'ISFJ'],
    ['INFJ', 'ISFP'], ['ISFJ', 'INFJ'], ['ENFP', 'ISTP'], ['INTJ', 'INFP']
  ];


  if (mbti1 === mbti2) return '似たもの同士で安心感バッチリ！';
  for (const [a, b] of perfectPairs) {
    if ((mbti1 === a && mbti2 === b) || (mbti1 === b && mbti2 === a)) {
      return 'バランス最高！理想のペア！';
    }
  }
  return '価値観の違いも楽しめる関係！';
}


function getCompatibilityScore(m1, m2) {
  let score = 50;
  if (m1 === m2) return 90;
  const pairs = ['IE', 'NS', 'TF', 'JP'];
  for (let i = 0; i < 4; i++) {
    if (m1[i] === m2[i]) score += 10;
    else score -= 5;
  }
  return Math.max(0, Math.min(100, score));
}
function getCompatibilityComment(mbti1, mbti2) {
  const key = [mbti1, mbti2].sort().join('-');

  const commentMap = {
    'INFP-ENFJ': 'お互いの感性に惹かれ合い、自然と支え合える関係！',
    'ENFP-INFJ': '自由と深さのバランスが絶妙な相性！',
    'INFJ-INTP': '理想と論理の融合で、深い対話が止まらない！',
    'INFP-INFJ': '感受性の波長がぴったり合う癒し系コンビ！',
    'ENFP-INTP': '突飛なアイデアを一緒に飛躍させられる関係！',
    'ENTP-INFJ': '発想力と共感力が交差する刺激的な関係！',
    'ENFJ-INFP': '思いやりと柔らかさが共鳴するあったかペア！',
    'ISFJ-ENFP': '慎重さと冒険心のいいバランス！',
    'ISTJ-ISFJ': '安定と安心を生む王道ペア！',
    'ISFP-INFP': '共感力に溢れたやさしさ全開コンビ！',
    'ESTP-ENFP': '行動派と夢想家がぶつかりながらも惹かれ合う！',
    'ESFP-ENFJ': '明るさと面倒見の良さで周りも笑顔に！',
    'ISTP-INFP': '静と動の組み合わせが意外と心地いい！',
    'INTP-ENTJ': '計画と構想が噛み合う戦略的パートナー！',
    'ENTP-INTJ': '未来を語りたくなる知的ペア！',
    'ISFP-ESFJ': '自然体と気配りの絶妙なコンビ！',
    'ISTP-ESTJ': '現実的かつ信頼できるタッグ！',
    'ISFJ-ESFP': '穏やか×社交的の癒しと元気セット！',
    'ISTJ-ESTP': '冷静と情熱の間に意外な調和！',
    'INTJ-ENFP': '内なる情熱を共有できる変化推進コンビ！',
    'INTP-INFJ': '深い思索を楽しめる精神的つながり！',
    'ESFJ-ISFP': '柔らかくて安心できる包容力ペア！',
    'ESTJ-ISTP': '頼れる実務家同士で仕事バッチリ！',
    'ESFP-ISFJ': '感情と安定感が寄り添うあたたかペア！',
    'ESTP-ISTJ': '信頼とスピードのパートナーシップ！',
    'ENFJ-ISFP': '面倒見の良さと感性が溶け合う！',
    'ENFP-ISFJ': '冒険と安心が交差するほのぼの関係！',
    'ENTJ-INFP': 'カリスマと癒しの不思議な化学反応！',
    'INTJ-ENFJ': '論理と人情のハイブリッドパートナー！',
    'ENFP-ENFP': 'ノリと勢いが止まらない無限ループ！',
    'ENTP-ENTP': '話が尽きない刺激的なペア！',
    'INFP-INTP': '繊細さと探究心で静かに盛り上がる！'
  };

  return commentMap[key] || '相手の違いを理解しながら、成長できる関係！';
}
function getDetailData(my, other) {
  const key = [my, other].sort().join('-');

  const detailMap = {
    'INFP-ENFJ': {
      scores: [90, 85, 80, 95, 70],
      texts: [
        '自然体で話せる友達感覚が◎',
        '一緒にいるだけでドキドキできる相性！',
        '共に成長し合える最高の相棒！',
        '価値観が似ていて居心地がとても良い',
        '盛り上がりすぎず、心地よいテンション感'
      ]
    },
    'ENFP-INFJ': {
      scores: [88, 84, 79, 92, 75],
      texts: [
        '直感同士で共鳴しやすく会話が尽きない！',
        'ちょっとした表情でも心を読み取れる仲に',
        '一緒に夢を語れる理想的なコンビ',
        '相手の感情を自然と察し合える関係性',
        '気分の盛り上がり方も波長ピッタリ！'
      ]
    },
    'INTP-ENTP': {
      scores: [78, 70, 85, 80, 82],
      texts: [
        'アイデアが止まらない知的ペア！',
        '一緒に未来の話をするのが楽しい',
        '論理的だけど自由でラフな関係が築ける',
        '無理に干渉しない心地よさが◎',
        'テンションの高さも意外と合う！'
      ]
    },
    'ISFP-ESFJ': {
      scores: [84, 76, 78, 88, 80],
      texts: [
        '内向と外向のバランスが絶妙！',
        '表情やしぐさで通じ合える安心感あり',
        'お互いに支え合いたくなる組み合わせ',
        'ふとした優しさに癒される関係',
        'お互いの違いを楽しめる柔らかペア'
      ]
    },
    'INTJ-ENFP': {
      scores: [82, 79, 90, 76, 74],
      texts: [
        '内向×外向だけど目的意識が合う！',
        '直感派同士で刺激し合える相性',
        'しっかり者と自由人の絶妙コンビ',
        '意外な共通点に驚くことが多いかも？',
        'テンション差も意外と心地よい'
      ]
    },
    'ISTJ-ISFJ': {
      scores: [85, 68, 74, 88, 70],
      texts: [
        '安定感抜群！価値観が近くて安心できる',
        '穏やかな時間を共有できる関係',
        'お互いのペースを大切にできる',
        '日常の小さな幸せを感じやすいペア',
        '派手さはないけど、信頼度は最高'
      ]
    },
    'ENFP-ISTP': {
      scores: [76, 72, 85, 70, 78],
      texts: [
        '性格は真逆だけどなぜか気になる存在',
        '一緒にいると新しい価値観に触れられる',
        'お互いの長所を補える相性',
        'ときに意見がぶつかるけど成長につながる',
        'ノリと冷静さのギャップが面白い！'
      ]
    },
    'ENTJ-INFP': {
      scores: [79, 80, 82, 76, 70],
      texts: [
        '目標に向かって進みたい派と支えたい派',
        '意見の違いも刺激として楽しめる！',
        '対等な立場で尊重し合える関係',
        '弱さを見せても受け入れてもらえる安心感',
        '勢いと優しさのバランスがいい'
      ]
    },
    'ISFP-INFP': {
      scores: [85, 75, 70, 85, 76],
      texts: [
        '感受性が似ていて安心できる相性',
        '空気感で通じ合えるような関係',
        '無理せず自然体でいられるコンビ',
        'ちょっとした仕草にキュンとすることも',
        '静かだけど深いつながりを感じられる'
      ]
    },
    'ESTP-ENFJ': {
      scores: [88, 84, 83, 80, 82],
      texts: [
        'ムードメーカーとリーダーの最強タッグ！',
        'どんな場面でも盛り上がれるコンビ',
        '相手を引っ張る力と支える力の相乗効果',
        '言葉より行動で気持ちが伝わる関係',
        '一緒にイベントや企画も楽しくできる！'
      ]
    },
    'ENFP-ISTJ': {
      scores: [0, 0, 0, 0, 0],
      texts: [
        '自由人と堅実派、価値観がすれ違いがち…！',
        'テンションの差で噛み合わないことも多いかも',
        'でも逆に、お互いにないものを持っている関係！',
        '話し合いが大事になるかもしれない相性！',
        'ここから仲良くなれたら最強説アリ'
      ]
    },
    'ESTJ-INFP': {
      scores: [0, 0, 0, 0, 0],
      texts: [
        '理想と現実が真っ向からぶつかるかも…！？',
        '計画性の違いがすれ違いを生む可能性大',
        '話が噛み合わないことも多いけど、それも個性！',
        '一緒にいると、お互いの価値観を学べる関係かも',
        '逆にここから仲良くなったらドラマチック！？'
      ]
    }
  };

  return detailMap[key] || {
    scores: [72, 72, 72, 72, 72],
    comments: [
      '会話を通じて徐々に打ち解ける関係！',
      'お互いの違いを楽しめる相性！',
      '一緒に新しい発見ができそう！',
      '安心感はこれから作っていく感じ！',
      '刺激より安定感重視な雰囲気！'
    ]
  };
}

function showCompatibilityModal(my, other, message, score) {
  const comment = getCompatibilityComment(my, other); 
  const modal = document.createElement('div');
  modal.id = 'compat-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.8s ease;
  `;

  modal.innerHTML = `
    <div style="
      background: #fff;
      padding: 24px;
      border-radius: 16px;
      font-family: 'Comic Sans MS', cursive;
      text-align: center;
      box-shadow: 0 8px 16px rgba(0,0,0,0.25);
      max-width: 90vw;
      animation: popIn 0.6s ease forwards;
    ">
      <div style="font-size: 20px; font-weight: bold; color: #e91e63; margin-bottom: 6px;">
        2人の相性度
      </div>

      <div style="font-size: 36px; font-weight: bold; color: #ff3366; margin-bottom: 12px;">
        ${score}% 
      </div>

      <div style="font-size: 16px; margin-bottom: 6px;">
        あなた（${my}）とこの人（${other}）の相性は…
      </div>

      <div style="font-size: 20px; color: #e91e63; font-weight: bold; margin-bottom: 8px;">
        ${message}
      </div>

      <div style="font-size: 16px; color: #555; font-style: italic;">
        ${comment}
      </div>

      <div style="margin-top: 24px;">
        <button onclick="document.getElementById('compat-modal').remove()" style="
          padding: 8px 16px;
          background: #ccc;
          color: #333;
          border: none;
          border-radius: 8px;
          cursor: pointer;
        ">閉じる</button>

        <button onclick="showDetailModal('${my}', '${other}')" style="
          margin-left: 12px;
          padding: 8px 16px;
          background: #2196f3;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
        ">詳細を見る</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  // フェードイン
  setTimeout(() => {
    modal.style.opacity = '1';
  }, 50);
}

function getDetailData(my, other) {
  const key = [my, other].sort().join('-');

  const detailMap = {
    'INFP-ENFJ': {
      scores: [90, 85, 80, 95, 70],
      texts: [
        '自然体で話せる友達感覚が◎',
        '一緒にいるだけでドキドキできる相性！',
        '共に成長し合える最高の相棒！',
        '価値観が似ていて居心地がとても良い',
        '盛り上がりすぎず、心地よいテンション感'
      ]
    },
    'ENFP-INFJ': {
      scores: [88, 84, 79, 92, 75],
      texts: [
        '直感同士で共鳴しやすく会話が尽きない！',
        'ちょっとした表情でも心を読み取れる仲に',
        '一緒に夢を語れる理想的なコンビ',
        '相手の感情を自然と察し合える関係性',
        '気分の盛り上がり方も波長ピッタリ！'
      ]
    },
    'INTP-ENTP': {
      scores: [78, 70, 85, 80, 82],
      texts: [
        'アイデアが止まらない知的ペア！',
        '一緒に未来の話をするのが楽しい',
        '論理的だけど自由でラフな関係が築ける',
        '無理に干渉しない心地よさが◎',
        'テンションの高さも意外と合う！'
      ]
    },
    'ISFP-ESFJ': {
      scores: [84, 76, 78, 88, 80],
      texts: [
        '内向と外向のバランスが絶妙！',
        '表情やしぐさで通じ合える安心感あり',
        'お互いに支え合いたくなる組み合わせ',
        'ふとした優しさに癒される関係',
        'お互いの違いを楽しめる柔らかペア'
      ]
    },
    'INTJ-ENFP': {
      scores: [82, 79, 90, 76, 74],
      texts: [
        '内向×外向だけど目的意識が合う！',
        '直感派同士で刺激し合える相性',
        'しっかり者と自由人の絶妙コンビ',
        '意外な共通点に驚くことが多いかも？',
        'テンション差も意外と心地よい'
      ]
    },
    'ISTJ-ISFJ': {
      scores: [85, 68, 74, 88, 70],
      texts: [
        '安定感抜群！価値観が近くて安心できる',
        '穏やかな時間を共有できる関係',
        'お互いのペースを大切にできる',
        '日常の小さな幸せを感じやすいペア',
        '派手さはないけど、信頼度は最高'
      ]
    },
    'ENFP-ISTP': {
      scores: [76, 72, 85, 70, 78],
      texts: [
        '性格は真逆だけどなぜか気になる存在',
        '一緒にいると新しい価値観に触れられる',
        'お互いの長所を補える相性',
        'ときに意見がぶつかるけど成長につながる',
        'ノリと冷静さのギャップが面白い！'
      ]
    },
    'ENTJ-INFP': {
      scores: [79, 80, 82, 76, 70],
      texts: [
        '目標に向かって進みたい派と支えたい派',
        '意見の違いも刺激として楽しめる！',
        '対等な立場で尊重し合える関係',
        '弱さを見せても受け入れてもらえる安心感',
        '勢いと優しさのバランスがいい'
      ]
    },
    'ISFP-INFP': {
      scores: [85, 75, 70, 85, 76],
      texts: [
        '感受性が似ていて安心できる相性',
        '空気感で通じ合えるような関係',
        '無理せず自然体でいられるコンビ',
        'ちょっとした仕草にキュンとすることも',
        '静かだけど深いつながりを感じられる'
      ]
    },
    'ESTP-ENFJ': {
      scores: [88, 84, 83, 80, 82],
      texts: [
        'ムードメーカーとリーダーの最強タッグ！',
        'どんな場面でも盛り上がれるコンビ',
        '相手を引っ張る力と支える力の相乗効果',
        '言葉より行動で気持ちが伝わる関係',
        '一緒にイベントや企画も楽しくできる！'
      ]
    },
    'ENFP-ISTJ': {
      scores: [0, 0, 0, 0, 0],
      texts: [
        '自由人と堅実派、価値観がすれ違いがち…！',
        'テンションの差で噛み合わないことも多いかも',
        'でも逆に、お互いにないものを持っている関係！',
        '話し合いが大事になるかもしれない相性！',
        'ここから仲良くなれたら最強説アリ'
      ]
    },
    'ESTJ-INFP': {
      scores: [0, 0, 0, 0, 0],
      texts: [
        '理想と現実が真っ向からぶつかるかも…！？',
        '計画性の違いがすれ違いを生む可能性大',
        '話が噛み合わないことも多いけど、それも個性！',
        '一緒にいると、お互いの価値観を学べる関係かも',
        '逆にここから仲良くなったらドラマチック！？'
      ]
    }
  };

  return detailMap[key] || {
    scores: [72, 72, 72, 72, 72],
    comments: [
      '会話を通じて徐々に打ち解ける関係！',
      'お互いの違いを楽しめる相性！',
      '一緒に新しい発見ができそう！',
      '安心感はこれから作っていく感じ！',
      '刺激より安定感重視な雰囲気！'
    ]
  };
}


function showDetailModal(myMbti, otherMbti) {
  const modal = document.getElementById('compat-detail-modal');
  modal.style.display = 'flex';

  const ctx = document.getElementById('compat-radar').getContext('2d');
  const data = getDetailData(myMbti, otherMbti);
  const labels = ['仲良し', 'ときめき', '相棒力', '落ち着き', '盛り上がり'];

  if (window.currentRadarChart) {
    window.currentRadarChart.destroy();
  }

  window.currentRadarChart = new Chart(ctx, {
    type: 'radar',
    data: {
      labels: labels,
      datasets: [{
        label: '相性スコア',
        data: data.scores,
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        borderColor: '#e91e63',
        pointBackgroundColor: '#e91e63'
      }]
    },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        r: {
          suggestedMin: 0,
          suggestedMax: 100,
          ticks: { display: false },
          pointLabels: {
            font: { size: 10, family: 'Comic Sans MS' },
            color: '#e91e63',
            padding: 5
          },
          grid: { color: 'rgba(0,0,0,0.1)' },
          angleLines: { display: true }
        }
      }
    }
  });

  const detailText = labels.map((label, i) => `
    <div style="margin-bottom: 16px;">
      <div style="font-weight: bold; color: #e91e63; font-size: 16px;">
        ${label}：${data.scores[i]}%
      </div>
      <div style="color: #555; font-size: 14px;">
        ${data.comments[i]}
      </div>
    </div>
  `).join('');

  const detailBox = document.getElementById('compat-detail-text');
  if (detailBox) {
    detailBox.innerHTML = detailText;
    detailBox.style.textAlign = 'left';
    detailBox.style.paddingLeft = '16px';
  } else {
    console.error('compat-detail-text が見つからなかったよ！');
  }
}

</script>

<!-- ▼ 相性の詳細モーダル -->
<div id="compat-detail-modal" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background-color: rgba(0, 0, 0, 0.7);
  z-index: 10000;
  overflow-y: auto;
  padding: 40px 16px;
  box-sizing: border-box;
  align-items: center;
  justify-content: flex-start;
  flex-direction: column;
">

 <!-- 🔴 チャートボックス -->
<div style="
  background: #ffe6f0;
  border-radius: 20px;
  padding: 32px 20px;
  margin-bottom: 24px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.2);
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: flex-start;  /* ← 中央 → 左上寄せに変更 */
  max-width: 90vw;
  width: 100%;
  min-height: 170px;
  box-sizing: border-box;
">
  <canvas id="compat-radar" width="220" height="220" style="
    display: block;
    transform: translate(80px, 10px);  /* ← これで右下にずれるようになる */
  "></canvas>
</div>

  <!-- 💬 詳細テキスト -->
  <div style="
    background: linear-gradient(to right, #d3f2f9, #fcd8ee);
    border-radius: 24px;
    padding: 12px 20px;
    margin-top: -12px;
    max-width: 360px;
    width: 100%;
    font-family: 'Kosugi Maru', 'Noto Sans JP', sans-serif;
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    color: #333;
    position: relative;
    text-align: left;
  ">
    <!-- ❌ 閉じるボタン -->
    <div onclick="document.getElementById('compat-detail-modal').style.display='none'" style="
      position: absolute;
      top: 12px;
      right: 12px;
      background: #fff;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      color: #e91e63;
    ">×</div>

    <div id="compat-detail-text" style="font-size: 15px;">
      <!-- JavaScriptで内容が入る -->
    </div>
  </div>
</div>


<script>



  // 🔁 プロフ・背景用（透過不要 → JPEG）
  async function compressToJPEG(base64, maxSize = 180) {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL("image/jpeg", 0.6));
      };
      img.src = base64;
    });
  }

  // 🔄 ページ内の画像を送信前に圧縮（base64のまま）
async function compressAllImagesBeforeSend() {
  const imageElements = document.querySelectorAll('img');

  for (const img of imageElements) {
    if (!img.src.startsWith('data:image/')) continue;

   const compressFn = compressToJPEG;

    try {
      const compressed = await compressFn(img.src, 180);
      img.src = compressed;
    } catch (err) {
      console.error('画像の圧縮に失敗しました:', err);
    }
  }
}

</script>

<!-- Chart.js 読み込み -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- ▼ 利用規約モーダル -->
<div id="terms-modal" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background-color: rgba(0,0,0,0.6);
  z-index: 9999;
  padding: 40px 16px;
  box-sizing: border-box;
  justify-content: center;
  align-items: center;
">
  <!-- ✅ 白い規約ボックス -->
  <div style="
    background: white;
    border-radius: 12px;
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    font-size: 14px;
    font-family: sans-serif;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  ">

    <!-- ▼ 規約本文（スクロール可能） -->
    <div style="
      padding: 24px;
      overflow-y: auto;
      max-height: 70vh;
      line-height: 1.8;
    ">
      <h2 style="text-align: center;">利用規約</h2>
      <p>この利用規約（以下「本規約」といいます）は、[サービス名]（以下「本サービス」といいます）を利用する全てのユーザー（以下「ユーザー」といいます）に適用されます。本サービスの利用にあたっては、本規約に同意したものとみなします。</p>

      <p><strong>第1条（適用範囲）</strong><br>本規約は、ユーザーが本サービスを利用する際のすべての行為に適用されます。</p>
      <p><strong>第2条（サービス内容）</strong><br>本サービスは、ユーザーがプロフィール情報や画像等を自由に入力・編集し、名刺風カードを作成・共有するためのWebツールです。</p>
      <p><strong>第3条（禁止事項）</strong><br>
        1. 虚偽の情報を入力する行為<br>
        2. 他者の権利を侵害する行為（著作権、肖像権、商標権など）<br>
        3. わいせつ、暴力的、差別的、その他公序良俗に反する情報の投稿<br>
        4. 本サービスの運営を妨げる行為<br>
        5. 法令違反となる一切の行為
      </p>
      <p><strong>第4条（自己責任）</strong><br>ユーザーは、自らの責任において本サービスを利用するものとし、投稿・入力・生成された内容や第三者との間で生じたトラブル・損害について、当方は一切の責任を負いません。</p>
      <p><strong>第5条（サービスの停止・変更）</strong><br>本サービスは、予告なく内容の変更・停止・終了を行う場合があります。これによりユーザーまたは第三者に損害が発生した場合でも、当方は一切責任を負いません。</p>
      <p><strong>第6条（著作権・知的財産権）</strong><br>本サービスに関連するコンテンツの著作権は、当方または正当な権利を有する第三者に帰属します。ユーザーがアップロード・生成したコンテンツに関しては、当方がサービス運営上の範囲内で使用できるものとします。</p>
      <p><strong>第7条（免責事項）</strong><br>当方は、本サービスに事実上または法律上の瑕疵（安全性、信頼性、正確性、完全性、特定の目的への適合性など）がないことを明示的にも黙示的にも保証しません。また、システム障害や不正アクセス等によって発生した損害についても責任を負いません。</p>
      <p><strong>第8条（個人情報）</strong><br>本サービスは、個人情報の収集・保存は原則として行いません。ただし、必要に応じて保存される情報については、適切に管理し第三者に提供しません。</p>
      <p><strong>第9条（規約の変更）</strong><br>本規約は、当方の判断により変更される場合があります。変更後の規約は、本サービス上に掲載された時点で効力を持ちます。</p>
      <p><strong>第10条（準拠法・管轄）</strong><br>本規約の解釈および適用は日本法に準拠し、本サービスに関連する紛争は、[運営拠点を置く地域]の管轄裁判所を第一審の専属的合意管轄裁判所とします。</p>
      <p><strong>第11条（商用利用の禁止と事前連絡）</strong><br>本サービスは原則として非営利目的での個人利用のみを許可します。企業、法人、団体、またはインフルエンサー等が商用目的で利用する場合は、必ず事前に当方に連絡し、書面等による許可を得なければなりません。無断で商用利用が行われた場合には、当方は利用の差止めや損害賠償請求等の法的措置をとることがあります。</p>

      <p style="text-align: right;">制定日：2025年7月10日</p>
    </div>

   <!-- ✅ 下部ボタンバー -->
    <div style="
      padding: 16px 24px 40px 24px; 
      border-top: 1px solid #ccc;
      background: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 24px;
    ">
      <label style="display: flex; align-items: center; flex: 1;">
        <input type="checkbox" id="agree-checkbox" style="margin-right: 10px;">
        利用規約に同意します
      </label>
  <button onclick="closeTermsModal()" style="
  padding: 10px 20px;
  border-radius: 8px;
  background: linear-gradient(135deg, #ffe6f0, #d6f2f9);
  color: #c2185b;
  font-weight: bold;
  font-family: 'Rounded Mplus 1c', 'Hiragino Maru Gothic ProN', sans-serif;
  border: none;
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  transition: all 0.2s ease-in-out;
  cursor: pointer;
">閉じる</button>
    </div>

  </div>
</div>
<!-- 🌸 利用規約通知モーダル（先に出るやつ） -->
<!-- 🌸 利用規約通知モーダル（先に出るやつ） -->
<div id="terms-notice" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center;">
  <div style="background: #fff0f4; padding: 24px; border-radius: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.2); text-align: center; max-width: 280px;">
    <div style="font-weight: bold; font-size: 18px; margin-bottom: 16px;">利用規約に同意してください。</div>
    <div style="display: flex; justify-content: space-between;">
      <button id="notice-agree-btn" style="flex: 1; margin-right: 10px; background: #ffa5ba; color: white; border: none; border-radius: 8px; padding: 10px 0;">同意する</button>
      <button id="notice-close-btn" style="flex: 1; background: #aaa; color: white; border: none; border-radius: 8px; padding: 10px 0;">閉じる</button>
    </div>
  </div>
</div>


<script>
  function closeTermsModal() {
    document.getElementById('terms-modal').style.display = 'none';
  }

  function showCuteAlert(message) {
    document.getElementById('cute-alert-message').textContent = message;
    document.getElementById('cute-alert').style.display = 'flex';
  }

  function closeCuteAlert() {
    document.getElementById('cute-alert').style.display = 'none';
  }

  document.addEventListener('DOMContentLoaded', () => {
    // 作成ボタン（＝finish-button）を押したとき
    document.getElementById('finish-button').addEventListener('click', () => {
      const checkbox = document.getElementById('agree-checkbox');
      if (checkbox && checkbox.checked) {
        // ✅ チェックが入ってたら直接作成ボタン処理へ（モーダル開かず）
        document.getElementById('terms-modal').style.display = 'none';
        document.getElementById('create-button').click(); // ← 🔴 これが追加された部分！
      } else {
        // ❌ チェックがなければまず通知モーダルを表示
        document.getElementById('terms-notice').style.display = 'flex';
      }
    });

    // 通知モーダルの「同意する」 → 通知閉じて規約モーダル表示
    document.getElementById('notice-agree-btn').addEventListener('click', () => {
      document.getElementById('terms-notice').style.display = 'none';
      document.getElementById('terms-modal').style.display = 'flex';
    });

    // 通知モーダルの「閉じる」 → 通知だけ非表示に
    document.getElementById('notice-close-btn').addEventListener('click', () => {
      document.getElementById('terms-notice').style.display = 'none';
    });
  });
</script>
</div> <!-- 👈 ページ内の最後の </div> の直前とか -->

<div id="text-tools">
  <div class="tool-row">
    <span class="tool-label">色：</span>
    <input type="color" id="text-color-picker" value="#000000" style="width: 30px; height: 30px; border-radius: 50%; border: none;">
  </div>
</div>

<script>
  const colorPicker = document.getElementById("text-color-picker");
  if (colorPicker) {
    colorPicker.addEventListener("input", () => {
      document.querySelectorAll(".text-sticker").forEach(sticker => {
        sticker.style.color = colorPicker.value;
      });
    });
  }

  // 初期設定でフォント適用（ちょい丸み系）
  document.querySelectorAll(".text-sticker").forEach(sticker => {
    sticker.style.fontFamily = "'Rounded Mplus 1c', 'Noto Sans JP', sans-serif";
  });



  
function analyzeSelfPR() {
  const textarea = document.getElementById('self-pr-textarea');
  const text = textarea.value.trim().toLowerCase();
  if (!text) {
    alert('自己PRを入力してください！');
    return;
  }

  const labels = ['勉学', 'スポーツ', 'コミュ力', '創造力', '忍耐力'];
  const baseScore = 70;
  const maxScore = 120;

  // 各項目の初期スコア
  let scores = labels.map(() => baseScore);

 const wordModifiers = {
  '勉学': [
    { word: '学業', value: 10 },
    { word: '勉強', value: 10 },
    { word: '資格', value: 15 },
    { word: '真面目', value: 5 },
    { word: '遅刻', value: -10 },
    { word: '授業', value: 10 },
    { word: '出席', value: 10 },
    { word: 'レポート', value: 5 },
    { word: '予習', value: 10 },
    { word: '復習', value: 10 },
    { word: '努力家', value: 10 },
    { word: '勉学に励む', value: 10 },
    { word: '課題提出', value: 10 },
    { word: 'ゼミ', value: 5 },
    { word: '研究室', value: 10 },
    { word: '成績', value: 10 },
    { word: 'テスト勉強', value: 10 },
    { word: '理解力', value: 10 }
  ],
  'スポーツ': [
    { word: '運動', value: 10 },
    { word: 'スポーツ', value: 15 },
    { word: '部活', value: 10 },
    { word: 'インターハイ', value: 20 },
    { word: '体力がない', value: -10 },
    { word: '体育会', value: 10 },
    { word: '筋トレ', value: 10 },
    { word: '持久力', value: 10 },
    { word: '勝負', value: 5 },
    { word: 'チームプレー', value: 10 },
    { word: '大会', value: 10 },
    { word: '運動習慣', value: 5 },
    { word: '走るのが好き', value: 10 },
    { word: 'スポーツ観戦', value: 5 },
    { word: 'フィジカル', value: 10 },
    { word: '朝練', value: 10 }
  ],
  'コミュ力': [
    { word: '人と話すのが好き', value: 10 },
    { word: '初対面', value: 5 },
    { word: '緊張しやすい', value: -10 },
    { word: '積極的に会話', value: 15 },
    { word: '聞き上手', value: 10 },
    { word: '雑談', value: 5 },
    { word: '会話力', value: 10 },
    { word: '盛り上げ役', value: 10 },
    { word: '空気を読む', value: 10 },
    { word: '話しかける', value: 10 },
    { word: 'コミュニケーションが得意', value: 10 },
    { word: '対話', value: 10 },
    { word: '話すのが苦手', value: -10 },
    { word: '仲間と協力', value: 10 },
    { word: '会話に入れない', value: -5 },
    { word: '司会経験', value: 10 }
  ],
  '創造力': [
    { word: 'アイデア', value: 10 },
    { word: '独自', value: 10 },
    { word: '発想', value: 15 },
    { word: '企画', value: 10 },
    { word: '柔軟な思考', value: 15 },
    { word: '創作', value: 10 },
    { word: '表現', value: 10 },
    { word: 'デザイン', value: 10 },
    { word: '構想', value: 10 },
    { word: '試行錯誤', value: 10 },
    { word: 'ゼロから考える', value: 15 },
    { word: 'ひらめき', value: 10 },
    { word: '発明', value: 10 },
    { word: '創意工夫', value: 15 },
    { word: '自由な発想', value: 10 }
  ],
  '忍耐力': [
    { word: '我慢強い', value: 15 },
    { word: '粘り強い', value: 15 },
    { word: '継続', value: 10 },
    { word: '集中力', value: 10 },
    { word: 'すぐ諦める', value: -15 },
    { word: '負けず嫌い', value: 10 },
    { word: '努力', value: 10 },
    { word: '耐える', value: 10 },
    { word: '失敗しても挑戦', value: 15 },
    { word: 'コツコツ', value: 10 },
    { word: '長期間の取り組み', value: 10 },
    { word: '継続は力なり', value: 15 },
    { word: '精神的にタフ', value: 10 },
    { word: '諦めずに続けた', value: 15 }
  ]
};


  // 補正を加える
  labels.forEach((label, i) => {
    wordModifiers[label].forEach(({ word, value }) => {
      if (text.includes(word)) scores[i] += value;
    });
    if (scores[i] > maxScore) scores[i] = maxScore;
    if (scores[i] < 0) scores[i] = 0;
  });

  const goldData = scores.map(s => s > 100 ? s : 0);

  // コメントテンプレート定義
  const commentTemplates = {
  '勉学': score => {
    if (score >= 100) return '知識の探究者！学びに貪欲で成績優秀！';
    if (score >= 85) return '学ぶ姿勢がしっかりしているタイプ！';
    if (score >= 70) return 'まじめに学業に取り組むタイプ！';
    return '努力次第で大きく伸びるポテンシャルあり！';
  },
  'スポーツ': score => {
    if (score >= 100) return '運動神経抜群！アスリート気質！';
    if (score >= 85) return '身体を動かすのが得意なタイプ！';
    if (score >= 70) return '基本的な運動はこなせるタイプ！';
    return '運動は少し苦手だが努力でカバー！';
  },
  'コミュ力': score => {
    if (score >= 100) return '誰とでも仲良くなれる天才的コミュニケーター！';
    if (score >= 85) return '人との距離を縮めるのが得意！';
    if (score >= 70) return '必要に応じて会話を広げられるタイプ！';
    return '会話はやや苦手だが、誠実に向き合える！';
  },
  '創造力': score => {
    if (score >= 100) return '独創的な発想で周囲を驚かせる発明家！';
    if (score >= 85) return '柔軟で豊かな発想ができるタイプ！';
    if (score >= 70) return '新しいアイデアを出すのが好きなタイプ！';
    return '考える力を磨けば、才能が開花するタイプ！';
  },
  '忍耐力': score => {
    if (score >= 100) return 'どんな困難にも立ち向かう鉄のメンタル！';
    if (score >= 85) return 'コツコツ努力を積み重ねるタイプ！';
    if (score >= 70) return '粘り強く取り組めるタイプ！';
    return '持続力をつければ大きな力に変わる！';
  }
};

  // チャート描画
  if (window.selfPrChart) window.selfPrChart.destroy();
  const ctx = document.getElementById('resultChart').getContext('2d');
  window.selfPrChart = new Chart(ctx, {
    type: 'radar',
    data: {
      labels: labels,
      datasets: [
        {
          label: '分析結果',
          data: scores,
          fill: true,
          borderColor: 'rgba(54, 162, 235, 1)',
          backgroundColor: 'rgba(54, 162, 235, 0.3)',
          pointBackgroundColor: 'rgba(54, 162, 235, 1)'
        },
        {
          label: '100点超え強調',
          data: goldData,
          fill: true,
          borderColor: 'gold',
          backgroundColor: 'rgba(255, 215, 0, 0.4)',
          pointBackgroundColor: 'gold',
          borderWidth: 3
        }
      ]
    },
    options: {
      responsive: false,
      scales: {
        r: {
          min: 0,
          max: 120,
          ticks: {
            stepSize: 20,
            display: false
          }
        }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });
  document.getElementById('self-pr-comment').innerHTML = '';

  let commentHTML = '';
  const addedLabels = new Set(); // 👈 重複防止のためにSetを使う

  labels.forEach((label, i) => {
    if (addedLabels.has(label)) return; // 👈 すでに表示したラベルはスキップ
    addedLabels.add(label);

    const score = scores[i];
    const comment = commentTemplates[label](score);

    const scoreStyle = score > 100
      ? 'color: gold; text-shadow: 0 0 5px gold; font-weight: bold;'
      : '';

    commentHTML += `
      <div style="margin-bottom: 6px;">
        <strong>${label}：</strong><span style="${scoreStyle}">${score}点</span><br>
        <span style="font-size: 14px;">${comment}</span>
      </div>
    `;
  });

  document.getElementById('self-pr-comment').innerHTML = commentHTML;

  // モーダル表示
  document.getElementById('self-pr-modal').style.display = 'flex';
  }
</script>
<script>
  // Enterキーで次の欄へフォーカスを移動（ただし textarea は除く）
  document.addEventListener('DOMContentLoaded', function () {
    const inputs = Array.from(document.querySelectorAll('.editable-text'));

    inputs.forEach((input, index) => {
      input.addEventListener('keydown', function (e) {
        // textarea だったら改行させる（処理しない）
        if (input.tagName.toLowerCase() === 'textarea') return;

        if (e.key === 'Enter') {
          e.preventDefault();
          const next = inputs[index + 1];
          if (next) {
            next.focus();
          }
        }
      });
    });
  });
<!-- 🔽 JavaScriptはこの <script> の中に全部入れる！ -->

document.addEventListener('DOMContentLoaded', () => {
  const isFinalPage = window.location.href.includes('/user_cards/');
  let editMode = !isFinalPage; // 完成ページではfalse、通常ページはtrue

  const editToggle = document.getElementById('edit-toggle');
  const returnToggle = document.getElementById('return-toggle');
  const toolbars = document.querySelectorAll('.toolbar, .text-style-toolbar');
  const deleteButtons = document.querySelectorAll('.sns-delete-btn, .deco-delete-btn, .text-stamp-delete-btn');
  const templateSection = document.querySelector('.deletable-templates');
  const youtubeButton = document.querySelector('.youtube-section button');
  const spotifyButton = document.querySelector('#spotify-section button');
  const youtubeInput = document.getElementById('youtube-url');
  const spotifyInput = document.getElementById('spotify-url');
  const prTemplateSection = document.querySelector('.self-pr-template-section');
  const snsExplain = document.getElementById('sns-explain');
  const updateEditMode = () => {
    toolbars.forEach(el => el.style.display = editMode ? 'flex' : 'none');
    deleteButtons.forEach(el => el.style.display = editMode ? 'block' : 'none');
    if (editToggle) editToggle.src = editMode ? '/static/open_eye.jpeg' : '/static/closed_eye.jpeg';

    if (youtubeButton) youtubeButton.style.display = editMode ? 'block' : 'none';
    if (spotifyButton) spotifyButton.style.display = editMode ? 'block' : 'none';
    if (templateSection) templateSection.style.display = editMode ? 'block' : 'none';
    if (youtubeInput) youtubeInput.style.display = editMode ? 'block' : 'none';
    if (spotifyInput) spotifyInput.style.display = editMode ? 'block' : 'none';
    if (prTemplateSection) prTemplateSection.style.display = editMode ? 'block' : 'none';
    if (snsExplain) snsExplain.style.display = editMode ? 'block' : 'none';
    // 戻るボタンの表示切替
    if (returnToggle) {
      returnToggle.style.display = editMode ? 'none' : 'block';
    }

    // 👇 完成ページだったらアイコンもボタンも全部消す（念のため）
    if (isFinalPage) {
      if (editToggle) editToggle.style.display = 'none';
      if (returnToggle) returnToggle.style.display = 'none';
    }
  };

  // 完成ページではイベント登録も不要
  if (!isFinalPage) {
    editToggle.addEventListener('click', () => {
      editMode = !editMode;
      updateEditMode();
    });

    returnToggle.addEventListener('click', () => {
      editMode = true;
      updateEditMode();
    });
  }

  updateEditMode(); // 初期化
});


</script>

</script>
<!-- 背景画像 -->
<img id="background-img" src="/static/box.jpeg" style="
  display: none;
  position: absolute;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
  z-index: 9990;
">
</div>
<!-- ✅ 画像ボタン（アイコン） -->
<img id="toggle-background-btn" src="/static/box.jpeg" style="
  display: none;
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 48px;
  height: 48px;
  cursor: pointer;
  z-index: 9999;
">


<script>
  document.addEventListener('DOMContentLoaded', () => {
    const toggleBtn = document.getElementById('toggle-background-btn');
    const mainWrapper = document.querySelector('.main-wrapper');
    const backgroundImg = document.getElementById('background-img');
    let showingBackground = false;

    // ✅ 完成ページのときだけボタン表示
    const isFinalPage = window.location.href.includes('/user_cards/');
    if (isFinalPage && toggleBtn) {
      toggleBtn.style.display = 'block';
    }

    toggleBtn?.addEventListener('click', () => {
      showingBackground = !showingBackground;
      if (mainWrapper) mainWrapper.style.display = showingBackground ? 'none' : 'block';
      if (backgroundImg) backgroundImg.style.display = showingBackground ? 'block' : 'none';
      toggleBtn.src = showingBackground ? "/static/box.jpeg" : "/static/box.jpeg";
    });
  });
</script>

</body>
</html>

