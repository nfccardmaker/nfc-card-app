<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ååˆºãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
  html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: 'Helvetica Neue', sans-serif;
  background: linear-gradient(180deg, #ffe4ec, #fff1f7);
  overflow: auto;
}



    body {
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  overflow-x: hidden; /* ğŸ‘ˆ æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ï¼ */
  padding-bottom: 0px; 
}
    .main-wrapper {
      position: relative;
      min-height: 100vh;
      padding-bottom: 140px; /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚’è€ƒæ…® */
      box-sizing: border-box;
    }
    .card {
      width: 90%;
      max-width: 700px;
      margin: 30px auto;
      border: 2px solid #ccc;
      border-radius: 10px;
      background-color: white;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }

   :root {
  --bar-color: #add8e6; /* æœ€åˆã¯æ°´è‰²ã¨ã‹ã§OK */
}

.header-bar {
  background-color: var(--bar-color);  /* â† background-imageã¯ä½¿ã‚ãªã„ */
  height: 40px;
}


    .student-id {
      display: flex;
      flex-direction: row;
      padding: 20px;
      gap: 20px;
    }

    .left-section {
      width: 40%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .left-section img {
      width: 125px;
      height: 125px;
      object-fit: cover;
      border-radius: 15px;
      cursor: pointer;
    }

    .info-section {
      width: 60%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      font-size: 14px;
      line-height: 1.6;
    }

    .editable-text {
  height: 28px;           /* å…¥åŠ›æ¬„ã®é«˜ã•ã‚’æ˜ç¤º */
  line-height: 28px;      /* é«˜ã•ã¨æƒãˆã¦æ–‡å­—ã‚’ä¸­å¤®ã« */
  font-size: 14px;
  border: none;
  background: transparent;
  border-bottom: 1px solid #ccc;
  width: 100%;
  padding: 0;             /* ä¸Šä¸‹ã®ã‚ºãƒ¬ã‚’é˜²ããŸã‚ä½™è¨ˆãªpaddingã¯å‰Šé™¤ */
  box-sizing: border-box;
}

body {
  padding-bottom: 10px;
  box-sizing: border-box;
}

    .toolbar {
  position: fixed;
  bottom: 0; 
  left: 0; 
  right: 0;
  height: 60px;
  background: white;
  border-top: 1px solid #ddd;   /* ä¸Šã«è–„ã„åŒºåˆ‡ã‚Šç·š */
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 1000;
  padding: 0;                  /* â†ä½™ç™½ã‚’æ¶ˆã™ */
  border-radius: 0;            /* â†è§’ä¸¸ã‚’æ¶ˆã™ */
  box-shadow: none;            /* â†å½±ã‚‚æ¶ˆã™ */
}

    .toolbar img {
      width: 40px;
      height: 40px;
      cursor: pointer;
    }

    .toolbar button {
      padding: 4px 12px;
      border: none;
      background: #eee;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }

        .hidden-input {
      opacity: 0;
      position: absolute;
      pointer-events: auto;
    }


    .sns-input {
      margin-left: 36px;
      margin-top: 8px;
      display: none;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 5px 10px;
      width: 220px;
      font-size: 14px;
    }

    .sns-wrapper {
      display: flex;
      flex-direction: column;
    }

    canvas {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 800;
      display: none;
    }

  .text-sticker {
  position: absolute;
  border: none;
  outline: none;
  background: transparent;
  font-size: 16px;
  font-weight: bold;
  pointer-events: auto;
  /* color: black; â† å‰Šé™¤ã‹ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ãã ã•ã„ */
}

.sns-item {
  position: relative; /* ãƒœã‚¿ãƒ³ã‚’ä¸Šã«é‡ã­ã‚‹ãŸã‚ã«å¿…è¦ */
}

.sns-delete-btn {
  position: absolute;
  top: -8px;
  right: -8px;
  width: 18px;
  height: 18px;
  cursor: pointer;
  z-index: 10;
}
#bg-template-list::-webkit-scrollbar {
  display: none;
}
.youtube-section {
  margin-top: 10px;
  margin-bottom: 60px; /* â† è¿½åŠ ï¼ */
  text-align: center;
}
#youtube-url {
  width: 70%;
  max-width: 500px;
  padding: 5px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 14px;
  margin-top: 5px;
}
#youtube-player {
  margin: 0;
  padding: 0;
  line-height: 0;
}
iframe {
  width: 100%;
  height: 200px; /* â† aspect-ratioã¨ä½µç”¨ã›ãšæ˜ç¤ºæŒ‡å®šã§é«˜ã•å›ºå®š */
  border: none;
  margin: 0 auto;
  padding: 0;
}
body {
  box-sizing: border-box;
}
body {
  overscroll-behavior: contain; /* â† iOSã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è·³ã­è¿”ã‚Šã‚’æŠ‘åˆ¶ */
  padding-bottom: 80px;
}
#page-wrapper {
  position: relative;
  min-height: 100vh;
  overflow: visible;
}
#text-tools {
  display: none;
  position: fixed;
  bottom: 80px;
  left: 10px;
  background: #fff;
  padding: 10px 14px;
  border-radius: 12px;
  box-shadow: 0 0 8px rgba(0,0,0,0.1);
  z-index: 9999;
  font-family: 'Rounded Mplus 1c', 'Noto Sans JP', sans-serif;
  width: fit-content;       /* â† ä¸­èº«ã«åˆã‚ã›ã‚‹ */
  max-width: 100vw;         /* â† ã‚¹ãƒãƒ›ã§é£›ã³å‡ºã•ãªã„ã‚ˆã†ä¿é™º */
  box-sizing: border-box;
}

.tool-row {
  display: inline-flex;     /* â† æ¨ªã«è‡ªç„¶ãªå¹…ã ã‘ä½¿ã† */
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.tool-label {
  font-weight: bold;
  font-size: 13px;
  color: #444;
  width: 50px;
}

.tool-input {
  flex: 1;
  font-size: 13px;
}

#text-color-picker {
  width: 30px;
  height: 30px;
  border: none;
  padding: 0;
  background: none;
}

 #edit-toggle.floating-eye {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    width: 40px;
    height: 40px;
  }
  .sns-icon-bar {
  background-color: #ffffffcc;
  border-radius: 12px;
  padding: 8px 12px;
  display: flex;
  justify-content: space-around;
  align-items: center;
  margin: 20px auto;
  max-width: 300px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.sns-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  padding: 4px;
  cursor: pointer;
}

.template-btn {
    font-size: 13px;
    padding: 5px 12px;
    border-radius: 10px;
    background-color: #f8f8ff;
    border: 1px solid #bbb;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
  }

  .template-btn:hover {
    background-color: #ffe066;
    transform: scale(1.05);
  }

  .fade-in {
    animation: fadeIn 0.4s ease-in-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
:root {
  --bar-color: #add8e6;
}

.header-bar {
  background-color: var(--bar-color);
  height: 40px;
  overflow: hidden;
  position: relative;
}

.scrolling-text {
  white-space: nowrap;
  display: inline-block;
  padding-left: 100%;
  animation: scroll-left 12s linear infinite;
  color: white;
  font-weight: bold;
  font-size: 16px;
  line-height: 40px;
  position: absolute;
  top: 0;
  left: 0;
}
/* èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå…¨ç”»é¢å›ºå®šï¼‰ */
#background-img{
  position: fixed; inset: 0;
  width: 100vw; height: 100vh;
  object-fit: cover;
  z-index: 9990;
  display: none;
  pointer-events: none;
}

@keyframes scroll-left {
  0% { transform: translateX(0%); }
  100% { transform: translateX(-100%); }
}
/* â–¼ å…¨ãƒœã‚¿ãƒ³ã«æŠ¼ä¸‹æ™‚ã®æ‹¡å¤§åŠ¹æœ */
button {
  transition: transform 0.12s ease, box-shadow 0.12s ease;
  will-change: transform;
}

button:active {
  transform: scale(1.12);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.18);
}
/* æ—¢å­˜ã® @keyframes glow-temporary ã¯ãã®ã¾ã¾ä½¿ãˆã‚‹ */

#name.glow-once {
  border-radius: 8px; /* å…‰ãŒè§’ã«æ²¿ã†ã‚ˆã†ã« */
  animation: glow-temporary 1.1s ease-in-out 3 !important;
  box-shadow: 0 0 22px #00bfff; /* å¤–å´ã«å…‰ã‚‰ã›ã‚‹æ–¹ãŒè¦‹ãˆã‚„ã™ã„ */
}

.deco-wrapper{
  position: absolute;
  left: 100px; top: 100px;
  transform-origin: center center;
  touch-action: none;
  will-change: transform;
  z-index: 1200;
}
.deco-wrapper.active{
  outline: 2px dashed rgba(80,120,255,.9);
  outline-offset: 2px;
  filter: drop-shadow(0 6px 10px rgba(0,0,0,.12));
}
.deco-wrapper img.deco-img{
  display: block;
  max-width: min(60vw, 420px);
  height: auto;
  user-select: none;
  -webkit-user-drag: none;
  pointer-events: none;  /* ãƒ©ãƒƒãƒ‘ãƒ¼ã§æ“ä½œ */
  background: transparent;
}

/* â†ã“ã“ä¿®æ­£ï¼šãƒ‡ãƒ•ã‚©ã¯éè¡¨ç¤ºã€é¸æŠä¸­(.active)ã§å‡ºã™ */
.deco-del{
  display: none;
  position: absolute;
  top: -10px; right: -10px;
  width: 22px; height: 22px;
  border-radius: 50%;
  background: rgba(0,0,0,.7);
  color: #fff;
  font-size: 14px;
  line-height: 22px;
  text-align: center;
  cursor: pointer;
  user-select: none;
  z-index: 2;
}
.deco-wrapper.active .deco-del{
  display: block;
}
/* ç”»é¢å…¨é¢ã®èƒŒæ™¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
#background-img{
  position: fixed; inset: 0;
  width: 100vw; height: 100vh;
  object-fit: cover;
  z-index: 9990;        /* æœ€å‰é¢ä¸€æ­©æ‰‹å‰ */
  display: none;        /* ãƒˆã‚°ãƒ«ONã§è¡¨ç¤º */
  pointer-events: auto; /* è£ã®UIã‚’æ“ä½œã§ããªã„ã‚ˆã†ã«ã™ã‚‹ */
}

/* box.pngï¼ˆãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ï¼‰ã¯å¸¸ã«æœ€å‰é¢ã«æ®‹ã™ */
.box-toggle{
  position: fixed;
  left: 4px;
  bottom: calc(env(safe-area-inset-bottom, 0px) + 12px); /* â† iPhoneã®ãƒ›ãƒ¼ãƒ ãƒãƒ¼å¯¾ç­– */
  width: 40px; height: 40px;
  z-index: 10002;       /* ã“ã“ãŒä¸€ç•ªä¸Š */
  cursor: pointer;
  user-select: none;
  -webkit-user-drag: none;
}


/* èƒŒæ™¯ã ã‘è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼ˆbodyã«ã‚¯ãƒ©ã‚¹ä»˜ä¸ï¼‰ */
body.background-only #background-img { display: block; }

/* èƒŒæ™¯ä»¥å¤–ã®UIã‚’ä¸€æ‹¬ã§éš ã™ï¼ˆpage-wrapperã”ã¨æ¶ˆã™ã‹ã‚‰æ¥½ï¼‰ */
body.background-only #page-wrapper { display: none !important; }

/* ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã¯å¸¸ã«è¦‹ã›ã‚‹ï¼ˆä¿é™ºï¼‰ */
body.background-only #box-toggle { display: block; }


  </style>
</head>
</head>
<body>
  <!-- ğŸ‘‡ å‰é¢ã«ã‹ã¶ã›ã‚‹èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
  <img id="background-img" alt="" aria-hidden="true" />

  <!-- ğŸ‘‡ ãƒˆã‚°ãƒ«å°‚ç”¨ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ç”¨æ„ -->
  <div id="box-wrapper">
    <img id="box-toggle" src="/static/box.png" alt="èƒŒæ™¯ã ã‘è¡¨ç¤º" class="box-toggle">
  </div>

  <!-- ğŸ‘‡ é€šå¸¸ã®UI -->
  <div id="page-wrapper">
  <div class="main-wrapper">
  <div class="card">
   <div class="header-bar" id="header-bar">
  <input id="scroll-text-input" type="text" placeholder="ãƒãƒ¼ã«è¡¨ç¤ºã™ã‚‹æ–‡å­—ã‚’å…¥åŠ›"
    style="width: 100%; max-width: 100%; height: 40px;
           border: none; background: transparent;
           padding: 0; font-size: 18px;
           position: absolute; top: 0; left: 0;
           transform: none;
           color: white; text-align: center;
           z-index: 2; font-weight: bold;
           font-family: inherit; outline: none;">
  <div class="scrolling-text" id="scrolling-text" style="display: none;"></div>
</div>

    <div class="student-id">
  <div class="left-section">
   <!-- â–¼ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒï¼ˆèƒŒæ™¯ã¨åŒã˜onclickæ–¹å¼ï¼‰ -->
<img src="/static/profile_icon.jpeg"
     id="profile-img"
     alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ"
     style="cursor:pointer;"
     onclick="document.getElementById('profile-input').click()">

<!-- â–¼ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
<input type="file" accept="image/*" id="profile-input" class="hidden-input">

<!-- â–¼ ä¿å­˜ç”¨URL -->
<input type="hidden" id="profile-url">

  </div>

  <div class="info-section">
    <input type="text" id="name" class="editable-text" placeholder="åå‰">
    <input type="text" id="birthday" class="editable-text" placeholder="èª•ç”Ÿæ—¥">
    <input type="text" id="age" class="editable-text" placeholder="å¹´é½¢">
    <input type="text" id="department" class="editable-text" placeholder="å­¦éƒ¨:å­¦ç§‘">
    <input type="text" id="birthplace" class="editable-text" placeholder="å‡ºèº«åœ°">
    <input type="text" id="hobby" class="editable-text" placeholder="è¶£å‘³">
  </div>
</div>

  </div>
<!-- æ¨ªä¸¦ã³ã®SNSã‚¢ã‚¤ã‚³ãƒ³ãƒãƒ¼ -->
<div class="sns-icon-bar" style="
  width: 90vw;
  max-width: 500px;
  margin: 20px auto;
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 10px 14px;
  border-radius: 14px;
  background-color: #ffffffcc;
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
  box-sizing: border-box;
">
  <img src="/static/instagram_icon.jpeg" alt="Instagram" class="sns-icon" onclick="handleIconClick('instagram')" style="width: 32px; height: 32px;">
  <img src="/static/Line.icon.jpeg" alt="LINE" class="sns-icon" onclick="handleIconClick('line')" style="width: 32px; height: 32px;">
  <img src="/static/BeReal.icon.jpeg" alt="BeReal" class="sns-icon" onclick="handleIconClick('bereal')" style="width: 32px; height: 32px;">
  <img src="/static/X_icon.jpeg" alt="X" class="sns-icon" onclick="handleIconClick('x')" style="width: 32px; height: 32px;">
  <img src="/static/tiktok_icon.jpeg" alt="TikTok" class="sns-icon" onclick="handleIconClick('tiktok')" style="width: 32px; height: 32px;">
</div>
<div id="sns-explain" style="
  font-size: 12.5px;
  color: #777;
  text-align: center;
  margin-top: 12px;
  margin-bottom: 16px;
  line-height: 1.6;
">
  ã‚¢ã‚¤ã‚³ãƒ³ã‚’æŠ¼ã™ã¨å…¬å¼ãƒšãƒ¼ã‚¸ã¸ï¼<br>
  URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«ç™»éŒ²ã—ã‚ˆã†
</div>


<!-- å„SNSã®å…¥åŠ›æ¬„ï¼ˆéè¡¨ç¤ºï¼‰ -->
<div class="sns-inputs">
  <input id="input-instagram" class="sns-input" placeholder="https://www.instagram.com/yourid" onblur="handleBlur('instagram')">
  <input id="input-line" class="sns-input" placeholder="https://lin.ee/yourid" onblur="handleBlur('line')">
  <input id="input-bereal" class="sns-input" placeholder="https://bere.al/yourid" onblur="handleBlur('bereal')">
  <input id="input-x" class="sns-input" placeholder="https://twitter.com/yourid" onblur="handleBlur('x')">
  <input id="input-tiktok" class="sns-input" placeholder="https://www.tiktok.com/@yourid" onblur="handleBlur('tiktok')">
</div>




<!-- â–¼ YouTubeå…¥åŠ›æ¬„ -->
<div class="youtube-section" style="position: relative; margin-top: 20px;">
  <img src="/static/batu.jpeg" alt="å‰Šé™¤" class="sns-delete-btn" onclick="hideYouTubeSection()" style="
    position: absolute;
    top: 13px;
    right: 20px;
    width: 18px;
    height: 18px;
    cursor: pointer;
    z-index: 10;
  ">

  <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
  <div id="youtube-player" style="padding: 0; text-align: center;"></div>
<!-- â–¼ YouTubeè¦‹å‡ºã—ï¼ˆãƒªãƒ³ã‚¯åŒ–ï¼‹èµ¤ï¼‰ -->
<div style="font-weight: bold; font-size: 14px; margin-bottom: 6px; text-align: left; padding-left: 5vw;text-decoration: underline; /* âœ… è¦‹ãŸç›®ã§ã€Œãƒªãƒ³ã‚¯ã«ãªã‚‹æ„Ÿã€å‡ºã™ */">
  <a href="https://www.youtube.com" target="_blank" style="color: red; text-decoration: none;">
    YouTube URL
  </a><br>
  <span style="font-size: 12px; color: #555;"></span>
</div>

  <!-- å…¥åŠ›æ¬„ -->
  <input type="text" id="youtube-url" placeholder="YoutubeURLã‚’å…¥åŠ›"
    style="
      width: 90vw;
      max-width: 650px;
      padding: 14px 18px;
      border: 1px solid #ccc;
      border-radius: 14px;
      font-size: 16px;
      display: block;
      margin: 0 auto 12px auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      box-sizing: border-box;
      
    ">

  <!-- ä¸­å¤®å¯„ã›ãƒœã‚¿ãƒ³ -->
  <button onclick="embedYouTubeVideo()" style="
    display: block;
    margin: 0 auto 10px auto;
    padding: 10px 20px;
    font-size: 15px;
    border-radius: 10px;
    background: rgb(255, 224, 136); 
    color: black;
border: none;
box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  ">
    åæ˜ 
  </button>
</div>

<!-- â–¼ SpotifyåŸ‹ã‚è¾¼ã¿æ¬„ -->
<div id="spotify-section" class="spotify-section" style="position: relative; margin-top: -40px;">
  <!-- âœ• ãƒœã‚¿ãƒ³ -->
  <img src="/static/batu.jpeg" alt="å‰Šé™¤" class="sns-delete-btn" onclick="hideSpotifySection()" style="
    position: absolute;
    top: 30px;
    right: 20px;
    width: 18px;
    height: 18px;
    cursor: pointer;
    z-index: 10;
  ">

  <!-- åŸ‹ã‚è¾¼ã¿ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å…ˆã« -->
  <div id="spotify-player" style="padding: 0; text-align: center;"></div>

<!-- â–¼ Spotifyè¦‹å‡ºã—ï¼ˆãƒªãƒ³ã‚¯åŒ–ï¼‹ç·‘ï¼‹ä¸‹ç·šï¼‰ -->
<div style="font-weight: bold; font-size: 14px; margin-bottom: 6px; text-align: left; padding-left: 5vw;">
  <a href="https://open.spotify.com" target="_blank" style="color: green; text-decoration: underline;">
    Spotify URL
  </a><br>
  <span style="font-size: 12px; color: #555;">ï¼ˆæ¥½æ›²/ã‚¢ãƒ«ãƒãƒ /ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆï¼‰</span>
</div>


  <!-- å…¥åŠ›æ¬„ -->
  <input type="text" id="spotify-url" placeholder="Spotifyã®URLã‚’å…¥åŠ›"
    style="
      width: 90vw;
      max-width: 650px;
      padding: 14px 18px;
      border: 1px solid #ccc;
      border-radius: 14px;
      font-size: 16px;
      display: block;
      margin: 0 auto 12px auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      box-sizing: border-box;
    ">

  <!-- åæ˜ ãƒœã‚¿ãƒ³ï¼ˆä¸­å¤® & è‡ªå·±PRã®ãƒœã‚¿ãƒ³ã¨æƒãˆã‚‹ï¼‰ -->
<button onclick="embedSpotify()" style="
  display: block;
  margin: 0 auto 10px auto;
  padding: 10px 20px;
  font-size: 15px;
  border-radius: 10px;
  background: rgb(255, 224, 136); /* ã‚µãƒ–1ã®é»„è‰² */
  color: black;
  border: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
">
  åæ˜ 
</button>




  <canvas id="draw-canvas"></canvas>
  <input type="file" id="background-input" class="hidden-input" accept="image/*" onchange="loadBackgroundImage(event)">
  <input type="color" id="color-picker" class="hidden-input" onchange="changeBarColor(event)">
<button id="finish-button" style="
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #eee;
  border: none;
  padding: 6px 16px;
  font-size: 16px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  z-index: 1001;
  cursor: pointer;
  display: none;
">
  ä½œæˆ
</button>
<div class="toolbar" id="toolbar">
  <img src="/static/upload.jpeg" onclick="toggleBackgroundList()">

  <!-- ä¿®æ­£: ä»–ã¨åŒã˜å½¢å¼ã§ã‚¢ã‚¤ã‚³ãƒ³åŒ– -->
  <img id="deco-photo-btn" src="/static/icon-deco-photo.png"
       style="width: 28px; height: 28px; cursor: pointer;" 
       alt="ãƒ‡ã‚³ã‚Šå†™çœŸ">
<!-- ãƒ‡ã‚³å†™çœŸé¸æŠinputï¼ˆéè¡¨ç¤ºï¼‰ -->
<input type="file" id="deco-photo-input" accept="image/*" style="display:none;">

  <div style="position: relative; width: 28px; height: 28px;">
    <img src="/static/student.jpeg" style="width: 100%; height: 100%; cursor: pointer;">
    <input type="color" id="color-picker"
           style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                  opacity: 0; cursor: pointer;"
           onchange="changeBarColor(event)">
  </div>

  <img src="/static/restore.jpeg" onclick="restoreSNS()" style="width: 28px; height: 28px; cursor: pointer;">

  <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼å†…ã®ç¢ºèªãƒœã‚¿ãƒ³ã®å·¦ã‚ãŸã‚Šã«è¿½åŠ  -->
  <img id="edit-toggle" src="/static/open_eye.jpeg"
       style="width: 28px; height: 28px; cursor: pointer;" alt="ç·¨é›†åˆ‡æ›¿">

  <button onclick="togglePreview()" id="check-button">ç¢ºèª</button>
</div>

<img id="return-toggle" src="/static/closed_eye.jpeg"
     style="width: 50px; height: 50px; position: fixed; bottom: 20px; right: 20px;
            cursor: pointer; display: none; z-index: 9999;
            border-radius: 50%; background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
            animation: pulse 2s infinite;" alt="æˆ»ã‚‹">


  <script>
    const urls = { instagram: '', x: '', tiktok: '' };
    const canvas = document.getElementById('draw-canvas');
    const ctx = canvas.getContext('2d');
  function togglePreview() {
  const toolbar = document.getElementById('toolbar');
  const finalBtn = document.getElementById('finish-button');

  toolbar.style.display = 'none';
  finalBtn.style.display = 'block';
}
 let drawing = false, drawEnabled = false;
let paths = [], currentPath = [];

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  redraw();
}

window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function redraw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = '#000';
  ctx.lineWidth = 2;
  for (const path of paths) {
    ctx.beginPath();
    path.forEach(([x, y], i) => i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y));
    ctx.stroke();
  }
  if (currentPath.length) {
    ctx.beginPath();
    currentPath.forEach(([x, y], i) => i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y));
    ctx.stroke();
  }
}

canvas.addEventListener('mousedown', e => {
  if (!drawEnabled) return;
  drawing = true;
  currentPath = [[e.offsetX, e.offsetY]];
});

canvas.addEventListener('mousemove', e => {
  if (!drawing || !drawEnabled) return;
  currentPath.push([e.offsetX, e.offsetY]);
  redraw();
});

canvas.addEventListener('mouseup', () => {
  if (!drawing || !drawEnabled) return;
  drawing = false;
  paths.push(currentPath);
  currentPath = [];
});

function toggleTextMode() {
  drawEnabled = !drawEnabled;
  canvas.style.display = drawEnabled ? 'block' : 'none';
  const icon = document.getElementById('text-toggle-icon');
  icon.src = drawEnabled ? '/static/pen_on.jpeg' : '/static/pen_off.jpeg';
}

function loadBackgroundImage(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    document.body.style.backgroundImage = `url('${reader.result}')`;
  };
  reader.readAsDataURL(file);
}

function changeBarColor(e) {
  document.documentElement.style.setProperty('--bar-color', e.target.value);
}

// SNSã‚¯ãƒªãƒƒã‚¯çŠ¶æ…‹ä¿æŒ
const iconClickState = Object.fromEntries(['instagram','line','bereal','x','tiktok'].map(k => [k,false]));
const defaultLinks = {
  instagram: "https://www.instagram.com",
  line: "https://line.me",
  bereal: "https://bere.al",
  x: "https://twitter.com",
  tiktok: "https://www.tiktok.com"
};

// 1å›ç›®ã¯å…¬å¼ã€2å›ç›®ä»¥é™ã¯å…¥åŠ›æ¬„
window.handleIconClick = function(service) {
  const input = document.getElementById(`input-${service}`);
  if (!input) return;

  if (!iconClickState[service]) {
    iconClickState[service] = true;
    window.open(defaultLinks[service], '_blank', 'noopener');
  } else {
    input.style.display = "block";
    input.focus();
  }
};

// å…¥åŠ›æ¬„ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¤–ã‚Œæ™‚ã«ä¿å­˜
window.handleBlur = async function(service) {
  const input = document.getElementById(`input-${service}`);
  if (!input) return;
  const value = (input.value || "").trim();

  // ãƒ¡ãƒ¢ãƒªã«ä¿å­˜ï¼ˆsnsLinksãŒã‚ã‚Œã°ãã“ã«ï¼‰
  if (typeof snsLinks === 'object') {
    snsLinks[service] = value;
  }

  // å†ç·¨é›†ä¸­ãªã‚‰Firestoreã«ã‚‚å³ä¿å­˜
  if (typeof __currentId === 'string' && __currentId) {
    try {
      await setDoc(doc(db, 'cards', __currentId), { [service]: value }, { merge: true });
      L?.('sns.autosave', { service, value });
    } catch (e) {
      W?.('sns.autosave.fail', e);
    }
  }

  input.style.display = 'none';
};

// ãƒ‡ãƒ¢ç”¨ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–¢æ•°ï¼ˆå¿…è¦ãªã‚‰æ®‹ã™ï¼‰
window.downloadCard = function() {
  alert("ã“ã®éƒ¨åˆ†ã§ç”»åƒåŒ–ï¼†ZIPåŒ–ãªã©ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™");
};

window.onload = () => {
  // canvasãŒç„¡ã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã“ã“ã§æ­»ã¬ã¨å…¨éƒ¨å‹•ã‹ãªããªã‚‹ï¼‰
  const canvasEl = document.querySelector('canvas');
  if (canvasEl) canvasEl.style.display = 'none';

  const profileImg   = document.getElementById("profile-img");
  const profileInput = document.getElementById("profile-input");

  if (!profileImg || !profileInput) {
    console.warn('profile elements missing');
    return;
  }

  // ç”»åƒã‚¿ãƒƒãƒ— â†’ é–‹ãç›´å‰ã« value=''ï¼ˆiOSã§åŒã˜ç”»åƒã§ã‚‚changeã‚’å‡ºã™ï¼‰
  function openPicker() {
    profileInput.value = '';
    if (profileInput.showPicker) profileInput.showPicker(); // iOSã§å®‰å®š
    else profileInput.click();
  }

  // ãƒ¢ãƒã‚¤ãƒ«ã§ã‚‚æ‹¾ãˆã‚‹ã‚ˆã†ã« click/touchend ä¸¡æ–¹
  profileImg.addEventListener("click", openPicker);
  profileImg.addEventListener("touchend", (e) => { e.preventDefault(); openPicker(); }, { passive: false });

  profileInput.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = () => {
      const base64Data = reader.result;
      profileImg.src = base64Data;

      fetch('/upload_profile_image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: base64Data })
      })
      .then(r => r.json())
      .then(data => console.log('âœ… ä¿å­˜æˆåŠŸ:', data))
      .catch(err => console.error('âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—:', err))
      .finally(() => { e.target.value = ''; }); // â† é€£ç¶šé¸æŠOK
    };

    reader.onerror = () => {
      console.error('âŒ FileReaderå¤±æ•—:', reader.error);
    };

    reader.readAsDataURL(file);
  });
};


let textEnabled = false;
let textFirstTapDone = false;

document.getElementById("text-toggle-icon").addEventListener("click", () => {
  textEnabled = !textEnabled;
  textFirstTapDone = false;

  const toolsPanel = document.getElementById("text-tools");
  toolsPanel.style.display = textEnabled ? "block" : "none";

  const icon = document.getElementById("text-toggle-icon");
  icon.src = textEnabled ? "/static/pen_on.jpeg" : "/static/pen_off.jpeg";
});

document.body.addEventListener("click", (e) => {
  if (!textEnabled) return;

  if (!textFirstTapDone) {
    textFirstTapDone = true;
    return;
  }

  if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA" || e.target.tagName === "SELECT") return;

  const margin = 20;
  const inputWidth = 150;
  const maxX = window.innerWidth - inputWidth - margin;
  const x = Math.min(e.pageX, maxX);
  const y = e.pageY;

  const input = document.createElement("input");
  input.type = "text";
  input.placeholder = "ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›";
  input.className = "text-sticker";
  input.style.position = "absolute";
  input.style.left = `${x}px`;
  input.style.top = `${y}px`;
  input.style.width = '150px';
  input.style.maxWidth = 'calc(100vw - 40px)';

  const textColorPicker = document.getElementById("text-color-picker");
  const fontSelector = document.getElementById("font-selector");
  const fontSizeSlider = document.getElementById("font-size-slider");

  if (textColorPicker) input.style.setProperty('color', textColorPicker.value, 'important');
  if (fontSelector) input.style.fontFamily = fontSelector.value;
  if (fontSizeSlider) input.style.fontSize = fontSizeSlider.value + "px";

  const container = document.getElementById('page-wrapper');
  container.appendChild(input);

  input.addEventListener("blur", () => {
    if (input.value.trim() === "") {
      input.remove();
    }
  });
  input.focus();

  let offsetX, offsetY, dragging = false;

  input.addEventListener("mousedown", (ev) => {
    dragging = true;
    offsetX = ev.offsetX;
    offsetY = ev.offsetY;
  });

  document.addEventListener("mousemove", (ev) => {
    if (!dragging) return;
    input.style.left = `${ev.pageX - offsetX}px`;
    input.style.top = `${ev.pageY - offsetY}px`;
  });

  document.addEventListener("mouseup", () => {
    dragging = false;
  });

  let longPressTimer;
  input.addEventListener("touchstart", () => {
    longPressTimer = setTimeout(() => {
      input.remove();
    }, 1000);
  });

  input.addEventListener("touchend", () => {
    clearTimeout(longPressTimer);
  });
});

// âœ… ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ 
const textColorPicker = document.getElementById("text-color-picker");
const fontSelector = document.getElementById("font-selector");
const fontSizeSlider = document.getElementById("font-size-slider");

function applyTextStyles() {
  document.querySelectorAll(".text-sticker").forEach(input => {
    if (textColorPicker) input.style.color = textColorPicker.value;
    if (fontSelector) input.style.fontFamily = fontSelector.value;
    if (fontSizeSlider) input.style.fontSize = fontSizeSlider.value + "px";
  });
}
if (textColorPicker) textColorPicker.addEventListener("input", applyTextStyles);
if (fontSelector) fontSelector.addEventListener("change", applyTextStyles);
if (fontSizeSlider) fontSizeSlider.addEventListener("input", applyTextStyles);


function toggleBackgroundList() {
  const list = document.getElementById('bg-template-list');
  list.style.display = (list.style.display === 'none' || list.style.display === '') ? 'flex' : 'none';
}

function setBackground(url) {
  document.body.style.backgroundImage = `url('${url}')`;
  document.getElementById('bg-template-list').style.display = 'none';
}
function hideAddLink(event) {
  event.stopPropagation(); // ã€ŒshowHiddenSNS()ã€ãŒå‹•ã‹ãªã„ã‚ˆã†ã«
  const addBtn = document.getElementById('add-link-button');
  if (addBtn) addBtn.style.display = 'none';
}

function restoreSNS() {
  ['instagram', 'line', 'bereal', 'x', 'tiktok'].forEach(service => {
    const wrapper = document.querySelector(`.sns-wrapper:has(#input-${service})`);
    if (wrapper) wrapper.style.display = 'flex';
  });

  const addBtn = document.getElementById('add-link-button');
  if (addBtn) addBtn.style.display = 'flex';
  const extraTextWrapper = document.getElementById('extra-text-wrapper');
  if (extraTextWrapper) extraTextWrapper.style.display = 'block';
  const youtubeSection = document.querySelector('.youtube-section');
  if (youtubeSection) youtubeSection.style.display = 'block';
  const diagnosisWrapper = document.getElementById("diagnosis-wrapper");
  if (diagnosisWrapper) diagnosisWrapper.style.display = "block";
  const spotifySection = document.getElementById('spotify-section');
  if (spotifySection) spotifySection.style.display = 'block';
  const selfPR = document.getElementById('self-pr-section');
  if (selfPR) selfPR.style.display = 'block';
}

function hideExtraText() {
  const wrapper = document.getElementById('extra-text-wrapper');
  if (wrapper) wrapper.style.display = 'none';
}

function hideDiagnosisButton() {
  const diagnosisWrapper = document.getElementById("diagnosis-wrapper");
  if (diagnosisWrapper) diagnosisWrapper.style.display = "none";
}

function restoreDiagnosisButton() {
  const diagnosisWrapper = document.getElementById("diagnosis-wrapper");
  if (diagnosisWrapper) diagnosisWrapper.style.display = "block";
}

/* â–¼ ãƒã‚°ä¿®æ­£ï¼šéš ã™æ™‚ã¯ 'none' */
function hideSpotifySection() {
  const section = document.getElementById('spotify-section');
  if (section) section.style.display = 'none';
}
function restoreSpotifySection() {
  const section = document.getElementById('spotify-section');
  if (section) section.style.display = 'block';
}

function hideSelfPRSection() {
  const section = document.getElementById('self-pr-section');
  if (section) section.style.display = 'none';
}
function restoreSelfPRSection() {
  const section = document.getElementById('self-pr-section');
  if (section) section.style.display = 'block';
}

document.getElementById('finish-button').addEventListener('click', async () => {
  const finishBtn = document.getElementById('finish-button');
  const checkbox = document.getElementById('agree-checkbox');
  if (!checkbox.checked) {
    showCuteAlert('åˆ©ç”¨è¦ç´„ã«åŒæ„ã—ã¦ãã ã•ã„ã€‚');
    document.getElementById('terms-modal').style.display = 'flex';
    return;
  }

  finishBtn.disabled = true;
  finishBtn.textContent = 'ç”Ÿæˆä¸­...';
  await compressAllImagesBeforeSend();
  document.querySelectorAll('#background-list img').forEach(img => {
    img.remove();
  });

  function escapeHTML(str) {
    return str.replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#39;");
  }

  const editableTexts = document.querySelectorAll('.editable-text, textarea');
  editableTexts.forEach(input => {
    const val = input.value.trim();
    input.setAttribute('value', escapeHTML(val));
    if (input.tagName === 'TEXTAREA') {
      input.textContent = escapeHTML(val);
    }
  });
  editableTexts.forEach((input) => {
    input.setAttribute('value', input.value.trim());
  });

  const extraInput = document.getElementById('extra-text');
  if (extraInput) {
    const text = extraInput.value.trim();
    extraInput.setAttribute('value', text);

    let hidden = document.getElementById('hidden-extra-text');
    if (!hidden) {
      hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.id = 'hidden-extra-text';
      hidden.name = 'extra-text';
      extraInput.parentNode.appendChild(hidden);
    }
    hidden.value = text;
    extraInput.textContent = text;
  }

  /* ========= ã“ã“ã‹ã‚‰ã€Œéš ã™ç³»ã€ =========
     ä½œæˆç”»é¢ã§ã¯éå®Ÿè¡Œã€‚id ãŒä»˜ã„ã¦ã„ã‚‹ & /preview or /user_cards ã®ã¨ãã ã‘éš ã™
  */
  const hasId = new URLSearchParams(location.search).has('id');
  const path  = location.pathname || '';
  const isViewPage = hasId && (path.startsWith('/preview') || path.startsWith('/user_cards/'));

  if (isViewPage) {
    const toolbar = document.getElementById('toolbar');
    if (toolbar) toolbar.style.display = 'none';

    const youtubeBatsu = document.querySelector('.youtube-section .sns-delete-btn');
    if (youtubeBatsu) youtubeBatsu.style.display = 'none';

    const youtubeInput = document.getElementById('youtube-url');
    const youtubeButton = document.querySelector('.youtube-section button');
    if (youtubeInput) youtubeInput.style.display = 'none';
    if (youtubeButton) youtubeButton.style.display = 'none';

    const spotifyInput = document.getElementById('spotify-url');
    const spotifyButton = document.querySelector('#spotify-section button');
    if (spotifyInput) spotifyInput.style.display = 'none';
    if (spotifyButton) spotifyButton.style.display = 'none';

    const templateButton = document.querySelector('.deletable-templates');
    if (templateButton) templateButton.style.display = 'none';

    const selfPRTemplateButton = document.querySelector('.self-pr-template-section');
    if (selfPRTemplateButton) selfPRTemplateButton.style.display = 'none';

    const extraBatsu = document.querySelector('#extra-text-wrapper .sns-delete-btn');
    if (extraBatsu) extraBatsu.style.display = 'none';
    const diagnosisBatsu = document.querySelector('#diagnosis-wrapper .sns-delete-btn');
    if (diagnosisBatsu) diagnosisBatsu.style.display = 'none';
    const externalBatsu = document.querySelector('#external-link-section .sns-delete-btn');
    if (externalBatsu) externalBatsu.style.display = 'none';
    const spotifyBatsu = document.querySelector('#spotify-section .sns-delete-btn');
    if (spotifyBatsu) spotifyBatsu.style.display = 'none';
    const selfPRBatsu = document.querySelector('#self-pr-section .sns-delete-btn');
    if (selfPRBatsu) selfPRBatsu.style.display = 'none';
    const snsExplain = document.getElementById('sns-explain');
    if (snsExplain) snsExplain.style.display = 'none';
  }
  /* ========= ã“ã“ã¾ã§ ========= */

  // ã‚¢ã‚¤ã‚³ãƒ³ã® <a> ç½®æ›ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å´ã§ã‚„ã‚‹ã®ãŒç¶ºéº—ã ãŒã€
  // ã‚‚ã—ã“ã“ã§å¿…è¦ãªã‚‰åŒæ§˜ã« isViewPage æ¡ä»¶ã§å®Ÿè¡Œ
  if (isViewPage) {
    ['instagram', 'line', 'bereal', 'x', 'tiktok'].forEach(service => {
      const url = (window.urls && window.urls[service]) || '';
      if (url) {
        const icon = document.querySelector(`.sns-icon-bar img[onclick*="${service}"]`);
        if (icon) {
          const linkWrapper = document.createElement('a');
          linkWrapper.href = url;
          linkWrapper.target = '_blank';
          linkWrapper.appendChild(icon.cloneNode(true));
          icon.replaceWith(linkWrapper);
        }
      }
    });
  }

  const profileImg = document.getElementById("profile-img");
  if (profileImg && profileImg.src.startsWith("blob:")) {
    profileImg.src = "/static/uploads/profile.jpeg";
  }
  if (profileImg && profileImg.src.startsWith("data:image/")) {
    profileImg.src = await compressImage(profileImg.src);
  }

  finishBtn.style.display = 'none';
});


  /* ä»¥ä¸‹ã®å‡¦ç†ã¯HTMLç”Ÿæˆã®æ—§ä»•æ§˜ã¨ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆä¸­

  const html = document.documentElement.outerHTML;

  const cleanedHTML = html.replace(/<img[^>]+src="data:image\/[^\"]+"[^>]*>/g, (match) => {
    if (match.includes('id="profile-img"') || match.includes('class="deco-img"')) {
      return match;
    } else {
      return match.replace(/src="data:image\/[^\"]+"/, 'src="/static/deleted_image.jpeg"');
    }
  });

  const formData = new FormData();
  formData.append('html', cleanedHTML);

  const res = await fetch('/generate_url', {
    method: 'POST',
    body: formData
  });

  const data = await res.json();
  if (data.url) {
    finishBtn.textContent = 'ç”Ÿæˆå®Œäº†';
    finishBtn.style.display = 'block';

    const output = document.createElement('div');
    output.id = 'shared-url-box';
    output.innerHTML = `<p>ã“ã®URLã‚’å…±æœ‰ã§ãã¾ã™ğŸ‘‡</p><a href="${data.url}" target="_blank">${data.url}</a>`;
    output.style.cssText = `...`;
    document.body.appendChild(output);

    setTimeout(() => {
      const box = document.getElementById('shared-url-box');
      if (box) box.remove();
    }, 600000);
  } else {
    alert('URLã®ç™ºè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ');
    finishBtn.disabled = false;
    finishBtn.textContent = 'å®Œæˆ';
    finishBtn.style.display = 'block';
  }

  */

function showTemplateButtons() {
  const btns = document.getElementById('template-buttons');
  btns.style.display = 'flex';
}
function insertTemplate(type) {
  const textarea = document.getElementById("extra-text");
  let template = "";

switch(type) {
  case 'club':
    template = "é«˜æ ¡ã§ã¯ã€‡ã€‡éƒ¨ã«æ‰€å±ã—ã¦ã„ã¾ã—ãŸã€‚æ”¾èª²å¾Œã¯éƒ¨æ´»ä¸­å¿ƒã®ç”Ÿæ´»ã§ã€è‰¯ã„çµŒé¨“ã«ãªã£ãŸã¨æ€ã„ã¾ã™ã€‚";
    break;

  case 'study':
    template = "å¤§å­¦ã§ã¯ã€‡ã€‡ã‚’å­¦ã‚“ã§ã„ã¾ã™ã€‚èª²é¡Œã¯ã‚ã‚Šã¾ã™ãŒã€èˆˆå‘³ã‚’æŒã£ã¦å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚";
    break;

  case 'circle':
    template = "ã€‡ã€‡ç³»ã®ã‚µãƒ¼ã‚¯ãƒ«ã«å‚åŠ ã—ã¦ã„ã¾ã™ã€‚ã‚¤ãƒ™ãƒ³ãƒˆã‚„æ´»å‹•ã‚’é€šã˜ã¦ã€å‹äººã¨æ¥½ã—ãéã”ã—ã¦ã„ã¾ã™ã€‚";
    break;

  case 'parttime':
    template = "ã€‡ã€‡ã§ã‚¢ãƒ«ãƒã‚¤ãƒˆã‚’ã—ã¦ã„ã¾ã™ã€‚æ¥å®¢ã‚„ä»•äº‹ã‚’é€šã˜ã¦ã€å­¦ã¶ã“ã¨ã‚‚å¤šã„ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚";
    break;

  case 'hobby':
    template = "è¶£å‘³ã¯ã€‡ã€‡ã§ã€ç©ºã„ãŸæ™‚é–“ã«ã‚ˆãæ¥½ã—ã‚“ã§ã„ã¾ã™ã€‚åŒã˜è¶£å‘³ã®äººã¨è©±ã™ã®ã‚‚å¥½ãã§ã™ã€‚";
    break;
}


  // textareaã«åæ˜ 
  textarea.value = template + '\n\nâ¸»\n\n';

  // ğŸ”½ Firestoreã«å³ä¿å­˜ï¼ˆidãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
  if (typeof db !== 'undefined' && typeof id !== 'undefined' && id) {
    setDoc(doc(db, "cards", id), { extraText: textarea.value }, { merge: true });
  }
}

function showTemplateButtons() {
  const btns = document.getElementById('template-buttons');
  if (btns.style.display === 'flex') {
    btns.style.display = 'none';
  } else {
    btns.style.display = 'flex';
  }

  // âœ… ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«fade-inã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  const textarea = document.getElementById("extra-text"); // â† å®Ÿåœ¨ã™ã‚‹IDã«ä¿®æ­£ï¼
  if (textarea) {
    textarea.classList.remove("fade-in");
    void textarea.offsetWidth; // â† ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å†é©ç”¨
    textarea.classList.add("fade-in");
  }
}

function showPRTemplateButtons() {
  const btnArea = document.getElementById('pr-template-buttons');
  btnArea.style.display = btnArea.style.display === 'flex' ? 'none' : 'flex';
}

function showPRTemplateButtons() {
  const btnArea = document.getElementById('pr-template-buttons');
  btnArea.style.display = btnArea.style.display === 'flex' ? 'none' : 'flex';
}

function insertPRTemplate(category) {
  const prTemplates = {
    study: "å‹‰å¼·ã§ã¯ã€‡ã€‡ã«ç‰¹ã«åŠ›ã‚’å…¥ã‚Œã¦ãã¾ã—ãŸã€‚æ—¥ã€…ã®ç©ã¿é‡ã­ã¨è¨ˆç”»çš„ãªå–ã‚Šçµ„ã¿ã§ã€çŸ¥è­˜ã ã‘ã§ãªãè€ƒãˆã‚‹åŠ›ã‚‚ä¼¸ã°ã›ãŸã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚ç‰¹ã«â–³â–³ã§ã¯è‹¦æ‰‹ãªåˆ†é‡ã‚‚é€ƒã’ãšã«å‘ãåˆã„ã€è‡ªåˆ†ãªã‚Šã®å·¥å¤«ã§ä¹—ã‚Šè¶Šãˆã¦ãã¾ã—ãŸã€‚",

    sports: "å­¦ç”Ÿæ™‚ä»£ã¯ã€‡ã€‡éƒ¨ã«æ‰€å±ã—ã¦ãŠã‚Šã€ç·´ç¿’ã‚’é€šã˜ã¦ä½“åŠ›ã ã‘ã§ãªãé›†ä¸­åŠ›ã‚„ç¤¼å„€ã‚‚èº«ã«ã¤ã‘ã¾ã—ãŸã€‚ä»²é–“ã¨æ”¯ãˆåˆã†çµŒé¨“ã‚‚å¤§ããªè²¡ç”£ã§ã™ã€‚è©¦åˆã‚„å¤§ä¼šã§ã¯è‡ªåˆ†ã®å½¹å‰²ã‚’æœãŸã™ã“ã¨ã«ã“ã ã‚ã‚Šã€å‹ã¡è² ã‘ä»¥ä¸Šã«ãƒãƒ¼ãƒ ã§å–ã‚Šçµ„ã‚€ã“ã¨ã®å¤§åˆ‡ã•ã‚’å®Ÿæ„Ÿã—ã¾ã—ãŸã€‚",

    communication: "äººã¨è©±ã™ã“ã¨ãŒå¥½ãã§ã€ã€‡ã€‡ã§ã¯å‘¨å›²ã¨å”åŠ›ã—ãªãŒã‚‰é€²ã‚ã‚‹ã“ã¨ãŒå¤šãã€è‡ªç„¶ã¨ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³åŠ›ãŒé›ãˆã‚‰ã‚ŒãŸã¨æ€ã„ã¾ã™ã€‚ç›¸æ‰‹ã®ç«‹å ´ã‚„æ°—æŒã¡ã‚’è€ƒãˆãªãŒã‚‰æ¥ã™ã‚‹ã‚ˆã†å¿ƒãŒã‘ã¦ã„ã¾ã™ã€‚å ´ã®é›°å›²æ°—ã‚’èª­ã¿å–ã‚Šã¤ã¤ã€è‡ªåˆ†ã®æ„è¦‹ã‚‚ã—ã£ã‹ã‚Šä¼ãˆã‚‹ãƒãƒ©ãƒ³ã‚¹ã‚’å¤§åˆ‡ã«ã—ã¦ã„ã¾ã™ã€‚",

    creativity: "ã€‡ã€‡ã®æ´»å‹•ã‚’é€šã˜ã¦ã€ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å‡ºã—ã¦å½¢ã«ã™ã‚‹é¢ç™½ã•ã‚’å­¦ã³ã¾ã—ãŸã€‚è‡ªç”±ãªç™ºæƒ³ã¨å·¥å¤«ã™ã‚‹åŠ›ãŒè‡ªåˆ†ã®å¼·ã¿ã ã¨æ€ã£ã¦ã„ã¾ã™ã€‚å‘¨å›²ã¨æ„è¦‹ã‚’å‡ºã—åˆã„ãªãŒã‚‰ã€ã‚ˆã‚Šè‰¯ã„å½¢ã«ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—ã—ã¦ã„ãéç¨‹ã«ã‚„ã‚ŠãŒã„ã‚’æ„Ÿã˜ã¾ã™ã€‚",

    patience: "ã€‡ã€‡ã®çµŒé¨“ã‹ã‚‰ã€ã†ã¾ãã„ã‹ãªã„æ™‚ã§ã‚‚æŠ•ã’å‡ºã•ãšã«å–ã‚Šçµ„ã‚€å§¿å‹¢ã‚’å¤§åˆ‡ã«ã—ã¦ãã¾ã—ãŸã€‚å°ã•ãªé€²æ­©ã‚’ç©ã¿ä¸Šã’ã‚‹åŠ›ãŒèº«ã«ã¤ãã¾ã—ãŸã€‚çµæœãŒå‡ºã‚‹ã¾ã§æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã—ãŸãŒã€ç²˜ã‚Šå¼·ãç¶šã‘ã‚‹ã“ã¨ã§è‡ªä¿¡ã«ã¤ãªãŒã£ã¦ã„ã¾ã™ã€‚"
  };

  const textarea = document.querySelector('#self-pr-textarea');
  if (textarea && prTemplates[category]) {
    textarea.value = prTemplates[category];

    // ğŸ”½ Firestoreã«å³ä¿å­˜ï¼ˆidãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
    if (typeof db !== 'undefined' && typeof id !== 'undefined' && id) {
      setDoc(doc(db, "cards", id), { selfPr: textarea.value }, { merge: true });
    }
  }
}


  </script>
<!-- æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªèƒŒæ™¯ãƒ†ãƒ³ãƒ—ãƒ¬ä¸€è¦§ -->
<div id="bg-template-list" style="
  display: none;
  position: fixed;
  bottom: 70px;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  padding: 10px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  z-index: 1100;
  max-width: 90vw;
  overflow-x: auto;
  gap: 10px;
  scrollbar-width: none; /* Firefoxç”¨ */
  -ms-overflow-style: none; /* IEç”¨ */
">
<!-- â–¼ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¤ã‚³ãƒ³ä»˜ããƒ†ãƒ³ãƒ—ãƒ¬è¿½åŠ ã“ã“ã‹ã‚‰ -->
<img src="/static/camera.jpeg" onclick="document.getElementById('background-input').click()" 
     style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">

<input type="file" accept="image/*" id="background-input" class="hidden-input">
<input type="hidden" id="background-url"> <!-- ğŸ”¥ downloadURLä¿å­˜ç”¨ -->
<!-- â–¼ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¤ã‚³ãƒ³ä»˜ããƒ†ãƒ³ãƒ—ãƒ¬è¿½åŠ ã“ã“ã¾ã§ -->
  <img src="/static/haikei_1.jpeg" onclick="setBackground('/static/haikei_1.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<img src="/static/haikei_2.jpeg" onclick="setBackground('/static/haikei_2.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<img src="/static/haikei_3.jpeg" onclick="setBackground('/static/haikei_3.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<img src="/static/haikei_4.jpeg" onclick="setBackground('/static/haikei_4.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<img src="/static/haikei_5.jpeg" onclick="setBackground('/static/haikei_5.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<img src="/static/haikei_6.jpeg" onclick="setBackground('/static/haikei_6.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<img src="/static/haikei_7.jpeg" onclick="setBackground('/static/haikei_7.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<img src="/static/haikei_8.jpeg" onclick="setBackground('/static/haikei_8.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<img src="/static/haikei_9.jpeg" onclick="setBackground('/static/haikei_9.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<img src="/static/haikei_10.jpeg" onclick="setBackground('/static/haikei_10.jpeg')" style="width:50px; height:50px; cursor:pointer; border-radius:8px; flex-shrink:0;">
<!-- ã•ã‚‰ã«è¿½åŠ ã—ã¦ã‚‚OKï¼ -->
</div>
<!-- â–¼ å…ˆã«ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©ï¼ -->
<style>
  #diagnosis-button {
    padding: 12px 24px;
    font-size: 17px;
    border-radius: 12px;
    background: rgb(255, 102, 153);
    color: #fff;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    letter-spacing: 1px;
    transition: all 0.2s ease-in-out;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3); /* â† ã“ã“ã§è¦–èªæ€§UP */
  }

  #diagnosis-button:hover {
    background: linear-gradient(135deg, #ffd1e9, #d6f2f9, #ffffff);
    transform: scale(1.05);
  }
</style>

<!-- â–¼ è¨ºæ–­ãƒœã‚¿ãƒ³ï¼ˆãƒãƒ„ä»˜ãï¼‰ -->
<div id="diagnosis-wrapper" style="position: relative; margin-top: 20px; text-align: center;">
  <img src="/static/batu.jpeg" alt="å‰Šé™¤" class="sns-delete-btn" onclick="hideDiagnosisButton()" style="
    position: absolute;
    top: -13px;
    right: 50px;
    width: 18px;
    height: 18px;
    cursor: pointer;
    z-index: 10;
  ">
  <button id="diagnosis-button" onclick="startDiagnosis()">MBTIè¨ºæ–­</button>
</div>
<!-- â–¼ è‡ªç”±è¨˜å…¥æ¬„ï¼ˆãƒãƒ„ä»˜ãï¼‰ -->
<div id="extra-text-wrapper" class="sns-wrapper" style="margin-top: 20px; position: relative;">
  <img src="/static/batu.jpeg" alt="å‰Šé™¤" class="sns-delete-btn" onclick="hideExtraText()" style="
    position: absolute;
    top: -3px;
    right: 18px;
    width: 18px;
    height: 18px;
    cursor: pointer;
    z-index: 10;
  ">
  <textarea id="extra-text" class="editable-text" placeholder="è¨˜å…¥æ¬„" style="
    margin-top: 10px;
    margin-left: 20px;
    padding: 14px 18px;
    border-radius: 14px;
    border: 1px solid #ccc;
    width: 90vw;
    max-width: 650px;
    height: 170px;
    font-size: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    resize: none;
    line-height: 1.6;
    background-color: #fff;
    box-sizing: border-box;
  "></textarea>
</div>

<!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæŒ¿å…¥ãƒœã‚¿ãƒ³ -->
<div class="deletable-templates" style="text-align: center; margin-top: 13px;">
  <button onclick="showTemplateButtons()" style="
    font-size: 14px;
    padding: 6px 14px;
    border-radius: 8px;
    border: none;
    background: rgb(255, 224, 136); 
    color: #333;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: background-color 0.2s ease;
  ">âœï¸ è¨˜å…¥æ¬„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</button>
</div>


<!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé …ç›®ãƒœã‚¿ãƒ³ï¼ˆæ¨ªä¸¦ã³ï¼‰ -->
<div id="template-buttons" style="
  margin: 12px auto 0;
  display: none;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
  max-width: 90%;
">
  <button onclick="insertTemplate('club')" class="template-btn">éƒ¨æ´»</button>
  <button onclick="insertTemplate('study')" class="template-btn">å­¦æ¥­</button>
  <button onclick="insertTemplate('circle')" class="template-btn">ã‚µãƒ¼ã‚¯ãƒ«</button>
  <button onclick="insertTemplate('parttime')" class="template-btn">ãƒã‚¤ãƒˆ</button>
  <button onclick="insertTemplate('hobby')" class="template-btn">è¶£å‘³</button>
</div>

<!-- ğŸ”½ è‡ªå·±PRå…¥åŠ›ã¨åˆ†æãƒœã‚¿ãƒ³ -->
<div id="self-pr-section" style="margin-top: 40px; position: relative;">
  <img src="/static/batu.jpeg" alt="å‰Šé™¤" class="sns-delete-btn" onclick="hideSelfPRSection()" style="
    position: absolute;
    top: 38px;
    right: 20px;
    width: 18px;
    height: 18px;
    cursor: pointer;
    z-index: 10;
  ">

  <h3 style="text-align: center;">è‡ªå·±PRã‚’åˆ†æï¼</h3>

  <!-- âœ… è‡ªç”±è¨˜å…¥æ¬„ã«å¯„ã›ãŸtextarea -->
  <textarea id="self-pr-textarea" rows="4" placeholder="ä¾‹ï¼šç§ã¯ç›®æ¨™ã«å‘ã‹ã£ã¦åŠªåŠ›ã™ã‚‹ã®ãŒå¾—æ„ã§â€¦"
    style="
      margin-top: 3px;
      margin-left: 20px;
      padding: 14px 18px;
      border-radius: 14px;
      border: 1px solid #ccc;
      width: 90vw;
      max-width: 650px;
      height: 170px;
      font-size: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      resize: none;
      line-height: 1.6;
      background-color: #fff;
      box-sizing: border-box;
    "></textarea>
<!-- è‡ªå·±PRãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæŒ¿å…¥ãƒœã‚¿ãƒ³ -->
<div class="deletable-templates self-pr-template-section" style="text-align: center; margin-top: 13px;">
  <button onclick="showPRTemplateButtons()" style="
    font-size: 14px;
    padding: 6px 14px;
    border-radius: 8px;
    border: none;
    background: rgb(255, 224, 136); 
    color: #333;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: background-color 0.2s ease;
  ">âœï¸ è‡ªå·±PRãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</button>
</div>

<!-- è‡ªå·±PRãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé …ç›®ãƒœã‚¿ãƒ³ -->
<div id="pr-template-buttons" style="
  margin: 12px auto 0;
  display: none;
  justify-content: center;
  flex-wrap: wrap;
  gap: 6px;
  max-width: 90%;
">
  <button onclick="insertPRTemplate('study')" class="template-btn">å‹‰å­¦</button>
  <button onclick="insertPRTemplate('sports')" class="template-btn">ã‚¹ãƒãƒ¼ãƒ„</button>
  <button onclick="insertPRTemplate('communication')" class="template-btn">ã‚³ãƒŸãƒ¥åŠ›</button>
  <button onclick="insertPRTemplate('creativity')" class="template-btn">å‰µé€ åŠ›</button>
  <button onclick="insertPRTemplate('patience')" class="template-btn">å¿è€åŠ›</button>
</div>


 <!-- âœ… è‡ªç”±è¨˜å…¥æ¬„ã¨èª¿å’Œã•ã›ãŸãƒœã‚¿ãƒ³ -->
<button onclick="analyzeSelfPR()" style="
  display: block;
  margin: 10px auto;
  padding: 10px 20px;
  font-size: 15px;
  border-radius: 10px;
  background: rgb(255, 224, 136); 
  color: black; /* æ–‡å­—ã‚’é»’ã« */
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  border: 1px solid #ccc;
">åˆ†æã—ã¦è¡¨ç¤º</button>
</div>


<!-- è‡ªå·±PRåˆ†æãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="self-pr-modal" style="
  display: none; /* åˆæœŸã¯éè¡¨ç¤ºï¼ */
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background-color: rgba(0, 0, 0, 0.6);
  z-index: 10000;
  box-sizing: border-box;
">
  <!-- âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸­èº«ã‚’flexã§ä¸­å¤®å¯„ã› -->
  <div style="
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
  ">
    <!-- ç™½ã„ãƒœãƒƒã‚¯ã‚¹ -->
    <div style="
      background: white;
      padding: 30px 20px;
      border-radius: 16px;
      max-width: 90%;
      width: 340px;
      text-align: center;
      position: relative;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    ">
      <!-- é–‰ã˜ã‚‹ -->
      <div onclick="document.getElementById('self-pr-modal').style.display='none'" style="
        position: absolute;
        top: 12px;
        right: 16px;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
      ">Ã—</div>

     <!-- ãƒãƒ£ãƒ¼ãƒˆ -->
<canvas id="resultChart" width="220" height="220" style="
  display: block;
  margin: 0 auto 20px;
  background: linear-gradient(to bottom, #ffffff, #e0f0ff);
  border-radius: 20px;
  transform: translateX(80px); /* ğŸ‘ˆ å³ã«ãšã‚‰ã™ */
"></canvas>

<!-- ã‚³ãƒ¡ãƒ³ãƒˆ -->
<h3 style="margin-bottom: -40px 0 5px;">ã‚ãªãŸã®å¼·ã¿è¨ºæ–­çµæœ</h3> <!-- ğŸ‘ˆ ä¸‹ã«ãšã‚‰ã™ -->
<div id="self-pr-comment" style="text-align: left; font-size: 15px; margin-top: 10px;"></div>
    </div>
  </div>
</div>





<!-- â–¼ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºéƒ¨åˆ† -->
<div id="diagnosis-modal" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background-color: rgba(0,0,0,0.7);
  z-index: 9999;
  align-items: center;
  justify-content: center;
">
  <div style="
    background: white;
    padding: 28px 24px;
    border-radius: 20px;
    max-width: 90vw;
    font-size: 13px;
    font-weight: bold;
    text-align: center;
    font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', sans-serif;
    animation: fadeIn 0.6s ease-in-out;
    line-height: 1.6;
  " id="diagnosis-result"></div>
</div>
<!-- è³ªå•ã‚³ãƒ¼ãƒŠãƒ¼ -->
<div id="quick-qna" style="text-align:center; margin:12px 0 0;">
  <button id="qna-open" type="button" style="
    padding:10px 16px;
    border:none;
    border-radius:12px;
    cursor:pointer;
    background:#ffe08a;
    box-shadow:0 2px 6px rgba(0,0,0,.1);
    font-size:15px;
    color:#333;">
     è³ªå•ã‚³ãƒ¼ãƒŠãƒ¼
  </button>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="qna-modal" style="
  display:none;
  position:fixed;
  inset:0;
  z-index:10000;
  background:rgba(0,0,0,.6);
  align-items:center;
  justify-content:center;">
  <div style="
    background:#fff;
    border-radius:16px;
    width:min(92vw, 560px);
    padding:18px 16px;                /* â† 22pxâ†’18pxã«è©°ã‚ãŸ */
    box-shadow:0 6px 18px rgba(0,0,0,.2);
    position:relative;">
    
    <!-- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
    <div id="qna-close" style="
      position:absolute;
      right:10px;
      top:8px;
      font-size:20px;
      font-weight:bold;
      cursor:pointer;">Ã—</div>

    <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
    <div id="qna-title" style="
      font-weight:800;
      font-size:17px;
      margin:0 0 6px;">è³ªå•</div>

    <!-- è³ªå•æ–‡ -->
    <div id="qna-question" style="
      font-size:15px;
      line-height:1.45;                /* â† è¡Œé–“ã‚’å°‘ã—è©°ã‚ãŸ */
      margin:6px 0 12px;
      letter-spacing:0.01em;"></div>

    <!-- ãƒœã‚¿ãƒ³ç¾¤ -->
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:4px;">
      <button id="qna-next" type="button" style="
        padding:8px 14px;
        border:none;
        border-radius:10px;
        background:#ffe08a;
        cursor:pointer;">åˆ¥ã®è³ªå•</button>
      <button id="qna-hide" type="button" style="
        padding:8px 14px;
        border:none;
        border-radius:10px;
        background:#ddd;
        cursor:pointer;">ã¨ã˜ã‚‹</button>
    </div>
  </div>
</div>


<style>
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}
</style>

<script>
function startDiagnosis() {
  const textInputs = Array.from(document.querySelectorAll('.editable-text')).map(i => i.value).join(' ');
  const extra = document.getElementById('extra-text')?.value || '';
  const combined = (textInputs + ' ' + extra).toLowerCase();
  const barColor = getComputedStyle(document.documentElement).getPropertyValue('--bar-color').trim().toLowerCase();

  let type = '';

  // I / E åˆ¤å®š
  if (
    combined.match(/ã²ã¨ã‚Š|é™ã‹|æœ¬|ã‚½ãƒ­|å®¶|è½ã¡ç€ã|ã‚¢ãƒ‹ãƒ¡|å†…çœ|é»™ã‚‹|ãƒã‚¤ãƒšãƒ¼ã‚¹|çœã‚¨ãƒ|è¦³å¯Ÿ|èãå½¹|è‡ªåˆ†æ™‚é–“|ã²ãã‹|ä¸€äººæ—…/) ||
    combined.match(/ç§ã¯ä¸€äººã§éã”ã™æ™‚é–“ã«å¿ƒåœ°ã‚ˆã•ã‚’æ„Ÿã˜ã¾ã™ã€‚é™ã‹ãªå ´æ‰€ã§æœ¬ã‚’èª­ã‚“ã ã‚Šã€æ€ç´¢ã«ãµã‘ã‚‹ã“ã¨ã§ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå›å¾©ã—ã¾ã™ã€‚äººã¨è©±ã™ã‚ˆã‚Šã‚‚ã€ã¾ãšè‡ªåˆ†ã®ä¸­ã§è€ƒãˆã‚’æ•´ç†ã™ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚/)
  ) {
    type += 'I';
  } else if (
    combined.match(/ä»²é–“|ã¿ã‚“ãª|ã‚«ãƒ©ã‚ªã‚±|ã‚¤ãƒ™ãƒ³ãƒˆ|æ—…è¡Œ|é£²ã¿ä¼š|ãŠã—ã‚ƒã¹ã‚Š|é¨’ã|SNS|ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼|ç››ã‚Šä¸ŠãŒã‚Š|è³‘ã‚„ã‹|å¤–å‡º|éŠã¶|ãƒ†ãƒ³ã‚·ãƒ§ãƒ³/) ||
    combined.match(/äººã¨è©±ã—ãŸã‚Šã€èª°ã‹ã¨ä¸€ç·’ã«éã”ã™ã“ã¨ã§å…ƒæ°—ãŒå‡ºã¾ã™ã€‚ã‚¤ãƒ™ãƒ³ãƒˆã‚„é›†ã¾ã‚ŠãŒå¥½ãã§ã€æ–°ã—ã„äººã¨å‡ºä¼šã†ã“ã¨ã«ãƒ¯ã‚¯ãƒ¯ã‚¯ã—ã¾ã™ã€‚é»™ã£ã¦ã„ã‚‹ã‚ˆã‚Šã‚‚ã€ä¼šè©±ã®ä¸­ã§è‡ªåˆ†ã‚’è¡¨ç¾ã—ãŸã„ã§ã™ã€‚/)
  ) {
    type += 'E';
  } else {
    type += 'I';
  }

  // N / S åˆ¤å®š
  if (
    combined.match(/ç©ºæƒ³|ã²ã‚‰ã‚ã|æƒ³åƒ|ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–|ã‚¢ãƒ¼ãƒˆ|å‰µä½œ|å“²å­¦|ç›´æ„Ÿ|å¤¢|æœªæ¥|ç†æƒ³|å¯èƒ½æ€§|ã‚¤ãƒ³ã‚¹ãƒ”ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³|æŠ½è±¡|æ¦‚å¿µ/) ||
    combined.match(/ç§ã¯ã‚¢ã‚¤ãƒ‡ã‚¢ã‚„ç©ºæƒ³ã‚’è†¨ã‚‰ã¾ã›ã‚‹ã®ãŒå¥½ãã§ã€ç¾å®Ÿã‚ˆã‚Šã‚‚æœªæ¥ã®å¯èƒ½æ€§ã«ç›®ã‚’å‘ã‘ãŒã¡ã§ã™ã€‚ç›´æ„Ÿçš„ã«ç‰©äº‹ã‚’æ‰ãˆã‚‹å ´é¢ã‚‚å¤šãã€æŠ½è±¡çš„ãªè©±é¡Œã«æƒ¹ã‹ã‚Œã‚‹ã“ã¨ãŒã‚ˆãã‚ã‚Šã¾ã™ã€‚/)
  ) {
    type += 'N';
  } else if (
    combined.match(/ç¾å®Ÿ|å®Ÿç”¨|æ—…è¡Œ|é‹å‹•|æ–™ç†|ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢|å…·ä½“|ä½“é¨“|äº”æ„Ÿ|äº‹å®Ÿ|åœ°ã«è¶³|çµŒé¨“|ç¾å ´|è¨¼æ‹ /) ||
    combined.match(/è‡ªåˆ†ãŒå®Ÿéš›ã«ä½“é¨“ã—ãŸã“ã¨ã‚„ã€ç¾å ´ã§å¾—ãŸæ„Ÿè¦šã‚’å¤§äº‹ã«ã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ãªäº‹å®Ÿã‚’ã‚‚ã¨ã«åˆ¤æ–­ã™ã‚‹å‚¾å‘ãŒã‚ã‚Šã€æŠ½è±¡çš„ãªè©±ã‚ˆã‚Šã‚‚ç›®ã®å‰ã®ç¾å®Ÿã‚’é‡è¦–ã™ã‚‹æ–¹ã§ã™ã€‚/)
  ) {
    type += 'S';
  } else {
    type += 'N';
  }

  // T / F åˆ¤å®šï¼ˆã‚¹ã‚³ã‚¢å¼ï¼‰
  let tfScore = 0;
  if (
    combined.match(/è«–ç†|åˆ†æ|åŠ¹ç‡|æ•°å­—|ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°|ç†å±ˆ|æˆ¦ç•¥|ãƒ‡ãƒ¼ã‚¿|åˆç†|å®¢è¦³|åˆ¤æ–­|ç«¶äº‰|è­°è«–/) ||
    combined.match(/ç‰©äº‹ã‚’åˆ¤æ–­ã™ã‚‹ã¨ãã¯æ„Ÿæƒ…ã‚ˆã‚Šã‚‚è«–ç†çš„ãªæ€è€ƒã‚’å„ªå…ˆã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚„äº‹å®Ÿã«åŸºã¥ã„ã¦åŠ¹ç‡çš„ã«é€²ã‚ãŸã„ã¨ã„ã†æ„è­˜ãŒå¼·ãã€æ„Ÿæƒ…ã«æµã•ã‚Œãªã„ã‚ˆã†å¿ƒãŒã‘ã¦ã„ã¾ã™ã€‚/)
  ) tfScore += 1;

  if (
    combined.match(/å…±æ„Ÿ|ã‚„ã•ã—ã„|å¿œæ´|æ€ã„ã‚„ã‚Š|ã‚±ã‚¢|æ„Ÿæƒ…|æ¶™|ç›¸è«‡|æ°—æŒã¡|ã¬ãã‚‚ã‚Š|æ„›æƒ…|æ”¯ãˆã‚‹|å¯„ã‚Šæ·»ã†/) ||
    combined.match(/äººã®æ°—æŒã¡ã«æ•æ„Ÿã§ã€å›°ã£ã¦ã„ã‚‹äººã‚’è¦‹ã‚‹ã¨æ”¾ã£ã¦ãŠã‘ã¾ã›ã‚“ã€‚ç›¸æ‰‹ã«å…±æ„Ÿã—ãªãŒã‚‰æ¥ã™ã‚‹ã“ã¨ã‚’å¤§åˆ‡ã«ã—ã¦ãŠã‚Šã€æ„Ÿæƒ…ã‚’å…±æœ‰ã™ã‚‹ã“ã¨ã§é–¢ä¿‚ã‚’æ·±ã‚ã‚ˆã†ã¨ã—ã¾ã™ã€‚/)
  ) tfScore -= 1;

  if (barColor.includes('pink') || barColor.includes('#f')) tfScore -= 1;
  if (barColor.includes('blue') || barColor.includes('#00f') || barColor.includes('navy')) tfScore += 1;

  type += tfScore >= 0 ? 'T' : 'F';

  // J / P åˆ¤å®š
  if (
    combined.match(/è¨ˆç”»|æ•´ç†|ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«|æ™‚é–“ç®¡ç†|ãƒªã‚¹ãƒˆ|æº–å‚™|ç®¡ç†|ç›®æ¨™|æ®µå–ã‚Š|ç· åˆ‡|ã—ã£ã‹ã‚Š|è¨ˆç®—|å®‰å®š|æ§‹é€ /) ||
    combined.match(/ã‚ã‚‰ã‹ã˜ã‚è¨ˆç”»ã‚’ç«‹ã¦ã¦è¡Œå‹•ã™ã‚‹æ–¹ãŒå®‰å¿ƒã—ã¾ã™ã€‚ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’çµ„ã‚“ã§é€²ã‚ãŸã‚Šã€æ®µå–ã‚Šã‚’æ•´ãˆã‚‹ã“ã¨ã§æ°—æŒã¡ã«ä½™è£•ãŒç”Ÿã¾ã‚Œã‚‹ã‚¿ã‚¤ãƒ—ã§ã™ã€‚çªç„¶ã®å¤‰æ›´ã¯è‹¦æ‰‹ã§ã™ã€‚/)
  ) {
    type += 'J';
  } else if (
    combined.match(/è‡ªç”±|æ°—ã¾ã¾|æŸ”è»Ÿ|ãƒã‚¤ãƒšãƒ¼ã‚¹|ãã®å ´|æ€ã„ã¤ã|å³èˆˆ|å¯¾å¿œåŠ›|å¤‰åŒ–|æµã‚Œ|å‹¢ã„|ã‚†ã‚‹ã„|ç›´æ„Ÿçš„/) ||
    combined.match(/ãã®æ™‚ã®æ°—åˆ†ã‚„çŠ¶æ³ã«å¿œã˜ã¦æŸ”è»Ÿã«å‹•ãã“ã¨ãŒå¤šã„ã§ã™ã€‚ç´°ã‹ã„è¨ˆç”»ã‚ˆã‚Šã‚‚ã€æµã‚Œã«ä¹—ã£ã¦å³èˆˆã§å¯¾å¿œã™ã‚‹æ–¹ãŒå¾—æ„ã§ã€è‡ªåˆ†ã‚‰ã—ã•ã‚’å¤§åˆ‡ã«ã—ãŸã„ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚/)
  ) {
    type += 'P';
  } else {
    type += 'P';
  }




  const mbtiDescriptions = {
  INFP: "ç†æƒ³å®¶ã§ã‚„ã•ã—ã„ç™’ã—ç³»ï¼",
  INTP: "è«–ç†æ´¾ã®çŸ¥çš„æ¢ç©¶ã‚¿ã‚¤ãƒ—ï¼",
  INFJ: "å…±æ„ŸåŠ›ã‚ã‚‹é™ã‹ãªã‚«ãƒªã‚¹ãƒï¼",
  INTJ: "æœªæ¥ã‚’èª­ã‚€æˆ¦ç•¥å®¶ã‚¿ã‚¤ãƒ—ï¼",
  ENFP: "ç›´æ„Ÿã§å‹•ãå†’é™ºã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ï¼",
  ENTP: "æ©Ÿè»¢ã¨è¡Œå‹•åŠ›ã‚ã‚‹æŒ‘æˆ¦è€…ï¼",
  ENFJ: "äººã‚’å°ãå·»ãè¾¼ã¿ä¸Šæ‰‹ï¼",
  ENTJ: "ç›®æ¨™ä¸€ç›´ç·šãªãƒªãƒ¼ãƒ€ãƒ¼è‚Œï¼",
  ISFP: "æ„Ÿæ€§è±Šã‹ãªç©ã‚„ã‹ã‚¿ã‚¤ãƒ—ï¼",
  ISTP: "å†·é™ã§å®Ÿè·µæ´¾ãªè·äººè‚Œï¼",
  ISFJ: "å„ªã—ãæ”¯ãˆã‚‹ç¸ã®ä¸‹ã®åŠ›æŒã¡ï¼",
  ISTJ: "çœŸé¢ç›®ã§ä¿¡é ¼ã•ã‚Œã‚‹å …å®Ÿå®¶ï¼",
  ESFP: "é™½æ°—ãªãƒ ãƒ¼ãƒ‰ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼",
  ESTP: "è¡Œå‹•æ´¾ãªãƒªã‚¢ãƒªã‚¹ãƒˆï¼",
  ESFJ: "ä¸–è©±å¥½ãã§è¦ªã—ã¿ã‚„ã™ã„ï¼",
  ESTJ: "é ¼ã‚Œã‚‹å®Ÿå‹™ã®ãƒ—ãƒ­ï¼"
};


  const displayName = "ã€‡ã€‡ã•ã‚“";
  const resultLines = [];

  resultLines.push(`<div style="font-size: 20px;">${displayName}ã¯ã€Œ${type}ã‚¿ã‚¤ãƒ—ã€ã‹ã‚‚ï¼ï¼Ÿ</div>`);
  resultLines.push(`<div>MBTIçš„ã«ã¯ï¼š${mbtiDescriptions[type] || "ãƒãƒ©ãƒ³ã‚¹å‹ã‚¿ã‚¤ãƒ—ï¼"}</div>`);

  if (barColor.includes('pink') || barColor.includes('#f') || barColor.includes('rose')) {
  resultLines.push("<div>è‰²è¨ºæ–­ï¼šãƒ”ãƒ³ã‚¯ç³» â†’ æ„Ÿå—æ€§è±Šã‹ã§ã‚„ã•ã—ã„æ€§æ ¼ï¼</div>");
} else if (barColor.includes('blue') || barColor.includes('navy') || barColor.includes('#00f') || barColor.includes('sky')) {
  resultLines.push("<div>è‰²è¨ºæ–­ï¼šé’ç³» â†’ å†·é™ã§èª å®Ÿã€çŸ¥çš„ãªæ€§æ ¼ï¼</div>");
} else if (barColor.includes('green') || barColor.includes('lime') || barColor.includes('olive')) {
  resultLines.push("<div>è‰²è¨ºæ–­ï¼šç·‘ç³» â†’ è‡ªç„¶ã‚„å¹³å’Œã‚’å¤§åˆ‡ã«ã™ã‚‹ç©ã‚„ã‹ã‚¿ã‚¤ãƒ—ï¼</div>");
} else if (barColor.includes('yellow') || barColor.includes('gold') || barColor.includes('#ff0')) {
  resultLines.push("<div>è‰²è¨ºæ–­ï¼šé»„è‰²ç³» â†’ æ˜ã‚‹ãå‰å‘ãã§ç¤¾äº¤çš„ãªæ€§æ ¼ï¼</div>");
} else if (barColor.includes('orange') || barColor.includes('#ffa')) {
  resultLines.push("<div>è‰²è¨ºæ–­ï¼šã‚ªãƒ¬ãƒ³ã‚¸ç³» â†’ æ´»å‹•çš„ã§äººæ‡ã£ã“ã„ã‚¨ãƒãƒ«ã‚®ãƒ¼æ´¾ï¼</div>");
} else if (barColor.includes('red') || barColor.includes('crimson') || barColor.includes('#f00')) {
  resultLines.push("<div>è‰²è¨ºæ–­ï¼šèµ¤ç³» â†’ æƒ…ç†±çš„ã§ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚’æŒã¤äººï¼</div>");
} else if (barColor.includes('purple') || barColor.includes('violet') || barColor.includes('indigo')) {
  resultLines.push("<div>è‰²è¨ºæ–­ï¼šç´«ç³» â†’ æ„Ÿæ€§è±Šã‹ã§ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹ãªé­…åŠ›ï¼</div>");
} else if (barColor.includes('black') || barColor.includes('#000')) {
  resultLines.push("<div>è‰²è¨ºæ–­ï¼šé»’ç³» â†’ æ„å¿—ãŒå¼·ãã€è½ã¡ç€ã„ãŸé›°å›²æ°—ï¼</div>");
} else if (barColor.includes('white') || barColor.includes('#fff') || barColor.includes('ivory')) {
  resultLines.push("<div>è‰²è¨ºæ–­ï¼šç™½ç³» â†’ ç´”ç²‹ã§ç´ ç›´ã€èª¿å’Œã‚’å¤§åˆ‡ã«ã™ã‚‹ã‚¿ã‚¤ãƒ—ï¼</div>");
} else if (barColor.includes('gray') || barColor.includes('grey') || barColor.includes('#888')) {
  resultLines.push("<div>è‰²è¨ºæ–­ï¼šã‚°ãƒ¬ãƒ¼ç³» â†’ å†·é™ã§å¤§äººã³ãŸãƒãƒ©ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ï¼</div>");
} else {
  resultLines.push("<div>è‰²è¨ºæ–­ï¼šä¸­é–“è‰² â†’ å¤šæ§˜æ€§ã‚’å—ã‘å…¥ã‚Œã‚‹æŸ”è»Ÿãªã‚¿ã‚¤ãƒ—ï¼</div>");
}


 const hobbyTags = {
  'ã‚²ãƒ¼ãƒ ': 'æˆ¦ç•¥æ´¾ or ãƒã‚¤ãƒšãƒ¼ã‚¹æ´¾',
  'ã‚¢ãƒ‹ãƒ¡': 'æ„Ÿæ€§è±Šã‹ã§å†…å‘å‹å¯„ã‚Š',
  'æ—…è¡Œ': 'å¥½å¥‡å¿ƒæ—ºç››ãªå†’é™ºå¥½ã',
  'ã‚«ãƒ•ã‚§': 'ç™’ã—é‡è¦–ãƒ»æ„Ÿæ€§ã‚¿ã‚¤ãƒ—',
  'éŸ³æ¥½': 'æ„Ÿæƒ…ã¨çµã³ã¤ããŒå¼·ã„äºº',
  'èª­æ›¸': 'æ€ç´¢å‹ãƒ»æƒ³åƒåŠ›ãŒè±Šã‹',
  'ã‚¹ãƒãƒ¼ãƒ„': 'å¤–å‘çš„ã§ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥',
  'ç¾è¡“': 'ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–å¿—å‘',
  'æ–™ç†': 'ç¹Šç´°ã§å®¶åº­çš„ãªæ°—è³ª',
  'ç­‹ãƒˆãƒ¬': 'è‡ªå·±æˆé•·æ„è­˜ãŒå¼·ã„ã‚¿ã‚¤ãƒ—',
  'ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³': 'è‡ªå·±è¡¨ç¾ã¨æµè¡Œã«æ•æ„Ÿãªã‚¿ã‚¤ãƒ—',
  'ãƒ€ãƒ³ã‚¹': 'èº«ä½“ã§æ„Ÿæƒ…ã‚’è¡¨ç¾ã™ã‚‹æƒ…ç†±æ´¾',
  'ã‚«ãƒ©ã‚ªã‚±': 'ç¤¾äº¤çš„ã§è¡¨ç¾ãŒå¥½ããªç››ã‚Šä¸Šã’å½¹',
  'ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ': 'é ­è„³æ´¾ã§ã¿ã‚“ãªã¨æ¥½ã—ã‚€ã“ã¨ãŒå¥½ã',
  'ãƒšãƒƒãƒˆ': 'æ„›æƒ…æ·±ãã€ç™’ã—ã‚„ã¤ãªãŒã‚Šã‚’å¤§äº‹ã«ã™ã‚‹äºº',
  'ã‚¤ãƒ©ã‚¹ãƒˆ': 'ç¹Šç´°ã§æ„Ÿå—æ€§ãŒè±Šã‹ã€æƒ³åƒåŠ›ã‚‚é«˜ã„',
  'ã‚«ãƒ¡ãƒ©': 'è¦³å¯Ÿçœ¼ã«å„ªã‚Œã€æ„Ÿæƒ…ã‚’å†™çœŸã§è¡¨ç¾ã—ãŸã„ã‚¿ã‚¤ãƒ—',
  'æ˜ ç”»': 'ç‰©èªã‚„ä¸–ç•Œè¦³ã«æ²¡å…¥ã™ã‚‹ã‚¨ãƒ¢æ´¾',
  'ã‚«ãƒ©ãƒ•ãƒ«ãªé›‘è²¨': 'æ˜ã‚‹ãå€‹æ€§çš„ãªã‚»ãƒ³ã‚¹ã®æŒã¡ä¸»',
  'æ‰‹èŠ¸': 'ä¸å¯§ã§é›†ä¸­åŠ›ãŒé«˜ãã€ã‚‚ã®ã¥ãã‚Šå¥½ã',
  'æ•£æ­©': 'è‡ªç„¶ã¨ã®èª¿å’Œã‚’å¤§åˆ‡ã«ã™ã‚‹ãƒã‚¤ãƒšãƒ¼ã‚¹æ´¾',
  'ã‚­ãƒ£ãƒ³ãƒ—': 'è‡ªç„¶ã¨ã®ä¸€ä½“æ„Ÿã‚’æ±‚ã‚ã‚‹ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢æ´¾',
  'é‡£ã‚Š': 'å¿è€å¼·ãé™ã‹ãªæ™‚é–“ã‚’æ¥½ã—ã‚ã‚‹ã‚¿ã‚¤ãƒ—',
  'æ—¥è¨˜': 'è‡ªå·±å†…çœå‹ã§æ„Ÿæƒ…ã®æ•´ç†ãŒå¾—æ„',
  'ãƒ–ãƒ­ã‚°': 'ç™ºä¿¡åŠ›ãŒã‚ã‚Šã€æ€è€ƒã‚’è¨€èªåŒ–ã™ã‚‹ã®ãŒå¾—æ„',
  'ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°': 'ã‚³ãƒ„ã‚³ãƒ„åŠªåŠ›å‹ãƒ»é”æˆæ„Ÿé‡è¦–ã‚¿ã‚¤ãƒ—',
  'DIY': 'æ‰‹ã‚’å‹•ã‹ã—ã¦è€ƒãˆã‚‹ã‚¯ãƒ©ãƒ•ãƒˆãƒãƒ³ã‚¿ã‚¤ãƒ—',
  'è»Š': 'æ©Ÿæ¢°ã‚„ã‚¹ãƒ”ãƒ¼ãƒ‰ã«ãƒ­ãƒãƒ³ã‚’æ„Ÿã˜ã‚‹äºº',
  'ãƒã‚¤ã‚¯': 'åˆºæ¿€ã¨è‡ªç”±ã‚’æ±‚ã‚ã‚‹ã‚¢ã‚¦ãƒˆãƒ­ãƒ¼æ°—è³ª',
  'ã‚¹ã‚¤ãƒ¼ãƒ„ä½œã‚Š': 'å‰µæ„å·¥å¤«ã¨ä¸å¯§ã•ã‚’æ¥½ã—ã‚€ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼',
  'æ¨ã—æ´»': 'æƒ…ç†±ã‚’æ³¨ã’ã‚‹å¯¾è±¡ãŒã‚ã‚‹æ„›æƒ…æ·±ã„ã‚¿ã‚¤ãƒ—',
  'Vlog': 'æ—¥å¸¸ã®ç¾ã—ã•ã‚„æ„Ÿå‹•ã‚’ç™ºä¿¡ã—ãŸã„ã‚¿ã‚¤ãƒ—',
  'èˆå°': 'è¡¨ç¾èŠ¸è¡“ã«æ„Ÿå‹•ã§ãã‚‹æ„Ÿæ€§æ´¾'
};

const detectedHobbies = Object.keys(hobbyTags).filter(word => combined.includes(word));
if (detectedHobbies.length > 0) {
  resultLines.push(`<div>${displayName}ã¯ ${detectedHobbies.join('ãƒ»')} ãŒå¥½ããªå‚¾å‘ãŒã‚ã‚‹ã‚ˆï¼</div>`);
  resultLines.push(`<div>â†’ å‚¾å‘ï¼š${detectedHobbies.map(h => hobbyTags[h]).join(' ï¼ ')}</div>`);
}

const hobbyExtensions = [];

// è‡ªç„¶æ–‡ï¼‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã«å¯¾å¿œ
const hobbyExtensionPatterns = [
  { keyword: 'ã‚²ãƒ¼ãƒ ', pattern: /ã‚²ãƒ¼ãƒ |æš‡(ãª|ãªã¨ãã«)?(ã¨ã|æ™‚é–“)ã¯(ã ã„ãŸã„)?ã‚²ãƒ¼ãƒ |FPS|RPG|ã‚¹ãƒ—ãƒ©|ã‚¨ãƒ¼ãƒšãƒƒã‚¯ã‚¹|ãƒãƒªã‚ª|ä»»å¤©å ‚|Steam|Switch|ã‚¹ãƒãƒ›ã‚²ãƒ¼ãƒ |ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚²ãƒ¼ãƒ /, msg: "\ud83c\udfae ã‚µãƒã‚²ãƒ¼ã‚„ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ã‚‚å¥½ããªå¯èƒ½æ€§ã‚ã‚Šï¼" },
  { keyword: 'éŸ³æ¥½', pattern: /éŸ³æ¥½|é€šå­¦(ä¸­)?ã«(ã‚ˆã)?éŸ³æ¥½ã‚’è´ã|ãƒ©ã‚¤ãƒ–(ã«è¡Œã|å‚æˆ¦)|ãƒ•ã‚§ã‚¹|æ¨ã—ã®æ›²|BGM|ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ|ã‚¤ãƒ¤ãƒ›ãƒ³|Spotify|é‚¦ãƒ­ãƒƒã‚¯|J-POP|æ´‹æ¥½|ãƒ­ãƒƒã‚¯ãƒãƒ³ãƒ‰/, msg: "\ud83c\udfb5 ä½œæ›²ã‚„ãƒ©ã‚¤ãƒ–å‚æˆ¦ã«ã‚‚èˆˆå‘³ã‚ã‚‹ã‹ã‚‚ï¼" },
  { keyword: 'ã‚«ãƒ•ã‚§', pattern: /ã‚«ãƒ•ã‚§|ã‚«ãƒ•ã‚§å·¡ã‚Š|ã‚¤ãƒ³ã‚¹ã‚¿æ˜ ãˆã™ã‚‹ã‚«ãƒ•ã‚§|ã‚«ãƒ•ã‚§ã§ã‚†ã£ãã‚Š|ãŠã—ã‚ƒã‚Œãªã‚«ãƒ•ã‚§|ãŠæ°—ã«å…¥ã‚Šã®ã‚«ãƒ•ã‚§|ã‚³ãƒ¼ãƒ’ãƒ¼|ãƒ©ãƒ†ã‚¢ãƒ¼ãƒˆ|ãƒ‰ãƒªãƒƒãƒ—|ã‚¹ã‚¿ãƒ|å–«èŒ¶åº—/, msg: "\u2615\ufe0f ã‚«ãƒ•ã‚§å·¡ã‚Šãƒ–ãƒ­ã‚°å§‹ã‚ã¦ã‚‹ã‹ã‚‚ï¼Ÿ" },
  { keyword: 'èª­æ›¸', pattern: /èª­æ›¸|æœ¬ã‚’èª­ã‚€|æš‡(ãªã¨ã)?ã«èª­æ›¸|å›³æ›¸é¤¨é€šã„|å°èª¬|æ–‡åº«æœ¬|ãƒ“ã‚¸ãƒã‚¹æ›¸|ãƒãƒ³ã‚¬|æœ¬å±‹ã«é€šã†|Kindle|èª­æ›¸å¥½ã|ãƒ–ãƒƒã‚¯ã‚«ãƒ•ã‚§/, msg: "\ud83d\udcda æœ€è¿‘èª­ã‚“ã æœ¬ã®è©±ã‚’ã—ã¦ã¿ã‚‹ã¨ç››ã‚Šä¸ŠãŒã‚‹ã‹ã‚‚ï¼" },
  { keyword: 'ã‚¢ãƒ‹ãƒ¡', pattern: /ã‚¢ãƒ‹ãƒ¡|æ·±å¤œã‚¢ãƒ‹ãƒ¡|æ¯é€±æ¬ ã‹ã•ãšã‚¢ãƒ‹ãƒ¡|æ¨ã—ã‚¢ãƒ‹ãƒ¡|ã‚ªã‚¿ã‚¯|ã‚¢ãƒ‹ãƒ¡æ˜ ç”»|ã‚¸ãƒ£ãƒ³ãƒ—ç³»|äº¬ã‚¢ãƒ‹|ã‚¢ãƒ‹ãƒ¡å¥½ã|2æ¬¡å…ƒ|æ¨ã—ã‚­ãƒ£ãƒ©|U-NEXT|ã‚¢ãƒ‹ã‚ªã‚¿/, msg: "\ud83d\udcfa æ¨ã—ã‚­ãƒ£ãƒ©ã‚„ã‚¢ãƒ‹ãƒ¡ã‚ã‚‹ï¼Ÿã£ã¦èãã¨å–œã¶ã‚¿ã‚¤ãƒ—ã‹ã‚‚ï¼" },
  { keyword: 'ã‚¹ãƒãƒ¼ãƒ„', pattern: /ã‚¹ãƒãƒ¼ãƒ„|(ä½“è‚²ä¼šç³»|é‹å‹•éƒ¨|éƒ¨æ´»ã§é‹å‹•)|ä½“ã‚’å‹•ã‹ã™ã®ãŒå¥½ã|ç­‹ãƒˆãƒ¬|é‡çƒ|ã‚µãƒƒã‚«ãƒ¼|ãƒã‚¹ã‚±|ãƒ†ãƒ‹ã‚¹|ãƒ©ã‚°ãƒ“ãƒ¼|é™¸ä¸Š|ä½“è‚²|å¤§ä¼š|è©¦åˆ|è¦³æˆ¦|èµ°ã‚‹ã®ãŒå¥½ã/, msg: "\u26bd è¦³æˆ¦æ´¾ã‹ãƒ—ãƒ¬ã‚¤æ´¾ã‹èã„ã¦ã¿ã‚‹ã¨æ„å¤–ãªè©±ãŒèã‘ã‚‹ã‹ã‚‚ï¼" },
  { keyword: 'æ—…è¡Œ', pattern: /æ—…è¡Œ|é€±æœ«ã¯(ã‚ˆã)?æ—…è¡Œã«å‡ºã‹ã‘ã‚‹|æµ·å¤–æ—…è¡Œ|ä¸€äººæ—…|æ¸©æ³‰æ—…è¡Œ|å›½å†…æ—…è¡Œ|æ—…å¥½ã|è¦³å…‰åœ°å·¡ã‚Š|æ—…è¡Œè¨ˆç”»/, msg: "\u2708\ufe0f è¡Œã£ã¦ã¿ãŸã„å›½ã¨ã‹èªã‚Šåˆã†ã¨æ¥½ã—ã„ã‹ã‚‚ï¼" },
  { keyword: 'ç¾è¡“', pattern: /ç¾è¡“|ã‚¢ãƒ¼ãƒˆ|ç¾è¡“é¤¨å·¡ã‚Š|å±•è¦§ä¼šã«è¡Œã|çµµç”»é‘‘è³|èŠ¸è¡“ä½œå“|ç¾ä»£ã‚¢ãƒ¼ãƒˆ|æ¨ã—ç”»å®¶/, msg: "\ud83c\udfa8 ç¾è¡“é¤¨ãƒˆãƒ¼ã‚¯ã‚„æ¨ã—ç”»å®¶ã®è©±ãŒãƒãƒã‚‹ã‹ã‚‚ï¼" },
  { keyword: 'æ–™ç†', pattern: /æ–™ç†|è‡ªç‚Š|ã‚¯ãƒƒã‚­ãƒ³ã‚°|ã”ã¯ã‚“ä½œã‚Š|ãƒ¬ã‚·ãƒ”|å®¶åº­æ–™ç†|ãŠè“å­ä½œã‚Š|é£Ÿäº‹ã®æº–å‚™|ã‚­ãƒƒãƒãƒ³/, msg: "\ud83c\udf73 å¾—æ„æ–™ç†ã¨ã‹èãã¨ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸ŠãŒã‚Šãã†ï¼" },
  { keyword: 'ç­‹ãƒˆãƒ¬', pattern: /ç­‹ãƒˆãƒ¬|ã‚¸ãƒ ã«é€šã†|ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³|è…¹ç­‹|ãƒ€ãƒ³ãƒ™ãƒ«|ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹|é›ãˆã‚‹|ç­‹è‚‰å¢—ã‚„ã™|ä½“ã‚’é›ãˆã‚‹/, msg: "\ud83d\udcaa ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³ã®è©±ã§ç››ã‚Šä¸ŠãŒã‚Œã‚‹ã‹ã‚‚â€¦ï¼ï¼Ÿ" },
  { keyword: 'ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³', pattern: /ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³|æœé¸ã³ãŒå¥½ã|ãŠã—ã‚ƒã‚Œ|ãƒ–ãƒ©ãƒ³ãƒ‰ã«è©³ã—ã„|ã‚»ãƒ¬ã‚¯ãƒˆã‚·ãƒ§ãƒƒãƒ—å·¡ã‚Š|æ´‹æœã‚³ãƒ¼ãƒ‡|æœã®ç³»çµ±/, msg: "\ud83d\udc57 å¥½ããªãƒ–ãƒ©ãƒ³ãƒ‰ã‚„æœã®ç³»çµ±ã€è©±ã—ã¦ã¿ã‚ˆã†ï¼" },
  { keyword: 'ã‚«ãƒ©ã‚ªã‚±', pattern: /ã‚«ãƒ©ã‚ªã‚±|æ­Œã†ã®ãŒå¥½ã|åå…«ç•ªã®æ›²ãŒã‚ã‚‹|ãƒ’ãƒˆã‚«ãƒ©|æ­Œå”±åŠ›|DAM|JOYSOUND|ã‚«ãƒ©ã‚ªã‚±ã§ç››ã‚Šä¸ŠãŒã‚‹/, msg: "\ud83c\udfa4 å®šç•ªã‚½ãƒ³ã‚°ã‚ã‚‹ï¼Ÿã£ã¦èãã¨ä¸€æ°—ã«è·é›¢ç¸®ã¾ã‚‹ã‹ã‚‚ï¼" },
  { keyword: 'ãƒšãƒƒãƒˆ', pattern: /ãƒšãƒƒãƒˆ|çŠ¬|çŒ«|ã†ã•ã|é£¼ã£ã¦ã‚‹å‹•ç‰©|ãƒšãƒƒãƒˆè‡ªæ…¢|ç™’ã•ã‚Œã‚‹å­˜åœ¨|ãƒšãƒƒãƒˆã¨ã®æ™‚é–“|ãƒ¢ãƒ•ãƒ¢ãƒ•/, msg: "\ud83d\udc3e é£¼ã£ã¦ã‚‹å‹•ç‰©ã®è©±ã‚’ã™ã‚‹ã¨å¬‰ã—ãã†ã«è©±ã—ã¦ãã‚Œã‚‹ã‹ã‚‚ï¼" },
  { keyword: 'ã‚¤ãƒ©ã‚¹ãƒˆ', pattern: /ã‚¤ãƒ©ã‚¹ãƒˆ|çµµã‚’æã|ãƒ‡ã‚¸çµµ|ã‚¢ãƒŠãƒ­ã‚°çµµ|ãŠçµµã‹ã|SNSã«æŠ•ç¨¿|Pixiv|ã‚¹ã‚±ãƒƒãƒãƒ–ãƒƒã‚¯/, msg: "\ud83d\udd8c\ufe0f SNSã«æŠ•ç¨¿ã—ã¦ã‚‹ã‹ã‚‚ï¼Ÿè¦‹ã›ã¦ã‚‚ã‚‰ã£ã¦ã¿ã‚ˆã†ï¼" },
  { keyword: 'æ˜ ç”»', pattern: /æ˜ ç”»|æ˜ ç”»é¤¨ã«è¡Œã|æ˜ ç”»ä¸‰æ˜§|ã‚µãƒ–ã‚¹ã‚¯ã§æ˜ ç”»|æ¨ã—ä¿³å„ª|æ´‹ç”»|é‚¦ç”»|åä½œæ˜ ç”»/, msg: "\ud83c\udfa5 å¥½ããªã‚¸ãƒ£ãƒ³ãƒ«ã‚„æ¨ã—ä¿³å„ªã®è©±ã§ç››ã‚Šä¸ŠãŒã‚Œã‚‹ã‹ã‚‚ï¼" },
  { keyword: 'ãƒ€ãƒ³ã‚¹', pattern: /ãƒ€ãƒ³ã‚¹|è¸Šã‚‹ã®ãŒå¥½ã|æŒ¯ã‚Šä»˜ã‘è¦šãˆã‚‹|K-POPãƒ€ãƒ³ã‚¹|ãƒ€ãƒ³ã‚¹ã‚µãƒ¼ã‚¯ãƒ«|ã‚¹ãƒ†ãƒ¼ã‚¸çµŒé¨“/, msg: "\ud83d\udd7a\fe0f å¥½ããªã‚¸ãƒ£ãƒ³ãƒ«ã‚„æŒ¯ã‚Šä»˜ã‘ã®è©±ã‚’ã™ã‚‹ã¨ç››ã‚Šä¸ŠãŒã‚Šãã†ï¼" },
  { keyword: 'ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ', pattern: /ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ |ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ |äººç‹¼|äººç”Ÿã‚²ãƒ¼ãƒ |ã¿ã‚“ãªã§éŠã¹ã‚‹ã‚²ãƒ¼ãƒ |é ­è„³æˆ¦/, msg: "\ud83c\udfb2 ã©ã®ã‚²ãƒ¼ãƒ æ´¾ã‹èãã¨ç››ã‚Šä¸ŠãŒã‚Œã‚‹ã‹ã‚‚ï¼" },
  { keyword: 'æ‰‹èŠ¸', pattern: /æ‰‹èŠ¸|è£ç¸«|ç·¨ã¿ç‰©|ãƒãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ‰|æ‰‹ä½œã‚Š|ãƒŸã‚·ãƒ³ä½œæ¥­|å¸ƒå°ç‰©ä½œã‚Š/, msg: "\ud83e\uddf5 ãƒãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ‰ä½œå“ã®è©±ã‚’ã™ã‚‹ã¨å¬‰ã—ãã†ã«è©±ã™ã‹ã‚‚ï¼" },
  { keyword: 'æ•£æ­©', pattern: /æ•£æ­©|ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°|è‡ªç„¶ã®ä¸­ã‚’æ­©ã|æœã®æ•£æ­©|æ°—åˆ†è»¢æ›ã«æ­©ã|è¿‘æ‰€ã‚’ã¶ã‚‰ã¶ã‚‰/, msg: "\ud83d\udeb6\u200d æ•£æ­©ã‚³ãƒ¼ã‚¹ã®è©±ã‹ã‚‰è‡ªç„¶ãƒˆãƒ¼ã‚¯ã«åºƒãŒã‚‹ã‹ã‚‚ï¼" },
  { keyword: 'ã‚«ãƒ¡ãƒ©', pattern: /ã‚«ãƒ¡ãƒ©|å†™çœŸã‚’æ’®ã‚‹|ä¸€çœ¼ãƒ¬ãƒ•|æ§‹å›³|é¢¨æ™¯æ’®å½±|ãƒ•ã‚©ãƒˆã‚³ãƒ³ãƒ†ã‚¹ãƒˆ|å†™çœŸé›†ã‚|ãƒ•ã‚£ãƒ«ãƒ ã‚«ãƒ¡ãƒ©/, msg: "\ud83d\udcf7 æ’®ã£ãŸå†™çœŸã‚’è¦‹ã›ã¦ã‚‚ã‚‰ã†ã¨ä¼šè©±ãŒå¼¾ã‚€ã‹ã‚‚ï¼" },
  { keyword: 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°', pattern: /ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°|ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã|ã‚¢ãƒ—ãƒªé–‹ç™º|Python|JavaScript|Webåˆ¶ä½œ|ãƒãƒƒã‚«ã‚½ãƒ³/, msg: "\ud83d\udcbb ã©ã‚“ãªã‚¢ãƒ—ãƒªã‚„ã‚³ãƒ¼ãƒ‰æ›¸ã„ã¦ã‚‹ã‹èã„ã¦ã¿ã‚ˆã†ï¼" },
  { keyword: 'DIY', pattern: /DIY|æ—¥æ›œå¤§å·¥|å®¶å…·ã‚’è‡ªä½œ|å·¥å…·ã‚’ä½¿ã†ã®ãŒå¾—æ„|ã‚¤ãƒ³ãƒ†ãƒªã‚¢ä½œã‚Š|æ”¹é€ /, msg: "\ud83d\udd27 æœ€è¿‘ä½œã£ãŸã‚‚ã®ã‚„ã“ã ã‚ã‚Šãƒã‚¤ãƒ³ãƒˆã‚’èã„ã¦ã¿ã‚ˆã†ï¼" },
  { keyword: 'è»Š', pattern: /è»Š|ãƒ‰ãƒ©ã‚¤ãƒ–|è»Šã„ã˜ã‚Š|ã‚«ã‚¹ã‚¿ãƒ |è»Šå¥½ã|æ„›è»Šè‡ªæ…¢|è»Šã®å†™çœŸ/, msg: "\ud83d\ude97 æ„›è»Šã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚„ã‚«ã‚¹ã‚¿ãƒ ã®è©±ãŒå¼¾ã¿ãã†ï¼" },
  { keyword: 'ãƒã‚¤ã‚¯', pattern: /ãƒã‚¤ã‚¯|ãƒ„ãƒ¼ãƒªãƒ³ã‚°|ãƒã‚¤ã‚¯æ—…|ã‚«ã‚¹ã‚¿ãƒ |ãƒã‚¤ã‚¯æ„›å¥½å®¶|ã‚¨ãƒ³ã‚¸ãƒ³éŸ³/, msg: "\ud83d\ude97 æ„›è»Šã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚„ã‚«ã‚¹ã‚¿ãƒ ã®è©±ãŒå¼¾ã¿ãã†ï¼" },
  { keyword: 'ã‚¹ã‚¤ãƒ¼ãƒ„ä½œã‚Š', pattern: /ã‚¹ã‚¤ãƒ¼ãƒ„ä½œã‚Š|ãŠè“å­ä½œã‚Š|ã‚±ãƒ¼ã‚­ä½œã‚‹|ã‚¯ãƒƒã‚­ãƒ¼ç„¼ã|ãƒ¬ã‚·ãƒ”æ¢ã—/, msg: "\ud83c\udf70 å¾—æ„ãªã‚¹ã‚¤ãƒ¼ãƒ„ã‚„ãƒ¬ã‚·ãƒ”ã«ã¤ã„ã¦èã„ã¦ã¿ã‚ˆã†ï¼" },
  { keyword: 'æ¨ã—æ´»', pattern: /æ¨ã—æ´»|ã‚¢ã‚¤ãƒ‰ãƒ«å¿œæ´|ã‚°ãƒƒã‚ºé›†ã‚|ãƒ©ã‚¤ãƒ–å‚æˆ¦|å¥½ããªã‚­ãƒ£ãƒ©ã«å…¨åŠ›|æ²¼ã‚‹/, msg: "\ud83d\udc96 æ¨ã—ã®é­…åŠ›ã‚’ç†±ãèªã£ã¦ã‚‚ã‚‰ã†ã¨å–œã¶ã‹ã‚‚ï¼" },
  { keyword: 'Vlog', pattern: /Vlog|æ˜ åƒæ—¥è¨˜|å‹•ç”»ç·¨é›†|æ—¥å¸¸è¨˜éŒ²|YouTubeæŠ•ç¨¿|ç·¨é›†ã‚½ãƒ•ãƒˆ|æ—¥å¸¸ã‚’åˆ‡ã‚Šå–ã‚‹/, msg: "\ud83d\udcc9 ç·¨é›†ã‚½ãƒ•ãƒˆã‚„ã“ã ã‚ã‚Šãƒã‚¤ãƒ³ãƒˆã‚’èãã¨è©±ãŒåºƒãŒã‚‹ã‹ã‚‚ï¼" },
  { keyword: 'èˆå°', pattern: /èˆå°|æ¼”åŠ‡|åŠ‡å›£|èˆå°ä¿³å„ª|è¦³åŠ‡|2.5æ¬¡å…ƒ|ãƒŸãƒ¥ãƒ¼ã‚¸ã‚«ãƒ«/, msg: "\ud83c\udfad æœ€è¿‘è¦³ãŸä½œå“ã¨ã‹ã€å½¹è€…ã•ã‚“ã®è©±é¡ŒãŒãƒãƒã‚‹ã‹ã‚‚ï¼" }
];

// â†“ æ¤œå‡ºå‡¦ç†
for (const item of hobbyExtensionPatterns) {
  if (combined.includes(item.keyword) || item.pattern.test(combined)) {
    hobbyExtensions.push(item.msg);
  }
}

if (hobbyExtensions.length > 0) {
  resultLines.push(`<div style="margin-top:12px;">ã“ã®è©±é¡Œã‚’æŒ¯ã£ã¦ã¿ã‚ˆã†ğŸ‘‡</div>`);
  resultLines.push(`
    <div style="
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 8px 4px;
      line-height: 1.7;
      word-break: keep-all;
      overflow-wrap: break-word;
    ">
      ${hobbyExtensions.map(line => `<div style="white-space: normal;">${line}</div>`).join('')}
    </div>
  `);
}


  localStorage.setItem('my_mbti', type);
  const mbtiEl = document.getElementById('mbti-type');
if (mbtiEl) mbtiEl.innerText = type;

  document.getElementById('diagnosis-result').innerHTML = resultLines.join('');
  document.getElementById('diagnosis-modal').style.display = 'flex';

  document.getElementById('diagnosis-modal').addEventListener('click', () => {
    document.getElementById('diagnosis-modal').style.display = 'none';
  });
}
window.dispatchEvent(new Event('DOMContentLoaded'));

</script>



</script>

<!-- Chart.js èª­ã¿è¾¼ã¿ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- â–¼ åˆ©ç”¨è¦ç´„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="terms-modal" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background-color: rgba(0,0,0,0.6);
  z-index: 9999;
  padding: 40px 16px;
  box-sizing: border-box;
  justify-content: center;
  align-items: center;
">
  <!-- âœ… ç™½ã„è¦ç´„ãƒœãƒƒã‚¯ã‚¹ -->
  <div style="
    background: white;
    border-radius: 12px;
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    font-size: 14px;
    font-family: sans-serif;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  ">

    <!-- â–¼ è¦ç´„æœ¬æ–‡ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼‰ -->
    <div style="
      padding: 24px;
      overflow-y: auto;
      max-height: 70vh;
      line-height: 1.8;
    ">
      <h2 style="text-align: center;">åˆ©ç”¨è¦ç´„</h2>
      <p>ã“ã®åˆ©ç”¨è¦ç´„ï¼ˆä»¥ä¸‹ã€Œæœ¬è¦ç´„ã€ã¨ã„ã„ã¾ã™ï¼‰ã¯ã€[ã‚µãƒ¼ãƒ“ã‚¹å]ï¼ˆä»¥ä¸‹ã€Œæœ¬ã‚µãƒ¼ãƒ“ã‚¹ã€ã¨ã„ã„ã¾ã™ï¼‰ã‚’åˆ©ç”¨ã™ã‚‹å…¨ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆä»¥ä¸‹ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã¨ã„ã„ã¾ã™ï¼‰ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã®åˆ©ç”¨ã«ã‚ãŸã£ã¦ã¯ã€æœ¬è¦ç´„ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã¿ãªã—ã¾ã™ã€‚</p>

      <p><strong>ç¬¬1æ¡ï¼ˆé©ç”¨ç¯„å›²ï¼‰</strong><br>æœ¬è¦ç´„ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ¬ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹éš›ã®ã™ã¹ã¦ã®è¡Œç‚ºã«é©ç”¨ã•ã‚Œã¾ã™ã€‚</p>
      <p><strong>ç¬¬2æ¡ï¼ˆã‚µãƒ¼ãƒ“ã‚¹å†…å®¹ï¼‰</strong><br>æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚„ç”»åƒç­‰ã‚’è‡ªç”±ã«å…¥åŠ›ãƒ»ç·¨é›†ã—ã€ååˆºé¢¨ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆãƒ»å…±æœ‰ã™ã‚‹ãŸã‚ã®Webãƒ„ãƒ¼ãƒ«ã§ã™ã€‚</p>
      <p><strong>ç¬¬3æ¡ï¼ˆç¦æ­¢äº‹é …ï¼‰</strong><br>
        1. è™šå½ã®æƒ…å ±ã‚’å…¥åŠ›ã™ã‚‹è¡Œç‚º<br>
        2. ä»–è€…ã®æ¨©åˆ©ã‚’ä¾µå®³ã™ã‚‹è¡Œç‚ºï¼ˆè‘—ä½œæ¨©ã€è‚–åƒæ¨©ã€å•†æ¨™æ¨©ãªã©ï¼‰<br>
        3. ã‚ã„ã›ã¤ã€æš´åŠ›çš„ã€å·®åˆ¥çš„ã€ãã®ä»–å…¬åºè‰¯ä¿—ã«åã™ã‚‹æƒ…å ±ã®æŠ•ç¨¿<br>
        4. æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã®é‹å–¶ã‚’å¦¨ã’ã‚‹è¡Œç‚º<br>
        5. æ³•ä»¤é•åã¨ãªã‚‹ä¸€åˆ‡ã®è¡Œç‚º
      </p>
      <p><strong>ç¬¬4æ¡ï¼ˆè‡ªå·±è²¬ä»»ï¼‰</strong><br>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€è‡ªã‚‰ã®è²¬ä»»ã«ãŠã„ã¦æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹ã‚‚ã®ã¨ã—ã€æŠ•ç¨¿ãƒ»å…¥åŠ›ãƒ»ç”Ÿæˆã•ã‚ŒãŸå†…å®¹ã‚„ç¬¬ä¸‰è€…ã¨ã®é–“ã§ç”Ÿã˜ãŸãƒˆãƒ©ãƒ–ãƒ«ãƒ»æå®³ã«ã¤ã„ã¦ã€å½“æ–¹ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</p>
      <p><strong>ç¬¬5æ¡ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã®åœæ­¢ãƒ»å¤‰æ›´ï¼‰</strong><br>æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€äºˆå‘Šãªãå†…å®¹ã®å¤‰æ›´ãƒ»åœæ­¢ãƒ»çµ‚äº†ã‚’è¡Œã†å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ç¬¬ä¸‰è€…ã«æå®³ãŒç™ºç”Ÿã—ãŸå ´åˆã§ã‚‚ã€å½“æ–¹ã¯ä¸€åˆ‡è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</p>
      <p><strong>ç¬¬6æ¡ï¼ˆè‘—ä½œæ¨©ãƒ»çŸ¥çš„è²¡ç”£æ¨©ï¼‰</strong><br>æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã«é–¢é€£ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è‘—ä½œæ¨©ã¯ã€å½“æ–¹ã¾ãŸã¯æ­£å½“ãªæ¨©åˆ©ã‚’æœ‰ã™ã‚‹ç¬¬ä¸‰è€…ã«å¸°å±ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»ç”Ÿæˆã—ãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«é–¢ã—ã¦ã¯ã€å½“æ–¹ãŒã‚µãƒ¼ãƒ“ã‚¹é‹å–¶ä¸Šã®ç¯„å›²å†…ã§ä½¿ç”¨ã§ãã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚</p>
      <p><strong>ç¬¬7æ¡ï¼ˆå…è²¬äº‹é …ï¼‰</strong><br>å½“æ–¹ã¯ã€æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã«äº‹å®Ÿä¸Šã¾ãŸã¯æ³•å¾‹ä¸Šã®ç‘•ç–µï¼ˆå®‰å…¨æ€§ã€ä¿¡é ¼æ€§ã€æ­£ç¢ºæ€§ã€å®Œå…¨æ€§ã€ç‰¹å®šã®ç›®çš„ã¸ã®é©åˆæ€§ãªã©ï¼‰ãŒãªã„ã“ã¨ã‚’æ˜ç¤ºçš„ã«ã‚‚é»™ç¤ºçš„ã«ã‚‚ä¿è¨¼ã—ã¾ã›ã‚“ã€‚ã¾ãŸã€ã‚·ã‚¹ãƒ†ãƒ éšœå®³ã‚„ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ç­‰ã«ã‚ˆã£ã¦ç™ºç”Ÿã—ãŸæå®³ã«ã¤ã„ã¦ã‚‚è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</p>
      <p><strong>ç¬¬8æ¡ï¼ˆå€‹äººæƒ…å ±ï¼‰</strong><br>æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€å€‹äººæƒ…å ±ã®åé›†ãƒ»ä¿å­˜ã¯åŸå‰‡ã¨ã—ã¦è¡Œã„ã¾ã›ã‚“ã€‚ãŸã ã—ã€å¿…è¦ã«å¿œã˜ã¦ä¿å­˜ã•ã‚Œã‚‹æƒ…å ±ã«ã¤ã„ã¦ã¯ã€é©åˆ‡ã«ç®¡ç†ã—ç¬¬ä¸‰è€…ã«æä¾›ã—ã¾ã›ã‚“ã€‚</p>
      <p><strong>ç¬¬9æ¡ï¼ˆè¦ç´„ã®å¤‰æ›´ï¼‰</strong><br>æœ¬è¦ç´„ã¯ã€å½“æ–¹ã®åˆ¤æ–­ã«ã‚ˆã‚Šå¤‰æ›´ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚å¤‰æ›´å¾Œã®è¦ç´„ã¯ã€æœ¬ã‚µãƒ¼ãƒ“ã‚¹ä¸Šã«æ²è¼‰ã•ã‚ŒãŸæ™‚ç‚¹ã§åŠ¹åŠ›ã‚’æŒã¡ã¾ã™ã€‚</p>
      <p><strong>ç¬¬10æ¡ï¼ˆæº–æ‹ æ³•ãƒ»ç®¡è½„ï¼‰</strong><br>æœ¬è¦ç´„ã®è§£é‡ˆãŠã‚ˆã³é©ç”¨ã¯æ—¥æœ¬æ³•ã«æº–æ‹ ã—ã€æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã«é–¢é€£ã™ã‚‹ç´›äº‰ã¯ã€[é‹å–¶æ‹ ç‚¹ã‚’ç½®ãåœ°åŸŸ]ã®ç®¡è½„è£åˆ¤æ‰€ã‚’ç¬¬ä¸€å¯©ã®å°‚å±çš„åˆæ„ç®¡è½„è£åˆ¤æ‰€ã¨ã—ã¾ã™ã€‚</p>
      <p><strong>ç¬¬11æ¡ï¼ˆå•†ç”¨åˆ©ç”¨ã®ç¦æ­¢ã¨äº‹å‰é€£çµ¡ï¼‰</strong><br>æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã¯åŸå‰‡ã¨ã—ã¦éå–¶åˆ©ç›®çš„ã§ã®å€‹äººåˆ©ç”¨ã®ã¿ã‚’è¨±å¯ã—ã¾ã™ã€‚ä¼æ¥­ã€æ³•äººã€å›£ä½“ã€ã¾ãŸã¯ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚µãƒ¼ç­‰ãŒå•†ç”¨ç›®çš„ã§åˆ©ç”¨ã™ã‚‹å ´åˆã¯ã€å¿…ãšäº‹å‰ã«å½“æ–¹ã«é€£çµ¡ã—ã€æ›¸é¢ç­‰ã«ã‚ˆã‚‹è¨±å¯ã‚’å¾—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚ç„¡æ–­ã§å•†ç”¨åˆ©ç”¨ãŒè¡Œã‚ã‚ŒãŸå ´åˆã«ã¯ã€å½“æ–¹ã¯åˆ©ç”¨ã®å·®æ­¢ã‚ã‚„æå®³è³ å„Ÿè«‹æ±‚ç­‰ã®æ³•çš„æªç½®ã‚’ã¨ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</p>

      <p style="text-align: right;">åˆ¶å®šæ—¥ï¼š2025å¹´7æœˆ10æ—¥</p>
    </div>

   <!-- âœ… ä¸‹éƒ¨ãƒœã‚¿ãƒ³ãƒãƒ¼ -->
    <div style="
      padding: 16px 24px 40px 24px; 
      border-top: 1px solid #ccc;
      background: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 24px;
    ">
      <label style="display: flex; align-items: center; flex: 1;">
        <input type="checkbox" id="agree-checkbox" style="margin-right: 10px;">
        åˆ©ç”¨è¦ç´„ã«åŒæ„ã—ã¾ã™
      </label>
  <button onclick="closeTermsModal()" style="
  padding: 10px 20px;
  border-radius: 8px;
  background: linear-gradient(135deg, #ffe6f0, #d6f2f9);
  color: #c2185b;
  font-weight: bold;
  font-family: 'Rounded Mplus 1c', 'Hiragino Maru Gothic ProN', sans-serif;
  border: none;
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  transition: all 0.2s ease-in-out;
  cursor: pointer;
">é–‰ã˜ã‚‹</button>
    </div>

  </div>
</div>
<!-- ğŸŒ¸ åˆ©ç”¨è¦ç´„é€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…ˆã«å‡ºã‚‹ã‚„ã¤ï¼‰ -->
<!-- ğŸŒ¸ åˆ©ç”¨è¦ç´„é€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…ˆã«å‡ºã‚‹ã‚„ã¤ï¼‰ -->
<div id="terms-notice" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center;">
  <div style="background: #fff0f4; padding: 24px; border-radius: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.2); text-align: center; max-width: 280px;">
    <div style="font-weight: bold; font-size: 18px; margin-bottom: 16px;">åˆ©ç”¨è¦ç´„ã«åŒæ„ã—ã¦ãã ã•ã„ã€‚</div>
    <div style="display: flex; justify-content: space-between;">
      <button id="notice-agree-btn" style="flex: 1; margin-right: 10px; background: #ffa5ba; color: white; border: none; border-radius: 8px; padding: 10px 0;">åŒæ„ã™ã‚‹</button>
      <button id="notice-close-btn" style="flex: 1; background: #aaa; color: white; border: none; border-radius: 8px; padding: 10px 0;">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>


<script>
  function closeTermsModal() {
    document.getElementById('terms-modal').style.display = 'none';
  }

  function showCuteAlert(message) {
    document.getElementById('cute-alert-message').textContent = message;
    document.getElementById('cute-alert').style.display = 'flex';
  }

  function closeCuteAlert() {
    document.getElementById('cute-alert').style.display = 'none';
  }

  document.addEventListener('DOMContentLoaded', () => {
    // ä½œæˆãƒœã‚¿ãƒ³ï¼ˆï¼finish-buttonï¼‰ã‚’æŠ¼ã—ãŸã¨ã
    document.getElementById('finish-button').addEventListener('click', () => {
      const checkbox = document.getElementById('agree-checkbox');
      if (checkbox && checkbox.checked) {
        // âœ… ãƒã‚§ãƒƒã‚¯ãŒå…¥ã£ã¦ãŸã‚‰ç›´æ¥ä½œæˆãƒœã‚¿ãƒ³å‡¦ç†ã¸ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ã‹ãšï¼‰
        document.getElementById('terms-modal').style.display = 'none';
        document.getElementById('create-button').click(); // â† ğŸ”´ ã“ã‚ŒãŒè¿½åŠ ã•ã‚ŒãŸéƒ¨åˆ†ï¼
      } else {
        // âŒ ãƒã‚§ãƒƒã‚¯ãŒãªã‘ã‚Œã°ã¾ãšé€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        document.getElementById('terms-notice').style.display = 'flex';
      }
    });

    // é€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã€ŒåŒæ„ã™ã‚‹ã€ â†’ é€šçŸ¥é–‰ã˜ã¦è¦ç´„ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    document.getElementById('notice-agree-btn').addEventListener('click', () => {
      document.getElementById('terms-notice').style.display = 'none';
      document.getElementById('terms-modal').style.display = 'flex';
    });

    // é€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã€Œé–‰ã˜ã‚‹ã€ â†’ é€šçŸ¥ã ã‘éè¡¨ç¤ºã«
    document.getElementById('notice-close-btn').addEventListener('click', () => {
      document.getElementById('terms-notice').style.display = 'none';
    });
  });
</script>

<script>



  
function analyzeSelfPR() {
  const textarea = document.getElementById('self-pr-textarea');
  const text = textarea.value.trim().toLowerCase();
  if (!text) {
    alert('è‡ªå·±PRã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼');
    return;
  }

  const labels = ['å‹‰å­¦', 'ã‚¹ãƒãƒ¼ãƒ„', 'ã‚³ãƒŸãƒ¥åŠ›', 'å‰µé€ åŠ›', 'å¿è€åŠ›'];
  const baseScore = 70;
  const maxScore = 120;

  // å„é …ç›®ã®åˆæœŸã‚¹ã‚³ã‚¢
  let scores = labels.map(() => baseScore);

 const wordModifiers = {
  'å‹‰å­¦': [
    { word: 'å­¦æ¥­', value: 10 },
    { word: 'å‹‰å¼·', value: 10 },
    { word: 'è³‡æ ¼', value: 15 },
    { word: 'çœŸé¢ç›®', value: 5 },
    { word: 'é…åˆ»', value: -10 },
    { word: 'æˆæ¥­', value: 10 },
    { word: 'å‡ºå¸­', value: 10 },
    { word: 'ãƒ¬ãƒãƒ¼ãƒˆ', value: 5 },
    { word: 'äºˆç¿’', value: 10 },
    { word: 'å¾©ç¿’', value: 10 },
    { word: 'åŠªåŠ›å®¶', value: 10 },
    { word: 'å‹‰å­¦ã«åŠ±ã‚€', value: 10 },
    { word: 'èª²é¡Œæå‡º', value: 10 },
    { word: 'ã‚¼ãƒŸ', value: 5 },
    { word: 'ç ”ç©¶å®¤', value: 10 },
    { word: 'æˆç¸¾', value: 10 },
    { word: 'ãƒ†ã‚¹ãƒˆå‹‰å¼·', value: 10 },
    { word: 'ç†è§£åŠ›', value: 10 }
  ],
  'ã‚¹ãƒãƒ¼ãƒ„': [
    { word: 'é‹å‹•', value: 10 },
    { word: 'ã‚¹ãƒãƒ¼ãƒ„', value: 15 },
    { word: 'éƒ¨æ´»', value: 10 },
    { word: 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒã‚¤', value: 20 },
    { word: 'ä½“åŠ›ãŒãªã„', value: -10 },
    { word: 'ä½“è‚²ä¼š', value: 10 },
    { word: 'ç­‹ãƒˆãƒ¬', value: 10 },
    { word: 'æŒä¹…åŠ›', value: 10 },
    { word: 'å‹è² ', value: 5 },
    { word: 'ãƒãƒ¼ãƒ ãƒ—ãƒ¬ãƒ¼', value: 10 },
    { word: 'å¤§ä¼š', value: 10 },
    { word: 'é‹å‹•ç¿’æ…£', value: 5 },
    { word: 'èµ°ã‚‹ã®ãŒå¥½ã', value: 10 },
    { word: 'ã‚¹ãƒãƒ¼ãƒ„è¦³æˆ¦', value: 5 },
    { word: 'ãƒ•ã‚£ã‚¸ã‚«ãƒ«', value: 10 },
    { word: 'æœç·´', value: 10 }
  ],
  'ã‚³ãƒŸãƒ¥åŠ›': [
    { word: 'äººã¨è©±ã™ã®ãŒå¥½ã', value: 10 },
    { word: 'åˆå¯¾é¢', value: 5 },
    { word: 'ç·Šå¼µã—ã‚„ã™ã„', value: -10 },
    { word: 'ç©æ¥µçš„ã«ä¼šè©±', value: 15 },
    { word: 'èãä¸Šæ‰‹', value: 10 },
    { word: 'é›‘è«‡', value: 5 },
    { word: 'ä¼šè©±åŠ›', value: 10 },
    { word: 'ç››ã‚Šä¸Šã’å½¹', value: 10 },
    { word: 'ç©ºæ°—ã‚’èª­ã‚€', value: 10 },
    { word: 'è©±ã—ã‹ã‘ã‚‹', value: 10 },
    { word: 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¾—æ„', value: 10 },
    { word: 'å¯¾è©±', value: 10 },
    { word: 'è©±ã™ã®ãŒè‹¦æ‰‹', value: -10 },
    { word: 'ä»²é–“ã¨å”åŠ›', value: 10 },
    { word: 'ä¼šè©±ã«å…¥ã‚Œãªã„', value: -5 },
    { word: 'å¸ä¼šçµŒé¨“', value: 10 }
  ],
  'å‰µé€ åŠ›': [
    { word: 'ã‚¢ã‚¤ãƒ‡ã‚¢', value: 10 },
    { word: 'ç‹¬è‡ª', value: 10 },
    { word: 'ç™ºæƒ³', value: 15 },
    { word: 'ä¼ç”»', value: 10 },
    { word: 'æŸ”è»Ÿãªæ€è€ƒ', value: 15 },
    { word: 'å‰µä½œ', value: 10 },
    { word: 'è¡¨ç¾', value: 10 },
    { word: 'ãƒ‡ã‚¶ã‚¤ãƒ³', value: 10 },
    { word: 'æ§‹æƒ³', value: 10 },
    { word: 'è©¦è¡ŒéŒ¯èª¤', value: 10 },
    { word: 'ã‚¼ãƒ­ã‹ã‚‰è€ƒãˆã‚‹', value: 15 },
    { word: 'ã²ã‚‰ã‚ã', value: 10 },
    { word: 'ç™ºæ˜', value: 10 },
    { word: 'å‰µæ„å·¥å¤«', value: 15 },
    { word: 'è‡ªç”±ãªç™ºæƒ³', value: 10 }
  ],
  'å¿è€åŠ›': [
    { word: 'æˆ‘æ…¢å¼·ã„', value: 15 },
    { word: 'ç²˜ã‚Šå¼·ã„', value: 15 },
    { word: 'ç¶™ç¶š', value: 10 },
    { word: 'é›†ä¸­åŠ›', value: 10 },
    { word: 'ã™ãè«¦ã‚ã‚‹', value: -15 },
    { word: 'è² ã‘ãšå«Œã„', value: 10 },
    { word: 'åŠªåŠ›', value: 10 },
    { word: 'è€ãˆã‚‹', value: 10 },
    { word: 'å¤±æ•—ã—ã¦ã‚‚æŒ‘æˆ¦', value: 15 },
    { word: 'ã‚³ãƒ„ã‚³ãƒ„', value: 10 },
    { word: 'é•·æœŸé–“ã®å–ã‚Šçµ„ã¿', value: 10 },
    { word: 'ç¶™ç¶šã¯åŠ›ãªã‚Š', value: 15 },
    { word: 'ç²¾ç¥çš„ã«ã‚¿ãƒ•', value: 10 },
    { word: 'è«¦ã‚ãšã«ç¶šã‘ãŸ', value: 15 }
  ]
};


  // è£œæ­£ã‚’åŠ ãˆã‚‹
  labels.forEach((label, i) => {
    wordModifiers[label].forEach(({ word, value }) => {
      if (text.includes(word)) scores[i] += value;
    });
    if (scores[i] > maxScore) scores[i] = maxScore;
    if (scores[i] < 0) scores[i] = 0;
  });

  const goldData = scores.map(s => s > 100 ? s : 0);

  // ã‚³ãƒ¡ãƒ³ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå®šç¾©
  const commentTemplates = {
  'å‹‰å­¦': score => {
    if (score >= 100) return 'çŸ¥è­˜ã®æ¢ç©¶è€…ï¼å­¦ã³ã«è²ªæ¬²ã§æˆç¸¾å„ªç§€ï¼';
    if (score >= 85) return 'å­¦ã¶å§¿å‹¢ãŒã—ã£ã‹ã‚Šã—ã¦ã„ã‚‹ã‚¿ã‚¤ãƒ—ï¼';
    if (score >= 70) return 'ã¾ã˜ã‚ã«å­¦æ¥­ã«å–ã‚Šçµ„ã‚€ã‚¿ã‚¤ãƒ—ï¼';
    return 'åŠªåŠ›æ¬¡ç¬¬ã§å¤§ããä¼¸ã³ã‚‹ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚ã‚Šï¼';
  },
  'ã‚¹ãƒãƒ¼ãƒ„': score => {
    if (score >= 100) return 'é‹å‹•ç¥çµŒæŠœç¾¤ï¼ã‚¢ã‚¹ãƒªãƒ¼ãƒˆæ°—è³ªï¼';
    if (score >= 85) return 'èº«ä½“ã‚’å‹•ã‹ã™ã®ãŒå¾—æ„ãªã‚¿ã‚¤ãƒ—ï¼';
    if (score >= 70) return 'åŸºæœ¬çš„ãªé‹å‹•ã¯ã“ãªã›ã‚‹ã‚¿ã‚¤ãƒ—ï¼';
    return 'é‹å‹•ã¯å°‘ã—è‹¦æ‰‹ã ãŒåŠªåŠ›ã§ã‚«ãƒãƒ¼ï¼';
  },
  'ã‚³ãƒŸãƒ¥åŠ›': score => {
    if (score >= 100) return 'èª°ã¨ã§ã‚‚ä»²è‰¯ããªã‚Œã‚‹å¤©æ‰çš„ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚¿ãƒ¼ï¼';
    if (score >= 85) return 'äººã¨ã®è·é›¢ã‚’ç¸®ã‚ã‚‹ã®ãŒå¾—æ„ï¼';
    if (score >= 70) return 'å¿…è¦ã«å¿œã˜ã¦ä¼šè©±ã‚’åºƒã’ã‚‰ã‚Œã‚‹ã‚¿ã‚¤ãƒ—ï¼';
    return 'ä¼šè©±ã¯ã‚„ã‚„è‹¦æ‰‹ã ãŒã€èª å®Ÿã«å‘ãåˆãˆã‚‹ï¼';
  },
  'å‰µé€ åŠ›': score => {
    if (score >= 100) return 'ç‹¬å‰µçš„ãªç™ºæƒ³ã§å‘¨å›²ã‚’é©šã‹ã›ã‚‹ç™ºæ˜å®¶ï¼';
    if (score >= 85) return 'æŸ”è»Ÿã§è±Šã‹ãªç™ºæƒ³ãŒã§ãã‚‹ã‚¿ã‚¤ãƒ—ï¼';
    if (score >= 70) return 'æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å‡ºã™ã®ãŒå¥½ããªã‚¿ã‚¤ãƒ—ï¼';
    return 'è€ƒãˆã‚‹åŠ›ã‚’ç£¨ã‘ã°ã€æ‰èƒ½ãŒé–‹èŠ±ã™ã‚‹ã‚¿ã‚¤ãƒ—ï¼';
  },
  'å¿è€åŠ›': score => {
    if (score >= 100) return 'ã©ã‚“ãªå›°é›£ã«ã‚‚ç«‹ã¡å‘ã‹ã†é‰„ã®ãƒ¡ãƒ³ã‚¿ãƒ«ï¼';
    if (score >= 85) return 'ã‚³ãƒ„ã‚³ãƒ„åŠªåŠ›ã‚’ç©ã¿é‡ã­ã‚‹ã‚¿ã‚¤ãƒ—ï¼';
    if (score >= 70) return 'ç²˜ã‚Šå¼·ãå–ã‚Šçµ„ã‚ã‚‹ã‚¿ã‚¤ãƒ—ï¼';
    return 'æŒç¶šåŠ›ã‚’ã¤ã‘ã‚Œã°å¤§ããªåŠ›ã«å¤‰ã‚ã‚‹ï¼';
  }
};

  // ãƒãƒ£ãƒ¼ãƒˆæç”»
  if (window.selfPrChart) window.selfPrChart.destroy();
  const ctx = document.getElementById('resultChart').getContext('2d');
  window.selfPrChart = new Chart(ctx, {
    type: 'radar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'åˆ†æçµæœ',
          data: scores,
          fill: true,
          borderColor: 'rgba(54, 162, 235, 1)',
          backgroundColor: 'rgba(54, 162, 235, 0.3)',
          pointBackgroundColor: 'rgba(54, 162, 235, 1)'
        },
        {
          label: '100ç‚¹è¶…ãˆå¼·èª¿',
          data: goldData,
          fill: true,
          borderColor: 'gold',
          backgroundColor: 'rgba(255, 215, 0, 0.4)',
          pointBackgroundColor: 'gold',
          borderWidth: 3
        }
      ]
    },
    options: {
      responsive: false,
      scales: {
        r: {
          min: 0,
          max: 120,
          ticks: {
            stepSize: 20,
            display: false
          }
        }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });
  document.getElementById('self-pr-comment').innerHTML = '';

  let commentHTML = '';
  const addedLabels = new Set(); // ğŸ‘ˆ é‡è¤‡é˜²æ­¢ã®ãŸã‚ã«Setã‚’ä½¿ã†

  labels.forEach((label, i) => {
    if (addedLabels.has(label)) return; // ğŸ‘ˆ ã™ã§ã«è¡¨ç¤ºã—ãŸãƒ©ãƒ™ãƒ«ã¯ã‚¹ã‚­ãƒƒãƒ—
    addedLabels.add(label);

    const score = scores[i];
    const comment = commentTemplates[label](score);

    const scoreStyle = score > 100
      ? 'color: gold; text-shadow: 0 0 5px gold; font-weight: bold;'
      : '';

    commentHTML += `
      <div style="margin-bottom: 6px;">
        <strong>${label}ï¼š</strong><span style="${scoreStyle}">${score}ç‚¹</span><br>
        <span style="font-size: 14px;">${comment}</span>
      </div>
    `;
  });

  document.getElementById('self-pr-comment').innerHTML = commentHTML;

  // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  document.getElementById('self-pr-modal').style.display = 'flex';
  }
</script>
<script>
  // Enterã‚­ãƒ¼ã§æ¬¡ã®æ¬„ã¸ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç§»å‹•ï¼ˆãŸã ã— textarea ã¯é™¤ãï¼‰
  document.addEventListener('DOMContentLoaded', function () {
    const inputs = Array.from(document.querySelectorAll('.editable-text'));

    inputs.forEach((input, index) => {
      input.addEventListener('keydown', function (e) {
        // textarea ã ã£ãŸã‚‰æ”¹è¡Œã•ã›ã‚‹ï¼ˆå‡¦ç†ã—ãªã„ï¼‰
        if (input.tagName.toLowerCase() === 'textarea') return;

        if (e.key === 'Enter') {
          e.preventDefault();
          const next = inputs[index + 1];
          if (next) {
            next.focus();
          }
        }
      });
    });
  });
<!-- ğŸ”½ JavaScriptã¯ã“ã® <script> ã®ä¸­ã«å…¨éƒ¨å…¥ã‚Œã‚‹ï¼ -->

document.addEventListener('DOMContentLoaded', () => {
  const isFinalPage = window.location.href.includes('/user_cards/');
  let editMode = !isFinalPage; // å®Œæˆãƒšãƒ¼ã‚¸ã§ã¯falseã€é€šå¸¸ãƒšãƒ¼ã‚¸ã¯true

  const editToggle = document.getElementById('edit-toggle');
  const returnToggle = document.getElementById('return-toggle');
  const toolbars = document.querySelectorAll('.toolbar, .text-style-toolbar');
  const deleteButtons = document.querySelectorAll('.sns-delete-btn, .deco-delete-btn, .text-stamp-delete-btn');
  const templateSection = document.querySelector('.deletable-templates');
  const youtubeButton = document.querySelector('.youtube-section button');
  const spotifyButton = document.querySelector('#spotify-section button');
  const youtubeInput = document.getElementById('youtube-url');
  const spotifyInput = document.getElementById('spotify-url');
  const prTemplateSection = document.querySelector('.self-pr-template-section');
  const snsExplain = document.getElementById('sns-explain');
  const updateEditMode = () => {
    toolbars.forEach(el => el.style.display = editMode ? 'flex' : 'none');
    deleteButtons.forEach(el => el.style.display = editMode ? 'block' : 'none');
    if (editToggle) editToggle.src = editMode ? '/static/open_eye.jpeg' : '/static/closed_eye.jpeg';

    if (youtubeButton) youtubeButton.style.display = editMode ? 'block' : 'none';
    if (spotifyButton) spotifyButton.style.display = editMode ? 'block' : 'none';
    if (templateSection) templateSection.style.display = editMode ? 'block' : 'none';
    if (youtubeInput) youtubeInput.style.display = editMode ? 'block' : 'none';
    if (spotifyInput) spotifyInput.style.display = editMode ? 'block' : 'none';
    if (prTemplateSection) prTemplateSection.style.display = editMode ? 'block' : 'none';
    if (snsExplain) snsExplain.style.display = editMode ? 'block' : 'none';
    // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ‡æ›¿
    if (returnToggle) {
      returnToggle.style.display = editMode ? 'none' : 'block';
    }

    // ğŸ‘‡ å®Œæˆãƒšãƒ¼ã‚¸ã ã£ãŸã‚‰ã‚¢ã‚¤ã‚³ãƒ³ã‚‚ãƒœã‚¿ãƒ³ã‚‚å…¨éƒ¨æ¶ˆã™ï¼ˆå¿µã®ãŸã‚ï¼‰
    if (isFinalPage) {
      if (editToggle) editToggle.style.display = 'none';
      if (returnToggle) returnToggle.style.display = 'none';
    }
  };

  // å®Œæˆãƒšãƒ¼ã‚¸ã§ã¯ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ã‚‚ä¸è¦
  if (!isFinalPage) {
    editToggle.addEventListener('click', () => {
      editMode = !editMode;
      updateEditMode();
    });

    returnToggle.addEventListener('click', () => {
      editMode = true;
      updateEditMode();
    });
  }

  updateEditMode(); // åˆæœŸåŒ–
});


</script>


<script>
const input = document.getElementById('scroll-text-input');
const text = document.getElementById('scrolling-text');

function activateScrolling() {
  const value = input.value.trim();
  if (value) {
    text.textContent = value;
    text.style.display = 'inline-block';
    input.style.display = 'none';
  }
}

function enableEditing() {
  input.style.display = 'block';
  text.style.display = 'none';
  input.focus();
}

input.addEventListener('keypress', e => {
  if (e.key === 'Enter') {
    activateScrolling();
  }
});

input.addEventListener('blur', activateScrolling);

// â† ã“ã“è¿½åŠ ï¼šæµã‚Œã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ¼ã™ã¨å†ç·¨é›†ã§ãã‚‹
text.addEventListener('click', enableEditing);
</script>
<script type="module">
  /***********************
   *  ğŸ”” Global log helpers
   ***********************/
  const T0 = performance.now();
  const L = (tag, ...args) => console.log(`[${((performance.now()-T0)/1000).toFixed(3)}s][${tag}]`, ...args);
  const W = (tag, ...args) => console.warn(`[${((performance.now()-T0)/1000).toFixed(3)}s][${tag}]`, ...args);
  const E = (tag, ...args) => console.error(`[${(performance.now()-T0).toFixed(0)}ms][${tag}]`, ...args);
  window.addEventListener('error', (ev) => E('window.error', ev.message, ev.filename+':'+ev.lineno+':'+ev.colno, ev.error));
  window.addEventListener('unhandledrejection', (ev) => E('unhandledrejection', ev.reason));

  /***********************
   *  ğŸ”¥ Firebase
   ***********************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBCnMBQjzoxViJPv3YqpZDD_PXQEe2QTsA",
    authDomain: "nfc-card-app-79464.firebaseapp.com",
    projectId: "nfc-card-app-79464",
    storageBucket: "nfc-card-app-79464.appspot.com",
    messagingSenderId: "200343990188",
    appId: "1:200343990188:web:d65e97e3df92f3afb91409"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const storage = getStorage(app, "gs://nfc-card-app-79464");
  L('BOOT', 'Firebase initialized');

  /***********************
   *  ğŸ§° Utils
   ***********************/
  const makeId = () => {
    if (globalThis.crypto?.randomUUID) return crypto.randomUUID();
    const u8 = new Uint8Array(16);
    (globalThis.crypto?.getRandomValues ?? ((a)=>a.forEach((_,i)=>a[i]=Math.random()*256|0)))(u8);
    u8[6] = (u8[6] & 0x0f) | 0x40;
    u8[8] = (u8[8] & 0x3f) | 0x80;
    return [...u8].map((b,i)=>([4,6,8,10].includes(i)?'-':'')+b.toString(16).padStart(2,'0')).join('');
  };
  const pathFromUrl = (url) => {
    try { const p = new URL(url).pathname.split("/o/")[1].split("?")[0]; return decodeURIComponent(p); }
    catch { return null; }
  };
  const bust = (url) => url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();

  async function withRetry(fn, tries = 3, delay = 200) {
    let last;
    for (let i = 0; i < tries; i++) {
      try { return await fn(); }
      catch (e) { last = e; W('withRetry', `try ${i+1}/${tries} failed`, e); if (i < tries - 1) await new Promise(r => setTimeout(r, delay * (i+1))); }
    }
    throw last;
  }

  // ç”»åƒã‚’JPEGã«å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆiOSå®‰å®šåŒ–ï¼‰â€»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«/èƒŒæ™¯ã®ã¿ã§ä½¿ç”¨
  async function forceJpegBlob(fileOrBlob, maxDim = 2560) {
    L('forceJpegBlob.start', { size: fileOrBlob.size, type: fileOrBlob.type });
    const objUrl = URL.createObjectURL(fileOrBlob);
    try {
      const img = await new Promise((resolve, reject) => {
        const im = new Image();
        im.onload = () => resolve(im);
        im.onerror = reject;
        im.src = objUrl;
      });
      let w = img.naturalWidth || img.width, h = img.naturalHeight || img.height;
      L('forceJpegBlob.loaded', { w, h });

      if (Math.max(w, h) > maxDim) {
        const s = maxDim / Math.max(w,h); w = Math.round(w*s); h = Math.round(h*s);
        L('forceJpegBlob.resize', { w, h });
      }
      const cv = document.createElement('canvas'); cv.width = w; cv.height = h;
      const ctx = cv.getContext('2d', { alpha: true });
      ctx.drawImage(img, 0, 0, w, h);

      const jpegBlob = await new Promise((res, rej) => cv.toBlob(b => b?res(b):rej(new Error('toBlob null')), 'image/jpeg', 0.9));
      L('forceJpegBlob.done', { size: jpegBlob.size });

      ctx.clearRect(0,0,w,h); cv.width = 0; cv.height = 0;
      return jpegBlob;
    } finally { URL.revokeObjectURL(objUrl); }
  }

  /* â˜…â˜…â˜… ã“ã“ã‹ã‚‰è¿½åŠ ï¼ˆé€éä¿æŒã®ãŸã‚ã®å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰é–¢æ•°ï¼‰â˜…â˜…â˜… */
  async function reencodePreservingAlpha(fileOrBlob, maxDim = 2560) {
    L('reencodePreservingAlpha.start', { size: fileOrBlob.size, type: fileOrBlob.type });
    const objUrl = URL.createObjectURL(fileOrBlob);
    try {
      const img = await new Promise((resolve, reject) => {
        const im = new Image();
        im.onload = () => resolve(im);
        im.onerror = reject;
        im.src = objUrl;
      });
      let w = img.naturalWidth || img.width, h = img.naturalHeight || img.height;
      if (Math.max(w, h) > maxDim) {
        const s = maxDim / Math.max(w, h);
        w = Math.round(w * s); h = Math.round(h * s);
      }
      const cv = document.createElement('canvas'); cv.width = w; cv.height = h;
      const ctx = cv.getContext('2d', { alpha: true });
      ctx.clearRect(0, 0, w, h);
      ctx.drawImage(img, 0, 0, w, h);

      // é€éã®æœ‰ç„¡ã‚’ç°¡æ˜“åˆ¤å®šï¼ˆå°ã•ã‚é ˜åŸŸã§OKï¼‰
      let hasAlpha = false;
      try {
        const sw = Math.min(64, w), sh = Math.min(64, h);
        const { data } = ctx.getImageData(0, 0, sw, sh);
        for (let i = 3; i < data.length; i += 4) { if (data[i] < 255) { hasAlpha = true; break; } }
      } catch {
        const t = (fileOrBlob.type || '').toLowerCase();
        if (t.includes('png') || t.includes('webp')) hasAlpha = true;
      }

      const mime = hasAlpha ? 'image/png' : 'image/jpeg';
      const quality = hasAlpha ? undefined : 0.9;
      const outBlob = await new Promise((res, rej) => cv.toBlob(b => b ? res(b) : rej(new Error('toBlob null')), mime, quality));

      L('reencodePreservingAlpha.done', { mime: mime, size: outBlob?.size });
      ctx.clearRect(0,0,w,h); cv.width = 0; cv.height = 0;
      return { blob: outBlob, mime };
    } finally {
      URL.revokeObjectURL(objUrl);
    }
  }
  /* â˜…â˜…â˜… è¿½åŠ ã“ã“ã¾ã§ â˜…â˜…â˜… */

  async function waitUntilCdnReady(url, { tries = 6, delay = 300 } = {}) {
    L('cdn.wait', { url });
    let lastErr;
    for (let i = 0; i < tries; i++) {
      try {
        const res = await fetch(bust(url), { method: 'GET', cache: 'reload' });
        if (res.ok) { L('cdn.ok', { try: i+1 }); return; }
        lastErr = new Error(`status ${res.status}`);
      } catch (e) { lastErr = e; }
      await new Promise(r => setTimeout(r, delay * (i+1)));
    }
    throw lastErr;
  }

  function hookImgDebug(imgEl, name='IMG') {
    if (!imgEl || imgEl.__hooked) return;
    imgEl.__hooked = true;
    imgEl.addEventListener('load', () => L(`${name}.load`, {
      src: imgEl.currentSrc || imgEl.src,
      naturalWidth: imgEl.naturalWidth, naturalHeight: imgEl.naturalHeight,
      width: imgEl.width, height: imgEl.height
    }));
    imgEl.addEventListener('error', (e) => E(`${name}.error`, e, imgEl.src));
  }

  async function setImgSrc(imgEl, url) {
    if (!imgEl) return;
    const finalUrl = bust(url);
    L('setImgSrc.start', { finalUrl });
    try { await waitUntilCdnReady(url); } catch(e) { W('setImgSrc.cdnSkip', e); }
    imgEl.src = '';
    await new Promise(r => requestAnimationFrame(r));
    imgEl.decoding = 'async'; imgEl.loading = 'eager'; imgEl.crossOrigin = 'anonymous';
    hookImgDebug(imgEl, 'PROFILE');
    L('setImgSrc.apply');
    imgEl.src = finalUrl;
    setTimeout(() => { if (!imgEl.naturalWidth) W('setImgSrc.timeout', { current: imgEl.currentSrc || imgEl.src }); }, 3000);
  }

  async function setBackgroundImageForce(el, url) {
    L('setBg.start', { url });
    try { await waitUntilCdnReady(url); } catch(e) { W('setBg.cdnSkip', e); }
    el.style.backgroundImage = 'none';
    void el.offsetHeight;
    const final = bust(url);
    el.style.backgroundImage = `url('${final}')`;
    el.style.backgroundRepeat = 'no-repeat';
    el.style.backgroundSize   = 'cover';
    el.style.backgroundPosition = 'center';
    L('setBg.done', { final });
  }

  /***********************
   *  âœï¸ Re-Edit mode helpers (è¿½åŠ )
   ***********************/
  function isViewPage(){
    const p = new URLSearchParams(location.search);
    const hasId = p.has('id');
    const path  = location.pathname || '';
    return hasId && (path.startsWith('/preview') || path.startsWith('/user_cards'));
  }
  function isEditMode(){
    return new URLSearchParams(location.search).get('edit') === '1';
  }
  function gotoEditMode(){
    const u = new URL(location.href);
    u.searchParams.set('edit', '1');
    location.href = u.toString();
  }
  function enableEditMode(){
    try { restoreSNS?.(); } catch {}
    try { restoreSelfPRSection?.(); } catch {}
    try { restoreSpotifySection?.(); } catch {}

    const SHOW_SELECTORS = [
      '.toolbar',
      '.text-style-toolbar',
      '.sns-delete-btn',
      '.deco-delete-btn',
      '.text-stamp-delete-btn',
      '.youtube-section button',
      '#spotify-section button',
      '#youtube-url',
      '#spotify-url',
      '#sns-explain',
      '#extra-text-wrapper .sns-delete-btn',
      '#diagnosis-wrapper .sns-delete-btn',
      '#external-link-section .sns-delete-btn',
      '#self-pr-section .sns-delete-btn',
      '#spotify-section .sns-delete-btn',
      '#pr-template-buttons',
      '.deletable-templates',
      '.self-pr-template-section'
    ];
    document.querySelectorAll(SHOW_SELECTORS.join(',')).forEach(el => {
      if (el && el.style.display === 'none') el.style.display = '';
    });

    const finishBtn = document.getElementById('finish-button');
    if (finishBtn) finishBtn.style.display = 'none';
  }

  /***********************
 *  ğŸŒ SNS Setups
 ***********************/
  const SNS_KEYS = ['instagram','line','bereal','x','tiktok'];
  const snsLinks = Object.fromEntries(SNS_KEYS.map(k => [k, '']));
  const SNS_OFFICIAL = {
    instagram: 'https://www.instagram.com/',
    line:      'https://line.me/ja/',
    bereal:    'https://bere.al/',
    x:         'https://twitter.com/',
    tiktok:    'https://www.tiktok.com/'
  };
  let __currentId = null;
  const __snsOpenedOnce = Object.fromEntries(SNS_KEYS.map(k => [k, false]));

  window.handleIconClick = function(type){
    const inp   = document.getElementById(`input-${type}`);
    const saved = (snsLinks[type] || inp?.value || '').trim();
    const first = __snsOpenedOnce[type] !== true;

    if (first) {
      __snsOpenedOnce[type] = true;
      const url = SNS_OFFICIAL[type];
      if (url) window.open(url, '_blank', 'noopener');
      return;
    }
    if (saved) {
      window.open(saved, '_blank', 'noopener');
      return;
    }
    if (inp) {
      inp.style.display = 'block';
      inp.scrollIntoView?.({ block: 'center', inline: 'nearest' });
      inp.focus();
    }
  };

  window.handleBlur = async function(type){
    const inputEl = document.getElementById(`input-${type}`);
    const v = inputEl?.value.trim() || '';
    snsLinks[type] = v;
    if (inputEl) inputEl.style.display = 'none';

    if (__currentId) {
      try {
        await setDoc(doc(db, 'cards', __currentId), { [type]: v }, { merge: true });
        L('sns.autosave', { type, v });
      } catch(e) {
        W('sns.autosave.fail', e);
      }
    }
  };

  /***********************
   *  ğŸµ YouTube / Spotify
   ***********************/
  const __URL_PARAMS = new URLSearchParams(window.location.search);
  const __ID_FOR_DRAFT = __URL_PARAMS.get('id') || 'draft';
  const LINKS_DRAFT_KEY = `fureta_draft_links_${__ID_FOR_DRAFT}`;
  const readLinksDraft  = () => JSON.parse(localStorage.getItem(LINKS_DRAFT_KEY) || "{}");
  const writeLinksDraft = (obj) => localStorage.setItem(LINKS_DRAFT_KEY, JSON.stringify(obj));

  async function saveLinks(partial){
    const merged = { ...readLinksDraft(), ...partial };
    writeLinksDraft(merged);
    if (__currentId) {
      await setDoc(doc(db, "cards", __currentId), { links: merged }, { merge: true });
      L('links.save', merged);
    } else {
      L('links.draft.save', merged);
    }
  }

  function normalizeYouTube(url){
    try{
      const u = new URL(url.replace("m.youtube.com","www.youtube.com"));
      let videoId = "";
      if (u.hostname.includes("youtu.be")) videoId = u.pathname.slice(1);
      else if (u.pathname.startsWith("/shorts/")) videoId = u.pathname.split("/")[2] || "";
      else if (u.pathname.startsWith("/embed/"))  videoId = u.pathname.split("/")[2] || "";
      else videoId = u.searchParams.get("v") || "";
      if (!videoId) return null;
      return { rawUrl: url, videoId, embedUrl: `https://www.youtube.com/embed/${videoId}` };
    } catch { return null; }
  }
  function normalizeSpotify(url){
    try{
      const u = new URL(url);
      if (!u.hostname.includes("spotify.com")) return null;
      let path = u.pathname.replace(/^\/intl-[a-z-]+\//, "/").replace(/\/$/, "");
      const [type, sid] = path.split("/").filter(Boolean);
      if (!type || !sid) return null;
      return { rawUrl: url, type, spotifyId: sid, embedUrl: `https://open.spotify.com/embed/${type}/${sid}` };
    } catch { return null; }
  }

  function renderYouTube(embedUrl){
    const el = document.getElementById('youtube-player');
    if (!el) return;
    el.innerHTML = embedUrl ? `
      <div style="border-radius:18px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.12); max-width:90vw; margin:0 auto 12px;">
        <iframe width="100%" height="200" src="${embedUrl}" frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen></iframe>
      </div>` : "";
  }
  function renderSpotify(embedUrl){
    const el = document.getElementById('spotify-player');
    if (!el) return;
    el.innerHTML = embedUrl ? `
      <iframe src="${embedUrl}" style="width: calc(100% - 40px); height: 152px; border-radius:12px; display:block; margin:0 auto;"
        frameborder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>` : "";
  }

  window.embedYouTubeVideo = async function (){
    const raw = document.getElementById('youtube-url')?.value?.trim();
    if (!raw) return;
    const norm = normalizeYouTube(raw);
    if (!norm){ alert('æ­£ã—ã„YouTubeã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); await saveLinks({ youtube:null }); return; }
    renderYouTube(norm.embedUrl);
    await saveLinks({ youtube: norm });
  };
  window.embedSpotify = async function (){
    const raw = document.getElementById('spotify-url')?.value?.trim();
    if (!raw) return;
    const norm = normalizeSpotify(raw);
    if (!norm){ alert('Spotifyã®æ­£ã—ã„URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); await saveLinks({ spotify:null }); return; }
    renderSpotify(norm.embedUrl);
    await saveLinks({ spotify: norm });
  };
  window.hideYouTubeSection = async function (){
    const i = document.getElementById('youtube-url'); if (i) i.value = '';
    renderYouTube(''); await saveLinks({ youtube:null });
  };
  window.hideSpotifySection = async function (){
    const i = document.getElementById('spotify-url'); if (i) i.value = '';
    renderSpotify(''); await saveLinks({ spotify:null });
  };

  /***********************
   *  ğŸ” å…±é€š: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å‡¦ç†
   ***********************/
  let __pfUploading = false;
  let __pfCurrentURL = '';

  async function handleProfileFile(file, { id, profileImg, profileUrlInput }) {
    if (!file || __pfUploading) return;
    __pfUploading = true;
    const oldURL = __pfCurrentURL || profileUrlInput?.value || '';
    try {
      L('profile.file(HOOK)', { name: file.name, type: file.type, size: file.size });
      const newPath = `profiles/${makeId()}`;
      const fileRef = ref(storage, newPath);

      /* â˜… å·®ã—æ›¿ãˆï¼šé€éä¿æŒã§å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆPNG or JPEGï¼‰ */
      const { blob: encodedBlob, mime } = await reencodePreservingAlpha(file);
      await uploadBytes(fileRef, encodedBlob, {
        contentType: mime,
        cacheControl: 'no-store, no-cache, must-revalidate, max-age=0'
      });
      /* â˜… ã“ã“ã¾ã§å·®ã—æ›¿ãˆ */

      L('profile.upload.OK(HOOK)');
      const url = await withRetry(() => getDownloadURL(fileRef));
      L('profile.url(HOOK)', url);
      await setImgSrc(profileImg, url);
      if (profileUrlInput) profileUrlInput.value = url;
      if (id) {
        await setDoc(doc(db, 'cards', id), { imageUrl: url }, { merge: true });
        L('profile.firestore.merge.OK(HOOK)');
      }
      if (oldURL) {
        try {
          const oldPath = pathFromUrl(oldURL);
          if (oldPath) { await deleteObject(ref(storage, oldPath)); L('profile.old.delete.OK(HOOK)'); }
        } catch (err) { W('profile.old.delete.FAIL(HOOK)', err); }
      }
      __pfCurrentURL = url;
    } catch (err) {
      E('profile.FAIL(HOOK)', err);
      alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    } finally {
      __pfUploading = false;
    }
  }

  /***********************
   *  ğŸ§© ãƒ‡ã‚³ï¼ˆã‚¹ã‚¿ãƒ³ãƒ—ï¼‰ä¿å­˜ãƒ»å¾©å…ƒ
   ***********************/
  const MAX_DECO = 5;
  const DECO_STAGE_ID = 'page-wrapper';

  // Storage ã‹ã‚‰æ¶ˆã™ã¹ããƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ï¼ˆsave æˆåŠŸå¾Œã«ã¾ã¨ã‚ã¦å‰Šé™¤ï¼‰
  const __decoPendingDeletes = new Set();

  const extFromMime = (mime) => {
    if (mime === 'image/jpeg' || mime === 'image/jpg') return 'jpg';
    if (mime === 'image/png') return 'png';
    if (mime === 'image/webp') return 'webp';
    return 'png';
  };

  // æ“ä½œä»˜ä¸
  function makeTransformable(el){
    let tx    = +el.dataset.tx    || 0;
    let ty    = +el.dataset.ty    || 0;
    let scale = +el.dataset.scale || 1;
    let rot   = +el.dataset.rot   || 0;
    const pointers = new Map();

    const update = () => {
      el.style.transform = `translate(${tx}px, ${ty}px) rotate(${rot}deg) scale(${scale})`;
      el.dataset.tx    = String(tx);
      el.dataset.ty    = String(ty);
      el.dataset.scale = String(scale);
      el.dataset.rot   = String(rot);
    };
    update();

    const getCenter = () => {
      const pts = Array.from(pointers.values());
      const x = pts.reduce((s,p)=>s+p.x,0) / pts.length;
      const y = pts.reduce((s,p)=>s+p.y,0) / pts.length;
      return {x,y};
    };
    const getDist = () => {
      const pts = Array.from(pointers.values());
      return Math.hypot(pts[1].x-pts[0].x, pts[1].y-pts[0].y);
    };
    const getAngle = () => {
      const pts = Array.from(pointers.values());
      return Math.atan2(pts[1].y-pts[0].y, pts[1].x-pts[0].x) * 180 / Math.PI;
    };

    let dragStart = { x:0, y:0 };
    let pinchStart = { dist:0, angle:0, center:{x:0,y:0}, scale:1, rot:0, tx:0, ty:0 };

    el.addEventListener('pointerdown', (e) => {
      if (e.target && e.target.classList && e.target.classList.contains('deco-del')) return;
      document.querySelectorAll('.deco-wrapper.active').forEach(w => w.classList.remove('active'));
      el.classList.add('active');

      el.setPointerCapture(e.pointerId);
      pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

      if (pointers.size === 1) {
        dragStart = { x: e.clientX - tx, y: e.clientY - ty };
      } else if (pointers.size === 2) {
        const center = pinchStart.center = getCenter();
        pinchStart.dist  = getDist();
        pinchStart.angle = getAngle();
        pinchStart.scale = scale;
        pinchStart.rot   = rot;
        pinchStart.tx    = tx;
        pinchStart.ty    = ty;
      }
    });

    el.addEventListener('pointermove', (e) => {
      if (!pointers.has(e.pointerId)) return;
      pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

      if (pointers.size === 1) {
        tx = e.clientX - dragStart.x;
        ty = e.clientY - dragStart.y;
      } else if (pointers.size === 2) {
        const newDist  = getDist();
        const newAngle = getAngle();
        const center   = getCenter();
        const s = Math.max(0.2, Math.min(5, pinchStart.scale * (newDist / Math.max(1, pinchStart.dist))));
        const r = pinchStart.rot + (newAngle - pinchStart.angle);
        tx = pinchStart.tx + (center.x - pinchStart.center.x);
        ty = pinchStart.ty + (center.y - pinchStart.center.y);
        scale = s;
        rot   = r;
      }
      update();
    }, { passive: true });

    const end = (e) => {
      pointers.delete(e.pointerId);
      if (pointers.size === 1) {
        const p = Array.from(pointers.values())[0];
        dragStart = { x: p.x - tx, y: p.y - ty };
      }
    };
    el.addEventListener('pointerup', end);
    el.addEventListener('pointercancel', end);
    el.addEventListener('lostpointercapture', end);

    el.addEventListener('wheel', (e) => {
      e.preventDefault();
      const factor = (e.deltaY < 0) ? 1.1 : 0.9;
      scale = Math.max(0.2, Math.min(5, scale * factor));
      update();
    }, { passive: false });

    el.addEventListener('dblclick', () => { rot = 0; update(); });
  }

  // æ–°è¦ãƒ‡ã‚³ç”Ÿæˆï¼ˆFile/Blob ã‚’ä¿æŒ â†’ ä¿å­˜æ™‚ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰
  function addDecoWithFile(stage, file){
    const url = URL.createObjectURL(file);
    const wrap = document.createElement('div');
    wrap.className = 'deco-wrapper';
    wrap.style.left = '100px';
    wrap.style.top  = '100px';
    wrap.dataset.tx = '0';
    wrap.dataset.ty = '0';
    wrap.dataset.scale = '1';
    wrap.dataset.rot = '0';
    wrap.dataset.mime = file.type || 'image/png';
    wrap.dataset.decoId = makeId();
    wrap.dataset.id = wrap.dataset.decoId; // å®‰å®šID
    wrap.__blob = file;

    const img = document.createElement('img');
    img.className = 'deco-img';
    img.src = url;
    img.alt = 'deco';

    const del = document.createElement('div');
    del.className = 'deco-del deco-delete-btn';
    del.textContent = 'Ã—';
    del.addEventListener('click', (ev) => {
      ev.stopPropagation();

      // ã™ã§ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãªã‚‰ Storage ãƒ‘ã‚¹ã‚’ä¿ç•™å‰Šé™¤ã¸
      const remoteUrl = wrap.dataset.remoteUrl;
      const p = remoteUrl ? pathFromUrl(remoteUrl) : null;
      if (p) __decoPendingDeletes.add(p);

      // è¡¨ç¤ºç”¨URLã‚’æƒé™¤
      try { URL.revokeObjectURL(url); } catch {}

      // DOM ã‹ã‚‰é™¤å»ï¼ˆä¿å­˜æ™‚ã« decos ã‹ã‚‰ã‚‚é™¤å¤–ã•ã‚Œã‚‹ï¼‰
      stage.removeChild(wrap);
    });

    wrap.appendChild(img);
    wrap.appendChild(del);
    stage.appendChild(wrap);

    makeTransformable(wrap);

    wrap.classList.add('active');
    setTimeout(() => wrap.classList.remove('active'), 600);
  }

  // ä¿å­˜æ¸ˆã¿ãƒ‡ã‚³ã‚’å¾©å…ƒï¼ˆURL ã‹ã‚‰ï¼‰
  function addDecoFromSaved(stage, item){
    const wrap = document.createElement('div');
    wrap.className = 'deco-wrapper';
    wrap.style.left = '100px';
    wrap.style.top  = '100px';
    wrap.dataset.tx = String(item.tx || 0);
    wrap.dataset.ty = String(item.ty || 0);
    wrap.dataset.scale = String(item.scale || 1);
    wrap.dataset.rot = String(item.rot || 0);
    wrap.dataset.mime = item.mime || 'image/png';
    wrap.dataset.remoteUrl = item.url || '';
    wrap.dataset.id = item.id || makeId();

    const img = document.createElement('img');
    img.className = 'deco-img';
    img.src = item.url;
    img.alt = 'deco';

    const del = document.createElement('div');
    del.className = 'deco-del deco-delete-btn';
    del.textContent = 'Ã—';
    del.addEventListener('click', (ev) => {
      ev.stopPropagation();

      // å¾©å…ƒã‚¢ã‚¤ãƒ†ãƒ ã¯ URL ã‹ã‚‰ Storage ãƒ‘ã‚¹ã‚’æŠ½å‡ºã—ã¦ä¿ç•™å‰Šé™¤ã¸
      const remoteUrl = wrap.dataset.remoteUrl || item.url;
      const p = remoteUrl ? pathFromUrl(remoteUrl) : null;
      if (p) __decoPendingDeletes.add(p);

      stage.removeChild(wrap);
    });

    wrap.appendChild(img);
    wrap.appendChild(del);
    stage.appendChild(wrap);

    makeTransformable(wrap);
  }

  // æœªã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãªã‚‰ Storage ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ URL ã‚’è¿”ã™
  async function ensureDecoUploaded(cardId, wrap){
    if (wrap.dataset.remoteUrl) return { url: wrap.dataset.remoteUrl, mime: wrap.dataset.mime || '' };

    const blob = wrap.__blob;
    if (!blob) return null;

    const mime = blob.type || wrap.dataset.mime || 'image/png';
    const ext  = extFromMime(mime);
    const decoId = wrap.dataset.id || makeId();
    const filePath = `decos/${cardId}/${decoId}.${ext}`;
    const fileRef  = ref(storage, filePath);

    await uploadBytes(fileRef, blob, {
      contentType: mime,
      cacheControl: 'public, max-age=31536000, immutable'
    });
    const url = await withRetry(() => getDownloadURL(fileRef));
    wrap.dataset.remoteUrl = url;

    // ãƒ­ãƒ¼ã‚«ãƒ«URLã®æƒé™¤
    try { URL.revokeObjectURL(wrap.querySelector('img')?.src || ''); } catch {}
    wrap.__blob = null;

    return { url, mime };
  }

  // ç”»é¢å†…ã®å…¨ãƒ‡ã‚³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼†ãƒ¡ã‚¿åŒ–
  async function serializeAndUploadDecos(cardId){
    const stage = document.getElementById(DECO_STAGE_ID);
    if (!stage) return [];
    const nodes = Array.from(stage.querySelectorAll('.deco-wrapper'));
    const out = [];
    for (const wrap of nodes) {
      if (!wrap.isConnected) continue;

      const uploaded = await ensureDecoUploaded(cardId, wrap);
      const url = uploaded?.url || wrap.dataset.remoteUrl;
      if (!url) continue;

      out.push({
        id: wrap.dataset.id || makeId(),
        url,
        mime: uploaded?.mime || wrap.dataset.mime || '',
        tx: +wrap.dataset.tx || 0,
        ty: +wrap.dataset.ty || 0,
        scale: +wrap.dataset.scale || 1,
        rot: +wrap.dataset.rot || 0
      });
    }
    return out;
  }

  // å¤–å´ã‚¿ãƒƒãƒ—ãƒ»Esc ã§é¸æŠè§£é™¤
  document.addEventListener('pointerdown', (e) => {
    if (!e.target.closest?.('.deco-wrapper')) {
      document.querySelectorAll('.deco-wrapper.active').forEach(w => w.classList.remove('active'));
    }
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.querySelectorAll('.deco-wrapper.active').forEach(w => w.classList.remove('active'));
    }
  });

  /***********************
   *  ğŸš€ Main
   ***********************/
  window.addEventListener('DOMContentLoaded', () => {
    L('DOM ready');

    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    L('params', { id });
    __currentId = id;

    const profileImg      = document.getElementById('profile-img');
    const profileInput    = document.getElementById('profile-input');
    const profileUrlInput = document.getElementById('profile-url');
    const bgInputs        = Array.from(document.querySelectorAll('#background-input'));
    const bgUrlInput      = document.getElementById('background-url');
    const backgroundEl    = document.body;

    const decoBtn   = document.getElementById('deco-photo-btn');
    const decoInput = document.getElementById('deco-photo-input');
    const stage     = document.getElementById(DECO_STAGE_ID);

    // ğŸ”½ è¿½åŠ : ãƒãƒ¼ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ–‡å­—ï¼‰
    const barInput   = document.getElementById('scroll-text-input');
    const barTextEl  = document.getElementById('scrolling-text');
    const BAR_DRAFT_KEY = `fureta_draft_bar_${__ID_FOR_DRAFT}`;
    const readBarDraft  = () => localStorage.getItem(BAR_DRAFT_KEY) ?? '';
    const writeBarDraft = (v) => localStorage.setItem(BAR_DRAFT_KEY, v ?? '');

    // ğŸ”½ è¿½åŠ : ãƒãƒ¼è‰²ã®ãƒ‰ãƒ©ãƒ•ãƒˆã‚­ãƒ¼ï¼†é–¢æ•°
    const BAR_COLOR_DRAFT_KEY = `fureta_draft_barColor_${__ID_FOR_DRAFT}`;
    const readBarColorDraft  = () => localStorage.getItem(BAR_COLOR_DRAFT_KEY) ?? '';
    const writeBarColorDraft = (v) => localStorage.setItem(BAR_COLOR_DRAFT_KEY, v ?? '');

    function applyBarColor(value){
      const v = (value || '').trim();
      if (!v) return;
      document.documentElement.style.setProperty('--bar-color', v);
      const picker = document.getElementById('bar-color-picker') || document.getElementById('color-picker'); // â† ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      if (picker && picker.value !== v) {
        try { picker.value = v; } catch(_) {}
      }
    }
    async function saveBarColor(value){
      const v = (value || '').trim();
      if (__currentId) {
        try{
          await setDoc(doc(db, 'cards', __currentId), { barColor: v }, { merge: true });
          L('barColor.autosave', { v });
        }catch(e){
          W('barColor.autosave.fail', e);
        }
      } else {
        writeBarColorDraft(v);
        L('barColor.draft.save', { v });
      }
      applyBarColor(v);
    }

    function updateBarUI(val){
      const v = (val ?? '').trim();
      if (barTextEl) {
        barTextEl.textContent = v;
        barTextEl.style.display = v ? 'inline-block' : 'none';
      }
      if (barInput) {
        barInput.value = v;
        barInput.style.display = v ? 'none' : 'block'; // å…¥åŠ›â†’è¡¨ç¤ºã®æ—¢å­˜æŒ™å‹•ã‚’è¸è¥²
        if (!v) { barInput.placeholder = ''; } // â˜… è¿½åŠ ï¼šæœªå…¥åŠ›æ™‚ã¯ placeholder æ–‡å­—ã ã‘æ¶ˆã™
      }
    }
    async function saveBar(val){
      const v = (val ?? '').trim();
      if (__currentId) {
        try{
          await setDoc(doc(db, 'cards', __currentId), { barText: v }, { merge: true });
          L('bar.autosave', { v });
        }catch(e){
          W('bar.autosave.fail', e);
        }
      } else {
        writeBarDraft(v);
        L('bar.draft.save', { v });
      }
      updateBarUI(v);
    }

    if (barInput){
      barInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveBar(barInput.value);
        }
      });
      barInput.addEventListener('blur', () => {
        saveBar(barInput.value);
      });
    }
    if (barTextEl){
      // è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¿ãƒƒãƒ—ã§å†ç·¨é›†ï¼ˆæ—¢å­˜ã®æŒ™å‹•ã¨åŒã˜ä½“é¨“ï¼‰
      barTextEl.addEventListener('click', () => {
        if (barInput){
          barInput.style.display = 'block';
          barTextEl.style.display = 'none';
          barInput.focus();
        }
      });
    }

    // ğŸ”½ è¿½åŠ : ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ï¼ˆbar-color-picker ãŒç„¡ã‘ã‚Œã° color-picker ã‚’ä½¿ã†ï¼‰
    const barColorPicker = document.getElementById('bar-color-picker') || document.getElementById('color-picker');
    if (barColorPicker){
      // ç¾åœ¨ã®CSSå¤‰æ•°ã‚’ãƒ”ãƒƒã‚«ãƒ¼ã«åŒæœŸ
      const currentCss = getComputedStyle(document.documentElement).getPropertyValue('--bar-color').trim();
      if (currentCss) {
        try { barColorPicker.value = currentCss; } catch(_) {}
      }
      barColorPicker.addEventListener('input', (e) => saveBarColor(e.target.value));
      barColorPicker.addEventListener('change', (e) => saveBarColor(e.target.value));
    }

    L('dom.refs', {
      hasProfileImg: !!profileImg,
      hasProfileInput: !!profileInput,
      hasBgInputCount: bgInputs.length,
      hasDecoBtn: !!decoBtn,
      hasDecoInput: !!decoInput,
      hasStage: !!stage
    });

    hookImgDebug(profileImg, 'PROFILE');

    let backgroundURL = '';
    let uploadingBg = false;

    window.setBackground = async function(url) {
      try {
        L('bg.theme.click', { url });
        await setBackgroundImageForce(backgroundEl, url);
        backgroundURL = url;
        if (bgUrlInput) bgUrlInput.value = url;

        if (typeof db !== 'undefined' && typeof id !== 'undefined' && id) {
          await setDoc(doc(db, "cards", id), { backgroundUrl: url }, { merge: true });
          L('bg.theme.saved', { id, url });
        }
      } catch (e) {
        E('bg.theme.fail', e);
        alert('èƒŒæ™¯ã®é©ç”¨ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    };

    profileInput?.addEventListener('click', () => { profileInput.value = ""; });

    // ---- å†ç·¨é›†ãƒ­ãƒ¼ãƒ‰
    (async () => {
      if (!id) {
        L('edit.skip.noId');
        // ğŸ”½ IDãŒãªã„ï¼ãƒ‰ãƒ©ãƒ•ãƒˆæ™‚ï¼šãƒãƒ¼ã¯ãƒ‰ãƒ©ãƒ•ãƒˆã‚’è¡¨ç¤ºã€ãªã‘ã‚Œã°è¡¨ç¤ºã‚’æ¶ˆã™
        const draftBar = readBarDraft();
        if (draftBar) updateBarUI(draftBar); else updateBarUI('');
        // ğŸ”½ è¿½åŠ ï¼šãƒãƒ¼è‰²ã®ãƒ‰ãƒ©ãƒ•ãƒˆé©ç”¨
        const draftColor = readBarColorDraft();
        if (draftColor) applyBarColor(draftColor);
        return;
      }
      L('edit.load', { id });
      try {
        const snap = await getDoc(doc(db, 'cards', id));
        if (!snap.exists()) { alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'); W('edit.noDoc', id); return; }
        const data = snap.data();
        L('edit.data', data);

        const setVal = (i, v) => { const el = document.getElementById(i); if (el) el.value = v || ''; };
        const fieldMap = {
          name: 'name',
          birthday: 'birthday',
          age: 'age',
          department: 'department',
          birthplace: 'birthplace',
          hobby: 'hobby',
          'self-pr-textarea': 'selfPr',
          'extra-text': 'extraText',
        };
        Object.entries(fieldMap).forEach(([idKey, dataKey]) => setVal(idKey, data[dataKey]));

        // ğŸ”½ ãƒãƒ¼æ–‡å­—ï¼šFirebaseã«ã‚ã‚Œã°è¡¨ç¤ºã€ãªã‘ã‚Œã°ãƒãƒ¼è¡¨ç¤ºã ã‘æ¶ˆã™
        if (typeof data.barText === 'string' && data.barText.trim() !== '') {
          updateBarUI(data.barText);
        } else {
          updateBarUI(''); // â† æœªä¿å­˜ãªã‚‰è¡¨ç¤ºã ã‘æ¶ˆã™
        }
        // ğŸ”½ è¿½åŠ ï¼šãƒãƒ¼è‰²ã®å¾©å…ƒï¼ˆFirestoreå„ªå…ˆ â†’ ãƒ‰ãƒ©ãƒ•ãƒˆï¼‰
        if (typeof data.barColor === 'string' && data.barColor.trim() !== '') {
          applyBarColor(data.barColor);
        } else {
          const draftColor = readBarColorDraft();
          if (draftColor) applyBarColor(draftColor);
        }

        SNS_KEYS.forEach(key => {
          if (data[key]) {
            snsLinks[key] = data[key];
            const el = document.getElementById(`input-${key}`);
            if (el) el.value = data[key];
          }
        });

        const links = id ? (data?.links || null) : readLinksDraft();
        if (links?.youtube?.embedUrl){
          const y = document.getElementById('youtube-url'); if (y) y.value = links.youtube.rawUrl || "";
          renderYouTube(links.youtube.embedUrl);
        }
        if (links?.spotify?.embedUrl){
          const s = document.getElementById('spotify-url'); if (s) s.value = links.spotify.rawUrl || "";
          renderSpotify(links.spotify.embedUrl);
        }
        if (links) localStorage.setItem(LINKS_DRAFT_KEY, JSON.stringify(links));

        if (data.imageUrl && profileImg) {
          try { await setImgSrc(profileImg, data.imageUrl); }
          catch (e) { W('edit.profile.setSrc.fail', e); profileImg.src = bust(data.imageUrl); }
          __pfCurrentURL = data.imageUrl;
          if (profileUrlInput) profileUrlInput.value = data.imageUrl;
        }
        if (data.backgroundUrl) {
          try { await setBackgroundImageForce(backgroundEl, data.backgroundUrl); }
          catch (e) { W('edit.bg.set.fail', e); backgroundEl.style.backgroundImage = `url('${bust(data.backgroundUrl)}')`; }
          backgroundURL = data.backgroundUrl;
          if (bgUrlInput) bgUrlInput.value = data.backgroundUrl;
        }

        // â˜… ãƒ‡ã‚³å¾©å…ƒ
        if (Array.isArray(data.decos) && stage) {
          data.decos.forEach(item => addDecoFromSaved(stage, item));
        }
      } catch (e) { E('edit.load.fail', e); }
    })();

    // ---- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ
    profileInput?.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      L('profile.change(DIRECT)', { hasFile: !!file, uploading: __pfUploading });
      await handleProfileFile(file, { id, profileImg, profileUrlInput });
      e.target.value = '';
    });

    (function installProfileFallback(){
      const input = profileInput;
      const img   = profileImg;
      let lastName = '', lastSize = 0;

      async function tryPick(reason){
        const f = input?.files?.[0];
        if (!f) return;
        if (f.name === lastName && f.size === lastSize) return;
        lastName = f.name; lastSize = f.size;
        L('profile.fallback.detect', { reason, name: f.name, size: f.size });
        await handleProfileFile(f, { id, profileImg: img, profileUrlInput });
        if (input) input.value = '';
      }

      window.addEventListener('focus', () => tryPick('focus'), true);
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') tryPick('visibility');
      }, true);
      window.addEventListener('pageshow', () => tryPick('pageshow'), true);

      img?.addEventListener('click', () => {
        let n = 0;
        const t = setInterval(() => { n++; tryPick('poll'); if (n >= 5) clearInterval(t); }, 500);
      });
    })();

    // ---- èƒŒæ™¯ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    bgInputs.forEach((bgInput, idx) => {
      bgInput?.addEventListener('click', () => { bgInput.value = ""; });
      bgInput?.addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        L('bg.change', { idx, hasFile: !!file, uploadingBg });
        if (!file || uploadingBg) return;
        uploadingBg = true;

        const oldURL = backgroundURL;
        try {
          L('bg.file', { name: file.name, type: file.type, size: file.size });
          const newPath = `backgrounds/${makeId()}`;
          const fileRef = ref(storage, newPath);
          L('bg.path', fileRef.fullPath);

          const jpegBlob = await forceJpegBlob(file);
          L('bg.jpegBlob', { size: jpegBlob.size });

          await uploadBytes(fileRef, jpegBlob, {
            contentType: 'image/jpeg',
            cacheControl: 'no-store, no-cache, must-revalidate, max-age=0'
          });
          L('bg.upload.OK');

          const url = await withRetry(() => getDownloadURL(fileRef));
          L('bg.url', url);

          await setBackgroundImageForce(backgroundEl, url);
          L('bg.set.done');

          backgroundURL = url;
          bgUrlInput && (bgUrlInput.value = url);

          if (id) {
            await setDoc(doc(db, "cards", id), { backgroundUrl: url }, { merge: true });
            L('bg.firestore.merge.OK');
          }

          if (oldURL) {
            try {
              const oldPath = pathFromUrl(oldURL);
              if (oldPath) { await deleteObject(ref(storage, oldPath)); L('bg.old.delete.OK'); }
            } catch (err) { W('bg.old.delete.FAIL', err); }
          }
        } catch (err) {
          E('bg.FAIL', err);
          alert('èƒŒæ™¯ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        } finally {
          uploadingBg = false;
          e.target.value = '';
          L('bg.done');
        }
      });
    });

    // ---- ãƒ‡ã‚³ï¼šè¿½åŠ ãƒœã‚¿ãƒ³/å…¥åŠ›
    if (decoBtn && decoInput && stage) {
      decoBtn.addEventListener('click', () => {
        if (stage.querySelectorAll('.deco-wrapper').length >= MAX_DECO) {
          alert(`ãƒ‡ã‚³å†™çœŸã¯æœ€å¤§ ${MAX_DECO} æšã¾ã§ã§ã™`);
          return;
        }
        decoInput.value = '';
        if (decoInput.showPicker) decoInput.showPicker(); else decoInput.click();
      });
      decoInput.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        if (stage.querySelectorAll('.deco-wrapper').length >= MAX_DECO) {
          alert(`ãƒ‡ã‚³å†™çœŸã¯æœ€å¤§ ${MAX_DECO} æšã¾ã§ã§ã™`);
          return;
        }
        // é€éPNGã¯ãã®ã¾ã¾ã€JPEGã‚‚ãã®ã¾ã¾ä¿å­˜
        addDecoWithFile(stage, file);
      });
    }

    // ---- ä¿å­˜
    document.getElementById('finish-button')?.addEventListener('click', () => {
      L('finish.click');
      const checkbox = document.getElementById('agree-checkbox');
      if (checkbox?.checked) {
        document.getElementById('terms-modal')?.style && (document.getElementById('terms-modal').style.display = 'none');
        saveAndRedirect();
      } else {
        document.getElementById('terms-notice')?.style && (document.getElementById('terms-notice').style.display = 'flex');
      }
    });
    document.getElementById('notice-agree-btn')?.addEventListener('click', () => {
      L('notice.agree');
      document.getElementById('terms-notice').style.display = 'none';
      document.getElementById('terms-modal').style.display = 'flex';
    });
    document.getElementById('notice-close-btn')?.addEventListener('click', () => {
      L('notice.close');
      document.getElementById('terms-notice').style.display = 'none';
    });

    async function saveAndRedirect() {
      L('save.start');
      const finalProfileURL   = __pfCurrentURL || profileUrlInput?.value;
      const finalBackgroundURL= backgroundURL || bgUrlInput?.value;
      L('save.check', { finalProfileURL, finalBackgroundURL });

      if (!finalProfileURL || !finalBackgroundURL) {
        alert('ç”»åƒãŒã¾ã ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼');
        W('save.block', { finalProfileURL, finalBackgroundURL });
        return;
      }

      const targetId = id || (globalThis.crypto?.randomUUID?.() ?? makeId());
      const getVal = (i) => document.getElementById(i)?.value || "";

      const linksDraft = readLinksDraft();

      // â˜… ãƒ‡ã‚³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦é…åˆ—åŒ–
      const decos = await serializeAndUploadDecos(targetId);

      // â˜… è¿½åŠ ï¼šç¾åœ¨ã®ãƒãƒ¼è‰²ã‚’CSSå¤‰æ•°ã‹ã‚‰å–å¾—
      const barColorNow = getComputedStyle(document.documentElement).getPropertyValue('--bar-color').trim();

      const data = {
        name: getVal("name"),
        birthday: getVal("birthday"),
        age: getVal("age"),
        department: getVal("department"),
        birthplace: getVal("birthplace"),
        hobby: getVal("hobby"),
        selfPr: getVal("self-pr-textarea"),
        extraText: getVal("extra-text"),
        imageUrl: finalProfileURL,
        backgroundUrl: finalBackgroundURL,
        barText: (document.getElementById('scroll-text-input')?.value || '').trim(), // ğŸ”½ è¿½åŠ ï¼šæœ€çµ‚ä¿å­˜ã«ã‚‚å«ã‚ã‚‹
        barColor: barColorNow, // ğŸ”½ è¿½åŠ ï¼šãƒãƒ¼è‰²ã‚‚ä¿å­˜
        ...snsLinks,
        ...(linksDraft ? { links: linksDraft } : {}),
        ...(decos.length ? { decos } : {})
      };

      try {
        L('save.firestore.start', { targetId, data });
        await setDoc(doc(db, "cards", targetId), data, { merge: true });
        L('save.firestore.OK');

        // â˜… Firestore åæ˜ OK â†’ ä¿ç•™ã—ã¦ã„ãŸ Storage ã‚’å®Ÿå‰Šé™¤
        try {
          if (__decoPendingDeletes.size) {
            const tasks = [...__decoPendingDeletes].map(p =>
              deleteObject(ref(storage, p))
                .then(() => L('deco.storage.delete.OK', p))
                .catch(err => W('deco.storage.delete.FAIL', p, err))
            );
            await Promise.allSettled(tasks);
            __decoPendingDeletes.clear();
          }
        } catch (err) {
          W('deco.storage.delete.batch.FAIL', err);
        }

        // â˜… ä¿å­˜æˆåŠŸå¾Œã€ã“ã®ä½œæ¥­ã®ãƒ‰ãƒ©ãƒ•ãƒˆã ã‘æƒé™¤
        localStorage.removeItem(LINKS_DRAFT_KEY);
        localStorage.removeItem(BAR_DRAFT_KEY); // ğŸ”½ ãƒãƒ¼ãƒ‰ãƒ©ãƒ•ãƒˆã‚‚æƒé™¤
        localStorage.removeItem(BAR_COLOR_DRAFT_KEY); // ğŸ”½ è¿½åŠ ï¼šãƒãƒ¼è‰²ãƒ‰ãƒ©ãƒ•ãƒˆã‚‚æƒé™¤

        const next = `/preview?id=${targetId}`;
        L('save.redirect', next);
        window.location.href = next;
      } catch (e) {
        E('save.firestore.FAIL', e);
        alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
      }
    }

    // â˜… edit=1 ã®ã¨ãç·¨é›†UIå¾©å…ƒ
    if (isEditMode()) enableEditMode();
  });

/* ====== å®Œæˆ/ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ç·¨é›†UIã‚’éš ã™ï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã§æ®‹ã™ï¼‰ ====== */
window.addEventListener('DOMContentLoaded', () => {
  const isView = isViewPage();
  if (!isView || isEditMode()) return;

  const HIDE_SELECTORS = [
    '.toolbar',
    '.text-style-toolbar',
    '.sns-delete-btn',
    '.deco-delete-btn',
    '.text-stamp-delete-btn',
    '.youtube-section button',
    '#spotify-section button',
    '#youtube-url',
    '#spotify-url',
    '#sns-explain',
    '#extra-text-wrapper .sns-delete-btn',
    '#diagnosis-wrapper .sns-delete-btn',
    '#external-link-section .sns-delete-btn',
    '#self-pr-section .sns-delete-btn',
    '#spotify-section .sns-delete-btn',
    '#pr-template-buttons',
    '.deletable-templates',
    '.self-pr-template-section'
  ];
  document.querySelectorAll(HIDE_SELECTORS.join(',')).forEach(el => {
    try { el.style.display = 'none'; } catch {}
  });

  const FORCE_SHOW = [
    '#diagnosis-wrapper',
    '#diagnosis-wrapper #diagnosis-button',
    '#self-pr-section',
    '#self-pr-section button[onclick="analyzeSelfPR()"]',
    '#qna-area',   // è³ªå•ã‚³ãƒ¼ãƒŠãƒ¼ã®ãƒœã‚¿ãƒ³æ 
    '#qna-open'    // è³ªå•ã‚³ãƒ¼ãƒŠãƒ¼ãƒœã‚¿ãƒ³
  ];

  FORCE_SHOW.forEach(sel => {
    const el = document.querySelector(sel);
    if (!el) return;

    if (sel === '#qna-modal') {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯åˆæœŸçŠ¶æ…‹ã¯é–‰ã˜ãŸã¾ã¾
      el.style.display = 'none';
    } else {
      el.style.display = 'block';
    }
  });

  const diagWrap = document.getElementById('diagnosis-wrapper');
  const diagBtn  = document.getElementById('diagnosis-button');
  if (diagWrap) {
    diagWrap.style.textAlign = 'center';
  }
  if (diagBtn) {
    diagBtn.style.display = 'inline-block';
    diagBtn.style.margin  = '12px auto';
    diagBtn.style.position = 'relative';
    diagBtn.style.left = '';
    diagBtn.style.right = '';
    diagBtn.style.transform = 'none';
  }

  // â˜… è³ªå•ã‚³ãƒ¼ãƒŠãƒ¼ãƒœã‚¿ãƒ³ã‚’ä¸­å¤®ã«å¯„ã›ã‚‹
  const qBtn = document.getElementById('qna-open');
  if (qBtn) {
    qBtn.style.display   = 'block';
    qBtn.style.margin    = '12px auto';
    qBtn.style.position  = 'relative';
    qBtn.style.left      = '0';
    qBtn.style.right     = '0';
    qBtn.style.transform = 'none';
  }

  const editToggle = document.getElementById('edit-toggle');
  if (editToggle) editToggle.style.display = 'none';
  const returnToggle = document.getElementById('return-toggle');
  if (returnToggle) returnToggle.style.display = 'none';
});


  // â˜… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã«å³ä¸‹ã¸ã€Œå†ç·¨é›†ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
  window.addEventListener('DOMContentLoaded', () => {
    if (!isViewPage() || isEditMode()) return;

    const btn = document.createElement('button');
    btn.id = 'reedit-button';
    btn.type = 'button';
    btn.textContent = 'å†ç·¨é›†';
    Object.assign(btn.style, {
      position: 'fixed',
      right: '16px',
      bottom: '16px',
      zIndex: 10001,
      padding: '10px 16px',
      border: 'none',
      borderRadius: '9999px',
      background: '#ffd966',
      boxShadow: '0 6px 16px rgba(0,0,0,0.2)',
      fontSize: '14px',
      fontWeight: 'bold',
      cursor: 'pointer'
    });
    btn.addEventListener('click', () => gotoEditMode());
    document.body.appendChild(btn);
  });
</script>

<script>
(function(){
  const nameInput = document.getElementById('name');
  if (!nameInput) return;

  function pulseName(){
    nameInput.classList.remove('glow-once');
    void nameInput.offsetWidth;
    nameInput.classList.add('glow-once');
    setTimeout(()=> nameInput.classList.remove('glow-once'), 4000);
  }

  window.addEventListener('load', () => {
    if ((nameInput.value || '').trim() === '') pulseName();
  });

  ['focus','input'].forEach(ev => {
    nameInput.addEventListener(ev, () => {
      nameInput.classList.remove('glow-once');
    });
  });

  window.pulseName = pulseName;
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const QUESTIONS = [
  "å°å­¦æ ¡ã®é ƒã«ãƒãƒã£ã¦ã„ãŸ<br>ã€Œå¤‰ãªéŠã³ã€ã£ã¦ã‚ã£ãŸï¼Ÿ",
  "ãƒ©ãƒ³ãƒ‰ã‚»ãƒ«ã®è‰²ã¯ä½•è‰²ã ã£ãŸï¼Ÿ",
  "å¥½ãã ã£ãŸçµ¦é£Ÿãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ï¼Ÿ",
  "ã‚¹ãƒãƒ›ã§åˆã‚ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸæ›²ã¯ï¼Ÿ",
  "è·å ´ã‚„å­¦æ ¡ã§<br>ã€Œãªãœã‹è‡ªåˆ†ã ã‘ã‚„ã£ã¦ã‚‹è¬ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã€ã‚ã‚‹ï¼Ÿ",
  "ä»Šã¾ã§ã§ä¸€ç•ªâ€œå¤‰ãªå ´æ‰€â€ã§å¯ãŸçµŒé¨“ã¯ï¼Ÿ",
  "å­¦æ ¡ã§æµè¡Œã£ã¦ãŸã‘ã©ä»Šæ€ãˆã°è¬ã™ãã‚‹ãƒ–ãƒ¼ãƒ ã¯ï¼Ÿ",
  "äººã«è¨€ã†ã¨ã€Œãˆã£ï¼Ÿã€ã£ã¦ãªã‚‹ã‘ã©ã€<br>è‡ªåˆ†ã ã‘ã®ãƒã‚¤ãƒ«ãƒ¼ãƒ«ã¯ï¼Ÿ",
  "ç©¶æ¥µã®2æŠï¼š<br>ä¸€ç”Ÿãƒ‘ãƒ³ç¦æ­¢ vs ä¸€ç”Ÿã”é£¯ç¦æ­¢ã€ã©ã£ã¡é¸ã¶ï¼Ÿ",
  "ã‚‚ã—1æ—¥ã ã‘æ˜”ã®å­¦æ ¡ç”Ÿæ´»ã«æˆ»ã‚Œã‚‹ãªã‚‰ã€<br>ä½•ã‚’ã‚„ã‚ŠãŸã„ï¼Ÿ"
];

  const $open   = document.getElementById('qna-open');
  const $modal  = document.getElementById('qna-modal');
  const $closeX = document.getElementById('qna-close');
  const $next   = document.getElementById('qna-next');
  const $hide   = document.getElementById('qna-hide');
  const $q      = document.getElementById('qna-question');

  if (!($open && $modal && $q)) return;

  let last = -1;
  const pick = () => {
    let i = Math.floor(Math.random() * QUESTIONS.length);
    if (QUESTIONS.length > 1 && i === last) i = (i + 1) % QUESTIONS.length;
    last = i;
    return QUESTIONS[i];
  };

  // é–‹ã
   $open.addEventListener('click', () => {
  $q.innerHTML = pick();              // â† ã“ã“ã‚’ innerHTML ã«
    $modal.style.display = 'flex';
  });

  $next.addEventListener('click', () => { $q.innerHTML = pick(); }); // â† ã“ã“ã‚‚
  // é–‰ã˜ã‚‹
  const hide = () => { $modal.style.display = 'none'; };
  $hide.addEventListener('click', hide);
  $closeX.addEventListener('click', hide);
  $modal.addEventListener('click', (e) => { if (e.target === $modal) hide(); });
});
</script>
<script>
  (function(){
    const btn = document.getElementById('box-toggle');
    if (!btn) return;
    btn.addEventListener('click', () => {
      document.body.classList.toggle('background-only');
    });
  })();
</script>

</body>
</html>
